---
title: "model_selection"
author: "Eren Kafadar"
date: "2024-11-26"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Main Setup
```{r setup, include=FALSE}
diagnostics <- TRUE
generate <- FALSE
save_fits <- TRUE
save_best_models <- TRUE
plot <- FALSE
code_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/longitudinal-models-abcd/"
fits_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/3.0_results/"
data_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/update/"
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(ggplot2)
library(gamlss)
require(gamlss.ggplots)
library(tidyr)
library(gamlssTools)
library(gridExtra)
library(ggseg)
library(purrr)

source(paste0(code_path, "inspect_model_fits.R"))
source(paste0(code_path, "generate_gamlss_model_fct.R"))
source(paste0(code_path, "load_data_fct.R"))

source(paste0(code_path, "pred_og_centile_EK.R"))
source(paste0(code_path, "wp_taki_EK.R"))

vol_vars <- read.csv("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/vol_vars.csv")[,2]
sa_vars <- read.csv("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/sa_vars.csv")[,2]
th_vars <- read.csv("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/th_vars.csv")[,2]

pull <- function(data, var) {
  if (var %in% names(data)) data[[var]] else NA
}
```

#Generate Models
```{r}
if (generate == TRUE){
family_set <- c("BCT")
phenotype_set <- th_vars
out_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_models_t1_BCT_sa/"
if (!dir.exists(out_folder)) dir.create(out_folder)

terms_mu = c("~1", "age", "sex", "random(site)")
terms_sigma = c("~1", "age", "sex")
terms_nu = c("~1", "age", "sex")
terms_tau = c("~1")

generate_gamlss_models(phenotype_set, 
                                   out_folder, 
                                   family_set = family_set,
                                   mu_terms = terms_mu,
                                   sigma_terms = terms_sigma,
                                   nu_terms = terms_nu,
                                   tau_terms = terms_tau,
                                   n_crit = 200)
}
```
##Generate additional models with age:sex interaction term
```{r}
if (generate == TRUE){
  models_folder <- out_folder
  models <- list.files(models_folder, full.names = TRUE)
  ind <- stringr::str_extract(basename(models), "\\d+")
  end_ind <- max(as.numeric(ind))
  ind_new <- end_ind
  for(model_name in models){
    model <- readRDS(model_name)
    if(grepl("age", deparse(model$mu.formula)) & grepl("sex", deparse(model$mu.formula))){
  model_new <- model
  model_new$mu.formula <- as.formula(paste0(deparse(model$mu.formula), " + age:sex"))
  ind_new = ind_new + 1
  filename <- paste0(paste("gamlss_model", ind_new, model_new$fam, model_new$phenotype, sep = "_"), ".rds")
  saveRDS(model_new, file = paste0(models_folder,filename))
    }
  }
} 
```

##Commands to fit the models
Run fits submitting an array job.
split 1
sbatch array_script_submit.sh submit_gamlss_fits_ABCD_ONE.sh /mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_models_t1_BCT_sa "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_models_t1_BCT_sa/" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/update/abcd_long_Onetrain2025-09-26.csv" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_fits_t1_BCT_sa_splitONE/" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_fits_t1_BCT_sa_splitONE/gamlss_fits_stats" "t1"

split 2
sbatch array_script_submit.sh submit_gamlss_fits_ABCD_TWO.sh /mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_models_t1_BCT_sa "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_models_t1_BCT_sa/" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/update/abcd_long_Onetrain2025-09-26.csv" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_fits_t1_BCT_sa_splitTWO/" "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/additional_results/gamlss_fits_t1_BCT_sa_splitTWO/gamlss_fits_stats" "t1"
#Data Setup
##Define files
```{r}
#file paths
splitOne_folder <- paste0(fits_path, "gamlss_fits_t1_BCT_vol_splitONE_2.0/")
splitTwo_folder <- paste0(fits_path, "gamlss_fits_t1_BCT_vol_splitTWO_2.0/")

sOne_fits_stats_filename <- paste0(splitOne_folder, "gamlss_fits_stats_all.csv")
sTwo_fits_stats_filename <- paste0(splitTwo_folder, "gamlss_fits_stats_all.csv")
splitOne_train_filename <- paste0(data_path, "abcd_long_Onetrain2025-09-26.csv")
splitTwo_train_filename <- paste0(data_path, "abcd_long_Twotrain2025-09-26.csv")
splitOne_test_filename <- paste0(data_path, "abcd_long_Onetest2025-09-26.csv")
splitTwo_test_filename <- paste0(data_path, "abcd_long_Twotest2025-09-26.csv")
```
##Load data frames and clean them up
```{r}
#rename variables and select t1 scans
rename_vec <- c(age = "interview_age", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

sOne_train_df <- read.csv(splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
sOne_train_df$sex <- as.factor(sOne_train_df$sex)
sOne_train_df$site <- as.factor(sOne_train_df$site)
sOne_train_df$age <- as.numeric(sOne_train_df$age)

sTwo_train_df <- read.csv(splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
sTwo_train_df$sex <- as.factor(sTwo_train_df$sex)
sTwo_train_df$site <- as.factor(sTwo_train_df$site)
sTwo_train_df$age <- as.numeric(sTwo_train_df$age)

sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
sOne_test_df$sex <- as.factor(sOne_test_df$sex)
sOne_test_df$site <- as.factor(sOne_test_df$site)
sOne_test_df$age <- as.numeric(sOne_test_df$age)

sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
sTwo_test_df$sex <- as.factor(sTwo_test_df$sex)
sTwo_test_df$site <- as.factor(sTwo_test_df$site)
sTwo_test_df$age <- as.numeric(sTwo_test_df$age)
```
#Fits
##load all fits, process, and save
```{r}
all_fits_filename <- paste0(fits_path, "t1_BCT_fits.csv")
if(save_fits == TRUE){
sOne_fits <- inspect_model_fits(splitOne_folder, sOne_fits_stats_filename)
sOne_fits$label <- name_mapping$region_name[match(sOne_fits$phenotype, name_mapping$abbreviation)]
sTwo_fits <- inspect_model_fits(splitTwo_folder, sTwo_fits_stats_filename)
sTwo_fits$label <- name_mapping$region_name[match(sTwo_fits$phenotype, name_mapping$abbreviation)]


sOne_fits$split_no <- rep("1", dim(sOne_fits)[1])
sTwo_fits$split_no <- rep("2", dim(sTwo_fits)[1])

all_fits <- rbind(sOne_fits, sTwo_fits)

write.csv(all_fits, all_fits_filename)
}
```
##inspect errors
```{r}
#load saved fits if saved.
if(save_fits == FALSE) {
  all_fits <- read.csv(all_fits_filename) %>% select(-1)
  sOne_fits <- all_fits %>% filter(split_no == 1)
  sTwo_fits <- all_fits %>% filter(split_no == 2)
}
#split One fits
 sOne_fits %>% filter(error == 1) %>% select(error_text)
#distribution of errors among phenotypes
table(sOne_fits %>% filter(error == 1) %>% select(phenotype))

#distribution of errors among model terms
table(sOne_fits %>% filter(error == 1) %>% select(mu_formula))
table(sOne_fits %>% filter(error == 1) %>% select(sigma_formula))
table(sOne_fits %>% filter(error == 1) %>% select(nu_formula))

#split Two fits
 sTwo_fits %>% filter(error == 1) %>% select(error_text)
 
#distribution of errors among phenotypes
table(sTwo_fits %>% filter(error == 1) %>% select(phenotype))

#distribution of errors among model terms
table(sTwo_fits %>% filter(error == 1) %>% select(mu_formula))
table(sTwo_fits %>% filter(error == 1) %>% select(sigma_formula))
table(sTwo_fits %>% filter(error == 1) %>% select(nu_formula))
 
```
##inspect convergence
```{r}
#split One fits
sum(sOne_fits$convergence_warn_end == 1)
#split Two fits
sum(sTwo_fits$convergence_warn_end == 1)
```
##load saved fits and get the models with the lowest BIC within each phenotype
```{r}
#load saved fits if saved previously
if(save_fits == FALSE) {
  all_fits <- read.csv(all_fits_filename) %>% select(-1)
  sOne_fits <- all_fits %>% filter(split_no == 1)
  sTwo_fits <- all_fits %>% filter(split_no == 2)
}

sOne_best <- sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

sTwo_best <- sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)
```

#Inspect Best Models - by BIC
##get table of which vars are chosen for which phenotype & which moment
```{r}
#terms
terms_all = c("age", "sex")
moments = c("mu", "sigma", "nu")
colnames = apply(expand.grid(terms_all, moments), 1, paste, collapse=".")

#sOne
sOne_best_terms <- as.data.frame(matrix(nrow = dim(sOne_best)[1], ncol=length(colnames)))
names(sOne_best_terms) <- colnames
rownames(sOne_best_terms) <- sOne_best$phenotype
  for(i in 1:length(terms_all)) {
      sOne_best_terms[,(i)] <- grepl(terms_all[i], sOne_best$mu_formula)
      sOne_best_terms[,(i+length(terms_all))] <- grepl(terms_all[i], sOne_best$sigma_formula)
      sOne_best_terms[,(i+length(terms_all))] <- grepl(terms_all[i], sOne_best$sigma_formula)
      sOne_best_terms[,(i+2*length(terms_all))] <- grepl(terms_all[i], sOne_best$nu_formula)
  }

sOne_best_terms$label <- name_mapping$region_name[match(rownames(sOne_best_terms), name_mapping$abbreviation)]

#sTwo
sTwo_best_terms <- as.data.frame(matrix(nrow = dim(sTwo_best)[1], ncol=length(colnames)))
names(sTwo_best_terms) <- colnames
rownames(sTwo_best_terms) <- sTwo_best$phenotype
  for(i in 1:length(terms_all)) {
      sTwo_best_terms[,(i)] <- grepl(terms_all[i], sTwo_best$mu_formula)
      sTwo_best_terms[,(i+length(terms_all))] <- grepl(terms_all[i], sTwo_best$sigma_formula)
      sTwo_best_terms[,(i+2*length(terms_all))] <- grepl(terms_all[i], sTwo_best$nu_formula)
  }

sTwo_best_terms$label <- name_mapping$region_name[match(rownames(sTwo_best_terms), name_mapping$abbreviation)]
```
##Check interaction term
```{r}
sum(grepl("age:sex", sOne_best$mu_formula)) #0

sum(grepl("age:sex", sTwo_best$mu_formula)) #0
#(grep("age:sex", sTwo_best$mu_formula))
```
##inspect distribution of terms in "BEST" models
###sOne
```{r}
#sOne
sum(sOne_best_terms$age.mu)
sum(sOne_best_terms$sex.mu)
sum(sOne_best_terms$age.sigma)
sum(sOne_best_terms$sex.sigma)
sum(sOne_best_terms$age.nu)
sum(sOne_best_terms$sex.nu)

#visualize regions based on terms in the model
##merge with atlas data
plot_data_dkt <- merge(sOne_best_terms, ggseg::dk, by = "label")
plot_data_aseg <- merge(sOne_best_terms, ggseg::aseg, by = "label")

#Regions not matched in atlases
sOne_best_terms[!(sOne_best_terms$label %in% plot_data_dkt$label) & !(sOne_best_terms$label %in% plot_data_aseg$label),]

(t1.sOne_agemu_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = age.mu)) +
  theme_void()+
  labs(title = "Age in Mu"))

(t1.sOne_agemu_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = age.mu)) +
  theme_void() +
  labs(title = "Age in Mu"))

(t1.sOne_sexsigma_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = sex.sigma)) +
  theme_void()+
  labs(title = "Sex in Sigma"))

(t1.sOne_sexsigma_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = sex.sigma)) +
  theme_void() +
  labs(title = "Sex in Sigma"))

```
###sTwo
```{r}
#sTwo
sum(sTwo_best_terms$age.mu)
sum(sTwo_best_terms$sex.mu)
sum(sTwo_best_terms$age.sigma)
sum(sTwo_best_terms$sex.sigma)
sum(sTwo_best_terms$age.nu)
sum(sTwo_best_terms$sex.nu)


#visualize regions based on terms in the model
##merge with atlas data
plot_data_dkt <- merge(sTwo_best_terms, ggseg::dk, by = "label")
plot_data_aseg <- merge(sTwo_best_terms, ggseg::aseg, by = "label")

#Regions not matched in atlases
sTwo_best_terms[!(sTwo_best_terms$label %in% plot_data_dkt$label) & !(sTwo_best_terms$label %in% plot_data_aseg$label),]

(t1.sTwo_agemu_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = age.mu)) +
  theme_void()+
  labs(title = "Age in Mu"))

(t1.sTwo_agemu_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = age.mu)) +
  theme_void() +
  labs(title = "Age in Mu"))


(t1.sTwo_sexsigma_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = sex.sigma)) +
  theme_void()+
  labs(title = "Sex in Sigma"))

(t1.sTwo_sexsigma_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = sex.sigma)) +
  theme_void() +
  labs(title = "Sex in Sigma"))
```
#Load best model
```{r}
sOne_best_list <- paste0(splitOne_folder,"gamlssFIT_",sOne_best$model_index,".rds")
best_models_One <- lapply(sOne_best_list, readRDS)
sTwo_best_list <- paste0(splitTwo_folder,"gamlssFIT_",sTwo_best$model_index,".rds")
best_models_Two <- lapply(sTwo_best_list, readRDS)

#save indexes of best models
if(save_best_models == TRUE){
  filename_sOne <- paste0(fits_path, "t1.sOne_best_models_index.csv")
  write.csv(sOne_best_list, filename_sOne)
  filename_sTwo <- paste0(fits_path, "t1.sTwo_best_models_index.csv")
  write.csv(sTwo_best_list, filename_sTwo)
}
```
#Diagnostics
##Worm plots
get worm plots for best BIC within each phenotype, for each split
###sOne
####worm plots
```{r}
if(diagnostics == TRUE){
sOne_plots_wp <- vector(mode = "list", length = dim(sOne_best)[1])
sOne_wp_table <- data.frame(matrix(NA, nrow = dim(sOne_best)[1], ncol = 5))
names(sOne_wp_table) <- c("n", "n_outer", "pcnt", "phenotype", "label")
for (i  in 1:length(best_models_One)) {
  model <- best_models_One[[i]]
  phenotype <- as.character(model$mu.terms[[2]])
  title <- name_mapping$region_name[match(phenotype, name_mapping$abbreviation)]
      sOne_plots_wp[[i]] <- wp.taki(model, ylim.worm = 0.5, xlim.worm = 4) + labs(title = title)
      sOne_wp_table[i,1:3] <- wp.taki_EK(model, ylim.worm = 0.5, xlim.worm = 4, plot = FALSE) %>% select(all_of(c("n", "n_outer", "pcnt")))
      sOne_wp_table[i,4] <- phenotype
      sOne_wp_table[i,5] <- title
    }

if (plot == TRUE){
n <- length(sOne_plots_wp)
nCol <- min(c(floor(sqrt(n)), 4))
nRow <- min(ceiling(n/nCol), 4)
breaks <- c(seq(from = 0, to = n , by = (nCol*nRow)), n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(sOne_plots_wp[start:end], ncol=nCol))
}
}
}
print(paste0("Percent of models with <5% points outside the curved wp lines: ", sum(sOne_wp_table$pcnt < 0.05)/dim(sOne_wp_table)[1]))
```
###sTwo
####worm plots
```{r}
if(diagnostics == TRUE){
sTwo_plots_wp <- vector(mode = "list", length = dim(sTwo_best)[1])
sTwo_wp_table <- data.frame(matrix(NA, nrow = dim(sTwo_best)[1], ncol = 5))
names(sTwo_wp_table) <- c("n", "n_outer", "pcnt", "phenotype", "label")
for (i  in 1:length(best_models_Two)) {
  #print(deparse(model$mu.formula))
  model <- best_models_Two[[i]]
  phenotype <- as.character(model$mu.terms[[2]])
  title <- name_mapping$region_name[match(phenotype, name_mapping$abbreviation)]
      sTwo_plots_wp[[i]] <- wp.taki(model, ylim.worm = 0.5, xlim.worm = 4) + labs(title = title)
      sTwo_wp_table[i,1:3] <- wp.taki_EK(model, ylim.worm = 0.5, xlim.worm = 4, plot = FALSE) %>% select(all_of(c("n", "n_outer", "pcnt")))
      sTwo_wp_table[i,4] <- phenotype
      sTwo_wp_table[i,5] <- title
    }

if (plot == TRUE){
n <- length(sTwo_plots_wp)
nCol <- min(c(floor(sqrt(n)), 4))
nRow <- min(ceiling(n/nCol), 4)
breaks <- c(seq(from = 0, to = n , by = (nCol*nRow)), n)
for(k in 1:(length(breaks)-1)){
  start <- breaks[k]+1
  end <- breaks[k+1]
  do.call("grid.arrange", c(sTwo_plots_wp[start:end], ncol=nCol))
}
}
}
print(paste0("Percent of models with <5% points outside the curved wp lines: ", sum(sTwo_wp_table$pcnt < 0.05)/dim(sTwo_wp_table)[1]))
```
##cent-cdf
```{r}
if(diagnostics == TRUE){
print <- TRUE
centcdf_one <- setNames(data.frame(matrix(ncol = 3, nrow = dim(sOne_best)[1])), c("ph", "cdfcor_train", "cdfcor_test"))
centcdf_two <- setNames(data.frame(matrix(ncol = 3, nrow = dim(sTwo_best)[1])), c("ph", "cdfcor_train", "cdfcor_test"))
cdf_expected <- c(0.01, 0.05, 0.10, 0.25, 0.50, 0.75, 0.90, 0.95, 0.99)

for(i in 1:length(best_models_One)){
#define models from split one and split two
model_one <- best_models_One[[i]]
model_two <- best_models_Two[sapply(best_models_Two, function(x){any(grepl(as.character(model_one$mu.formula[[2]]),x$mu.formula))})][[1]]


title_one <- as.character(model_one$mu.formula[[2]])
title_two <- as.character(model_two$mu.formula[[2]])
stopifnot(title_one == title_two)

#define original df from split one and two, with phenotypes from the current model
og_df_one <- sOne_train_df %>% select(c("age", "sex", "site", model_one$mu.formula[[2]]))
og_df_two <- sTwo_train_df %>% select(c("age", "sex", "site", model_two$mu.formula[[2]]))

#calculate predicted centiles distribution for sOne models, using sOne train dataset and sTwo test dataset
#save correlation with expected cdf values
model <- model_one 
out_train_one <- suppressMessages(cent_cdf(model_one, og_df_one))$data
centcdf_one$ph[i] <- title_one
centcdf_one$cdfcor_train[i] <- (cor.test(out_train_one$empirical, out_train_one$fitted)$estimate)

#calculate predicted centiles distribution for sTwo models, using sTwo train dataset, and sOne test dataset
#save correlation with expected cdf values
model <- model_two
out_train_two <- suppressMessages(cent_cdf(model_two, og_df_two))$data
centcdf_two$ph[i] <- title_two
centcdf_two$cdfcor_train[i] <-  (cor.test(out_train_two$empirical, out_train_two$fitted)$estimate)


if (print == TRUE){
print(paste0("Correlation Coefficient Split One, Train Data ", title_one, centcdf_one$cdfcor_train[i]))
print(paste0("Correlation Coefficient Split Two, Train Data ", title_two, centcdf_two$cdfcor_train[i]))
}
}
}
```

#Predict Centiles
##predict centile scores for unseen split-half
```{r}
plot <- FALSE
print <- FALSE 

centiles_pred_one <- vector(mode = "list", length = dim(sOne_best)[1])
centiles_pred_two <- vector(mode = "list", length = dim(sTwo_best)[1])
splits_correlations <- setNames(data.frame(matrix(ncol = 4, nrow = dim(sOne_best)[1])), c("ph_one", "cor_est_one", "ph_two", "cor_est_two"))

for(i in 1:length(best_models_One)){
#define models from split one and split two
model_one <- best_models_One[[i]]
model_two <- best_models_Two[sapply(best_models_Two, function(x){any(grepl(as.character(model_one$mu.formula[[2]]),x$mu.formula))})][[1]]

title_one <- as.character(model_one$mu.formula[[2]])
title_two <- as.character(model_two$mu.formula[[2]])
stopifnot(title_one == title_two)

#define original df from split one and two, with phenotypes from the current model
og_df_one <- sOne_train_df %>% select(c("age", "sex",  "site", model_one$mu.formula[[2]]))
og_df_two <- sTwo_train_df %>% select(c("age", "sex", "site", model_two$mu.formula[[2]]))

#calculate predicted centiles on sOne and sTwo data using sOne model

model <- model_one
sOne_centiles_1 <- suppressMessages(pred_og_centile_EK(model_one, sOne_train_df))
sTwo_centiles_1 <- suppressMessages(pred_og_centile_EK(model_one, og_df_one, new.data = sTwo_train_df))
centiles_pred_two[[i]] <- suppressMessages(pred_og_centile_EK(model_one, og_df_one, new.data = sTwo_test_df))
names(centiles_pred_two)[i] <- paste(title_two, "centiles", sep = "_")
splits_correlations$ph_one[i] <- title_one

#calculate predicted centiles on sOne and sTwo data using sTwo model
model <- model_two
sOne_centiles_2 <- suppressMessages(pred_og_centile_EK(model_two, og_df_two, new.data = sOne_train_df))
sTwo_centiles_2 <- suppressMessages(pred_og_centile_EK(model_two, sTwo_train_df))
centiles_pred_one[[i]] <- suppressMessages(pred_og_centile_EK(model_two, og_df_two, new.data = sOne_test_df))
names(centiles_pred_one)[i] <- paste(title_one, "centiles", sep = "_")
splits_correlations$ph_two[i] <- title_two

if(plot == TRUE) {
  #Plotting sOne and sTwo from two predictions
  plot(sOne_centiles_1, sOne_centiles_2, main = paste0("split One: ", title_one) , ylab = "predictions from Model 1", xlab = "predictions from Model 2")
  abline(a = 0, b = 1, col = "red", lwd = 2, lty = 2)
  plot(sTwo_centiles_1, sTwo_centiles_2, main = paste0("split Two: ", title_two) , ylab = "predictions from Model 1", xlab = "predictions from Model 2")
  abline(a = 0, b = 1, col = "red", lwd = 2, lty = 2)
  }

#Correlation coefficients
cor_one <- cor.test(sOne_centiles_1, sOne_centiles_2)
cor_two <- cor.test(sTwo_centiles_1, sTwo_centiles_2)

#Save correlations in dataframe
splits_correlations$cor_est_one[i] <- cor_one$estimate
splits_correlations$cor_est_two[i] <- cor_two$estimate

if (print == TRUE){
print(paste0("Correlation Coefficient Split One, ", title_one, cor_one$estimate, " , ", cor_one$p.value))
print(paste0("Correlation Coefficient Split Two, ", title_two, cor_two$estimate, " , ", cor_two$p.value))
}
}
```
##Save predicted centiles
Save in single dataframe with columns for participant ID and split ID
```{r}
if(save_fits == TRUE){
output_folder <- paste0(fits_path, "centiles_calculated/")
if (!dir.exists(output_folder)) dir.create(output_folder)  
filename <- paste0(output_folder, "t1.volume_centiles_", Sys.Date(), ".csv")

centiles_One <- cbind(sOne_test_df %>% select(src_subject_id), as.data.frame(centiles_pred_one))
centiles_One$split_ID <- rep("1", dim(centiles_One)[1])
                             
centiles_Two <- cbind(sTwo_test_df %>% select(src_subject_id), as.data.frame(centiles_pred_two))
centiles_Two$split_ID <- rep("2", dim(centiles_Two)[1])

centiles_all <- rbind(centiles_One, centiles_Two)

write.csv(centiles_all, filename)
}
```
#Centiles fit metrics
##test uniform distribution
```{r}
if(sum(grepl("centiles",names(sOne_test_df)))== 0) {
sOne_test_df <- cbind(sOne_test_df, as.data.frame(centiles_pred_one))
sTwo_test_df <- cbind(sTwo_test_df, as.data.frame(centiles_pred_two))
}
full_test_df <- rbind(sOne_test_df,sTwo_test_df)

#sOne
kstest_one <- as.data.frame(t(sapply(sOne_test_df[, grepl("centiles", names(sOne_test_df))], function(x) {
  #jitter data with small noise to avoid "ties" warning
  x <- x + runif(length(x), -1e-6, 1e-6)
  test <- ks.test(x, "punif", 0, 1)

  c(p_value = test$p.value[1], test = "uniformity")
})))

kstest_one$p_adj <- p.adjust(kstest_one$p_value, method = "BH")
kstest_one$label <- name_mapping$region_name[match(sub("_centiles","",rownames(kstest_one)), name_mapping$abbreviation)]

kstest_one %>% filter(p_adj < 0.05) %>% select(label)

#sTwo
kstest_two <- as.data.frame(t(sapply(sTwo_test_df[, grepl("centiles", names(sTwo_test_df))], function(x) {
  #jitter data with small noise to avoid "ties" warning
  x <- x + runif(length(x), -1e-6, 1e-6)
  test <- ks.test(x, "punif", 0, 1)

  c(p_value = test$p.value[1], test = "uniformity")
})))

kstest_two$p_adj <- p.adjust(kstest_two$p_value, method = "BH")
kstest_two$label <- name_mapping$region_name[match(sub("_centiles","",rownames(kstest_two)), name_mapping$abbreviation)]

kstest_two %>% filter(p_adj < 0.05) %>% select(label)
```
#Save Parameter Table for Best Models
##sOne
```{r}
sOne_model_params_df <- data.frame(matrix(nrow = length(best_models_One), ncol = 18))
names(sOne_model_params_df) <- c("group","column_name", "family", "BIC", "mu_intercept", "mu_age", "mu_sexM", "mu_agesexM",
                                 "mu_randomsite_var", "mu_randomsite_std", "mu_randomsite_lambda",
                                 "sigma_intercept", "sigma_age", "sigma_sexM", 
                                 "nu_intercept", "nu_age", "nu_sexM", 
                                 "tau_intercept")

for (i in 1:length(best_models_One)){
  model = best_models_One[[i]]
  sOne_model_params_df$family[i] <- family(model)[[1]]
  sOne_model_params_df$BIC[i] <- BIC(model)
  phenotype <- as.character(formula(model)[[2]])
  sOne_model_params_df$column_name[i] <- phenotype
  #Gather parameters
  ##mu
  sOne_model_params_df$mu_intercept[i] <- model$mu.coefficients[["(Intercept)"]]
  sOne_model_params_df$mu_age[i] <- pull(model$mu.coefficients, "age")
  sOne_model_params_df$mu_sexM[i] <- pull(model$mu.coefficients, "sexM")
  sOne_model_params_df$mu_agesexM[i] <- pull(model$mu.coefficients, "age:sexM")
  sOne_model_params_df$mu_randomsite_var[i] <- model$mu.coefSmo[[1]]$sigb2
  sOne_model_params_df$mu_randomsite_std[i] <- model$mu.coefSmo[[1]]$sigb
  sOne_model_params_df$mu_randomsite_lambda[i] <- model$mu.coefSmo[[1]]$lambda
  ##sigma
  sOne_model_params_df$sigma_intercept[i] <- model$sigma.coefficients[["(Intercept)"]]
  sOne_model_params_df$sigma_age[i] <- pull(model$sigma.coefficients, "age")
  sOne_model_params_df$sigma_sexM[i] <- pull(model$sigma.coefficients, "sexM")
  ##nu
  sOne_model_params_df$nu_intercept[i] <- model$nu.coefficients[["(Intercept)"]]
  sOne_model_params_df$nu_age[i] <- pull(model$nu.coefficients, "age")
  sOne_model_params_df$nu_sexM[i] <- pull(model$nu.coefficients, "sexM")
  ##tau
  sOne_model_params_df$tau_intercept[i] <- model$tau.coefficients[["(Intercept)"]]
}

sOne_model_params_df$group <- ifelse(sOne_model_params_df$column_name %in% all_global_phenotypes, "global", "region")

column_order <- c("group","phenotype", "column_name", "family", "BIC", "mu_intercept", "mu_age", "mu_sexM", "mu_agesexM",
                                 "mu_randomsite_var", "mu_randomsite_std", "mu_randomsite_lambda",
                                 "sigma_intercept", "sigma_age", "sigma_sexM", 
                                 "nu_intercept", "nu_age", "nu_sexM", 
                                 "tau_intercept")

sOne_model_params_df <- merge(sOne_model_params_df, name_mapping, by.x = "column_name", by.y = "abbreviation", all.x = TRUE, all.y = FALSE)

sOne_model_params_df <- sOne_model_params_df %>% 
  rename(phenotype = "region_name") %>%
  select(all_of(column_order)) %>%
  arrange(group)
  
##save table as csv
filename <- "t1.sOne.modelparams.csv"
if (!dir.exists(paste0(fits_path, "model_params_tables/"))) dir.create(paste0(fits_path, "model_params_tables/"))
write.csv(sOne_model_params_df, paste0(fits_path, "model_params_tables/", filename))
```
##sTwo
```{r}
sTwo_model_params_df <- data.frame(matrix(nrow = length(best_models_One), ncol = 18))
names(sTwo_model_params_df) <- c("group","column_name", "family", "BIC", "mu_intercept", "mu_age", "mu_sexM", "mu_agesexM",
                                 "mu_randomsite_var", "mu_randomsite_std", "mu_randomsite_lambda",
                                 "sigma_intercept", "sigma_age", "sigma_sexM", 
                                 "nu_intercept", "nu_age", "nu_sexM", 
                                 "tau_intercept")

for (i in 1:length(best_models_One)){
  model = best_models_One[[i]]
  sTwo_model_params_df$family[i] <- family(model)[[1]]
  sTwo_model_params_df$BIC[i] <- BIC(model)
  phenotype <- as.character(formula(model)[[2]])
  sTwo_model_params_df$column_name[i] <- phenotype
  #Gather parameters
  ##mu
  sTwo_model_params_df$mu_intercept[i] <- model$mu.coefficients[["(Intercept)"]]
  sTwo_model_params_df$mu_age[i] <- pull(model$mu.coefficients, "age")
  sTwo_model_params_df$mu_sexM[i] <- pull(model$mu.coefficients, "sexM")
  sTwo_model_params_df$mu_agesexM[i] <- pull(model$mu.coefficients, "age:sexM")
  sTwo_model_params_df$mu_randomsite_var[i] <- model$mu.coefSmo[[1]]$sigb2
  sTwo_model_params_df$mu_randomsite_std[i] <- model$mu.coefSmo[[1]]$sigb
  sTwo_model_params_df$mu_randomsite_lambda[i] <- model$mu.coefSmo[[1]]$lambda
  ##sigma
  sTwo_model_params_df$sigma_intercept[i] <- model$sigma.coefficients[["(Intercept)"]]
  sTwo_model_params_df$sigma_age[i] <- pull(model$sigma.coefficients, "age")
  sTwo_model_params_df$sigma_sexM[i] <- pull(model$sigma.coefficients, "sexM")
  ##nu
  sTwo_model_params_df$nu_intercept[i] <- model$nu.coefficients[["(Intercept)"]]
  sTwo_model_params_df$nu_age[i] <- pull(model$nu.coefficients, "age")
  sTwo_model_params_df$nu_sexM[i] <- pull(model$nu.coefficients, "sexM")
  ##tau
  sTwo_model_params_df$tau_intercept[i] <- model$tau.coefficients[["(Intercept)"]]
}

sTwo_model_params_df$group <- ifelse(sTwo_model_params_df$column_name %in% all_global_phenotypes, "global", "region")

column_order <- c("group","phenotype", "column_name", "family", "BIC", "mu_intercept", "mu_age", "mu_sexM", "mu_agesexM",
                                 "mu_randomsite_var", "mu_randomsite_std", "mu_randomsite_lambda",
                                 "sigma_intercept", "sigma_age", "sigma_sexM", 
                                 "nu_intercept", "nu_age", "nu_sexM", 
                                 "tau_intercept")

sTwo_model_params_df <- merge(sTwo_model_params_df, name_mapping, by.x = "column_name", by.y = "abbreviation", all.x = TRUE, all.y = FALSE)

sTwo_model_params_df <- sTwo_model_params_df %>% 
  rename(phenotype = "region_name") %>%
  select(all_of(column_order)) %>%
  arrange(group)
  
##save table as csv
filename <- "t1.sTwo.modelparams.csv"
if (!dir.exists(paste0(fits_path, "model_params_tables/"))) dir.create(paste0(fits_path, "model_params_tables/"))
write.csv(sTwo_model_params_df, paste0(fits_path, "model_params_tables/", filename))
```