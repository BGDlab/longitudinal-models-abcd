---
title: "all models results"
author: "Eren Kafadar"
date: "2025-06-23"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Main Setup
```{r setup, include=FALSE}
save_tables <- TRUE
save_figures <- TRUE
code_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/longitudinal-models-abcd/"
save_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/3.0_results/"
data_path <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/update/"
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(gamlss) #to fit model
require(gamlss.ggplots)
library(splines)
library(tidyr)
library(gamlssTools) #Margaret's package
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggsegDKT)
library(ggseg)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)
library(gtsummary)
library(svglite)

source(paste0(code_path, "load_data_fct.R"))

#df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)

phenotypes_for_MC <- c(
    "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  )

global_phenotypes <- c("smri_vol_cdk_total", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv")

phenotypes_to_fit <- (c(phenotypes_for_MC, global_phenotypes, "smri_vol_scs_wholeb", "smri_vol_scs_wholeb", "totalWM_crb", "totalGM_crb", "smri_vol_scs_csf", "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_scs_cbwmatterlh", "smri_vol_scs_cbwmatterrh"))

#save phenotypes not plotted with ggseg surface plots
plot_data_dkt <- merge(name_mapping, ggseg::dk, by.x = "region_name", by.y = "label")
plot_data_aseg <- merge(name_mapping, ggseg::aseg, by.x = "region_name", by.y = "label")

#Regions not matched in atlases that are tested
regions_notplotted <- name_mapping[!(name_mapping$region_name %in% plot_data_dkt$region_name) & !(name_mapping$region_name %in% plot_data_aseg$region_name),] %>% filter(abbreviation %in% phenotypes_for_MC)
write.csv(regions_notplotted, "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/regions_notplotted.csv")
```
#Create folder for saving output
```{r}
betas_folder <- paste0(save_path, "full_betas/")
if (!dir.exists(paste0(save_path, "full_betas/"))) dir.create(betas_folder)

dkt_folder <- paste0(save_path, "dkt_betas/")
if (!dir.exists(dkt_folder)) dir.create(dkt_folder)

tableOne_folder <- paste0(save_path, "table_one/")
if (!dir.exists(tableOne_folder)) dir.create(tableOne_folder)

figure_panels_folder <- paste0(save_path, "figure_panels/")
if (!dir.exists(figure_panels_folder)) dir.create(figure_panels_folder)

panel_save <- function(plot, filename, extension, folder){
  save_name <- paste0(folder, filename, ".", extension)
  ggsave(save_name, plot = plot, dpi = 300)
}
```
#Data Setup
Load all saved centiles data tables for t1, t2, and longitudinal
##T1
###Define files
```{r}
#file paths
splitOne_folder <- paste0(save_path, "gamlss_fits_t1_BCT_vol_splitONE_2.0/")
splitTwo_folder <- paste0(save_path,"gamlss_fits_t1_BCT_vol_splitTWO_2.0/")
sOne_fits_stats_filename <- paste0(splitOne_folder, "gamlss_fits_stats_all.csv")
sTwo_fits_stats_filename <- paste0(splitTwo_folder, "gamlss_fits_stats_all.csv")
splitOne_train_filename <- paste0(data_path, "abcd_long_Onetrain2025-09-26.csv")
splitTwo_train_filename <- paste0(data_path, "abcd_long_Twotrain2025-09-26.csv")
splitOne_test_filename <- paste0(data_path, "abcd_long_Onetest2025-09-26.csv")
splitTwo_test_filename <- paste0(data_path, "abcd_long_Twotest2025-09-26.csv")

t1.centiles_filename <- paste0(save_path, "centiles_calculated/t1.volume_centiles_2025-11-15.csv")
```
###Load data frames and clean them up
```{r}
#rename variables and select t1 scans
rename_vec <- c(age = "interview_age", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

t1.sOne_train_df <- read.csv(splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sOne_train_df$sex <- as.factor(t1.sOne_train_df$sex)
t1.sOne_train_df$site <- as.factor(t1.sOne_train_df$site)
t1.sOne_train_df$age <- as.numeric(t1.sOne_train_df$age)

t1.sTwo_train_df <- read.csv(splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sTwo_train_df$sex <- as.factor(t1.sTwo_train_df$sex)
t1.sTwo_train_df$site <- as.factor(t1.sTwo_train_df$site)
t1.sTwo_train_df$age <- as.numeric(t1.sTwo_train_df$age)

t1.sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sOne_test_df$sex <- as.factor(t1.sOne_test_df$sex)
t1.sOne_test_df$site <- as.factor(t1.sOne_test_df$site)
t1.sOne_test_df$age <- as.numeric(t1.sOne_test_df$age)

t1.sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sTwo_test_df$sex <- as.factor(t1.sTwo_test_df$sex)
t1.sTwo_test_df$site <- as.factor(t1.sTwo_test_df$site)
t1.sTwo_test_df$age <- as.numeric(t1.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
t1.centiles <- read.csv(t1.centiles_filename)  %>% select(-1)
names(t1.centiles) <- sub("_centiles", ".t1_centiles", names(t1.centiles))
t1.full_test_df <- rbind(t1.sOne_test_df,t1.sTwo_test_df)
t1.full_test_df <- merge(t1.centiles, t1.full_test_df, by = "src_subject_id")
```
###calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
t1.full_test_df <- t1.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

t1.full_test_df$bweight_percentile <- igb_wtkg2centile(t1.full_test_df$gestAge_days, t1.full_test_df$birth_weight_kg, sex = t1.full_test_df$sexLong)/100

t1.full_test_df$bw_category <- ifelse(t1.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(t1.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
###QC for weight/height measures
```{r}
#keep original columns
t1.full_test_df$anthroweightcalc_og <- t1.full_test_df$anthroweightcalc
t1.full_test_df$anthroheightcalc_og <- t1.full_test_df$anthroheightcalc

#remove based on <30lbs, too low weight
#t1weight_mean <- mean(t1.full_test_df$anthroweightcalc, na.rm = TRUE)
#t1weight_sd <- sd(t1.full_test_df$anthroweightcalc, na.rm = TRUE)
t1.full_test_df$anthroweightcalc <- ifelse(t1.full_test_df$anthroweightcalc <30 , NA,
                                           t1.full_test_df$anthroweightcalc)

sum(is.na(t1.full_test_df$anthroweightcalc)) - sum(is.na(t1.full_test_df$anthroweightcalc_og)) #6 removed

#remove under 30 inches, two people at 0 and 4 inches removed, or over 80 inches, two removed
#t1height_mean <- mean(t1.full_test_df$anthroheightcalc, na.rm = TRUE)
#t1height_sd <- sd(t1.full_test_df$anthroheightcalc, na.rm = TRUE)
t1.full_test_df$anthroheightcalc <- ifelse(t1.full_test_df$anthroheightcalc < 30 | t1.full_test_df$anthroheightcalc > 80, NA,
                                           t1.full_test_df$anthroheightcalc)

sum(is.na(t1.full_test_df$anthroheightcalc)) - sum(is.na(t1.full_test_df$anthroheightcalc_og)) #4 removed

```
###encode full term as 38 weeks and 39 weeks
```{r}
t1.full_test_df$gestAge_38term <- ifelse(t1.full_test_df$gestAge == 40, 38, t1.full_test_df$gestAge)
t1.full_test_df$gestAge_39term <- ifelse(t1.full_test_df$gestAge == 40, 39, t1.full_test_df$gestAge)
```
##T2
###Define files
```{r}
#file paths
t2.splitOne_folder <- paste0(save_path, "gamlss_fits_t2_BCT_vol_splitONE_2.0/")
t2.splitTwo_folder <- paste0(save_path, "gamlss_fits_t2_BCT_vol_splitTWO_2.0/")
t2.sOne_fits_stats_filename <- paste0(t2.splitOne_folder, "gamlss_fits_stats_all.csv")
t2.sTwo_fits_stats_filename <- paste0(t2.splitTwo_folder, "gamlss_fits_stats_all.csv")

splitOne_train_filename <-paste0(data_path, "abcd_long_Onetrain2025-09-26.csv")
splitTwo_train_filename <- paste0(data_path, "abcd_long_Twotrain2025-09-26.csv")
splitOne_test_filename <- paste0(data_path, "abcd_long_Onetest2025-09-26.csv")
splitTwo_test_filename <- paste0(data_path, "abcd_long_Twotest2025-09-26.csv")

t2.centiles_filename <- paste0(save_path, "centiles_calculated/t2.volume_centiles_2025-11-15.csv")
```
### Load data frames and clean them up
```{r}
#rename variables and select t2 scans
rename_vec <- c(age = "interview_age", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

t2.sOne_train_df <- read.csv(splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sOne_train_df$sex <- as.factor(t2.sOne_train_df$sex)
t2.sOne_train_df$site <- as.factor(t2.sOne_train_df$site)
t2.sOne_train_df$age <- as.numeric(t2.sOne_train_df$age)

t2.sTwo_train_df <- read.csv(splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sTwo_train_df$sex <- as.factor(t2.sTwo_train_df$sex)
t2.sTwo_train_df$site <- as.factor(t2.sTwo_train_df$site)
t2.sTwo_train_df$age <- as.numeric(t2.sTwo_train_df$age)

t2.sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sOne_test_df$sex <- as.factor(t2.sOne_test_df$sex)
t2.sOne_test_df$site <- as.factor(t2.sOne_test_df$site)
t2.sOne_test_df$age <- as.numeric(t2.sOne_test_df$age)

t2.sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sTwo_test_df$sex <- as.factor(t2.sTwo_test_df$sex)
t2.sTwo_test_df$site <- as.factor(t2.sTwo_test_df$site)
t2.sTwo_test_df$age <- as.numeric(t2.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
t2.centiles <- read.csv(t2.centiles_filename)  %>% select(-1)
names(t2.centiles) <- sub("_centiles", ".t2_centiles", names(t2.centiles))
t2.full_test_df <- rbind(t2.sOne_test_df,t2.sTwo_test_df)
t2.full_test_df <- merge(t2.centiles, t2.full_test_df, by = "src_subject_id")
```
###calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
t2.full_test_df <- t2.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

t2.full_test_df$bweight_percentile <- igb_wtkg2centile(t2.full_test_df$gestAge_days, t2.full_test_df$birth_weight_kg, sex = t2.full_test_df$sexLong)/100

t2.full_test_df$bw_category <- ifelse(t2.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(t2.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
###add neonatal comp to t2 table
```{r}
t2.full_test_df$neonatal_comp_total <- NULL
t2.full_test_df <- merge(t2.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "neonatal_comp_total")), by = "src_subject_id", all.x = TRUE)
```
###QC for weight/height measures
```{r}
#keep original columns
t2.full_test_df$anthroweightcalc_og <- t2.full_test_df$anthroweightcalc
t2.full_test_df$anthroheightcalc_og <- t2.full_test_df$anthroheightcalc

#remove based on >400lbs, one very high removed at 3580lbs
#t2weight_mean <- mean(t2.full_test_df$anthroweightcalc, na.rm = TRUE)
#t2weight_sd <- sd(t2.full_test_df$anthroweightcalc, na.rm = TRUE)
t2.full_test_df$anthroweightcalc <- ifelse(t2.full_test_df$anthroweightcalc > 400, NA,
                                           t2.full_test_df$anthroweightcalc)

sum(is.na(t2.full_test_df$anthroweightcalc)) - sum(is.na(t2.full_test_df$anthroweightcalc_og)) #1 removed

#remove under 30 inches, one person at 6.5 inches, over 80 inches - 3 people at 89+ inches removed
#t2height_mean <- mean(t2.full_test_df$anthroheightcalc, na.rm = TRUE)
#t2height_sd <- sd(t2.full_test_df$anthroheightcalc, na.rm = TRUE)
t2.full_test_df$anthroheightcalc <- ifelse(t2.full_test_df$anthroheightcalc < 30 | t2.full_test_df$anthroheightcalc > 80, NA,
                                           t2.full_test_df$anthroheightcalc)

sum(is.na(t2.full_test_df$anthroheightcalc)) - sum(is.na(t2.full_test_df$anthroheightcalc_og)) #4 removed

```
###encode full term as 38 weeks and 39 weeks
```{r}
t2.full_test_df$gestAge_38term <- ifelse(t2.full_test_df$gestAge == 40, 38, t2.full_test_df$gestAge)
t2.full_test_df$gestAge_39term <- ifelse(t2.full_test_df$gestAge == 40, 39, t2.full_test_df$gestAge)
```
##LONG
###Define files
```{r}
#file paths
long.splitOne_folder <- paste0(save_path, "gamlss_fits_long_vol_splitONE_2.0/")
long.splitTwo_folder <- paste0(save_path, "gamlss_fits_long_vol_splitTWO_2.0/")
long.sOne_fits_stats_filename <- paste0(long.splitOne_folder, "gamlss_fits_stats_all.csv")
long.sTwo_fits_stats_filename <- paste0(long.splitTwo_folder, "gamlss_fits_stats_all.csv")

long.splitOne_train_filename <- paste0(data_path, "abcd_wide_Onetrain2025-10-03.csv")
long.splitTwo_train_filename <- paste0(data_path, "abcd_wide_Twotrain2025-10-03.csv")
long.splitOne_test_filename <- paste0(data_path, "abcd_wide_Onetest2025-10-03.csv")
long.splitTwo_test_filename <- paste0(data_path, "abcd_wide_Twotest2025-10-03.csv")

long.centiles_filename <- paste0(save_path, "centiles_calculated/long.volume_centiles_2025-11-15.csv")
```
###Load data frames and clean them up
```{r}
#rename variables
rename_vec <- c(age = "interview_age.t2", sex = "sex_baseline", site = "site_id_l.t2")

long.sOne_train_df <- read.csv(long.splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sOne_train_df$sex <- as.factor(long.sOne_train_df$sex)
long.sOne_train_df$site <- as.factor(long.sOne_train_df$site)
long.sOne_train_df$age <- as.numeric(long.sOne_train_df$age)

long.sTwo_train_df <- read.csv(long.splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sTwo_train_df$sex <- as.factor(long.sTwo_train_df$sex)
long.sTwo_train_df$site <- as.factor(long.sTwo_train_df$site)
long.sTwo_train_df$age <- as.numeric(long.sTwo_train_df$age)

long.sOne_test_df <- read.csv(long.splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sOne_test_df$sex <- as.factor(long.sOne_test_df$sex)
long.sOne_test_df$site <- as.factor(long.sOne_test_df$site)
long.sOne_test_df$age <- as.numeric(long.sOne_test_df$age)

long.sTwo_test_df <- read.csv(long.splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sTwo_test_df$sex <- as.factor(long.sTwo_test_df$sex)
long.sTwo_test_df$site <- as.factor(long.sTwo_test_df$site)
long.sTwo_test_df$age <- as.numeric(long.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
long.centiles <- read.csv(long.centiles_filename)  %>% select(-1)
names(long.centiles) <- sub(".t2_centiles", ".long_centiles", names(long.centiles))
long.full_test_df <- rbind(long.sOne_test_df,long.sTwo_test_df)
long.full_test_df <- merge(long.centiles, long.full_test_df, by = "src_subject_id")
```
###add birthweight metrics from t1 table
```{r}
long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "birth_weight_oz_sum_adj")), by = "src_subject_id", all.x = TRUE)
```
###calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
long.full_test_df <- long.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

long.full_test_df$bweight_percentile <- igb_wtkg2centile(long.full_test_df$gestAge_days, long.full_test_df$birth_weight_kg, sex = long.full_test_df$sexLong)/100

long.full_test_df$bw_category <- ifelse(long.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(long.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
###add neonatal comp from t1 table
```{r}
long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "neonatal_comp_total")), by = "src_subject_id", all.x = TRUE)
```
###add weight/height (both timepoint 1 and timepoint 2)
```{r}
long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "anthroweightcalc", "anthroheightcalc")) %>% rename(anthroweightcalc.t1 = anthroweightcalc, anthroheightcalc.t1 = anthroheightcalc), by = "src_subject_id", all.x = TRUE)
long.full_test_df <- merge(long.full_test_df, t2.full_test_df %>% select(c("src_subject_id", "anthroweightcalc", "anthroheightcalc")) %>% rename(anthroweightcalc.t2 = anthroweightcalc, anthroheightcalc.t2 = anthroheightcalc), by = "src_subject_id", all.x = TRUE)
```
####add birthweight pgs metrics from t1 table
```{r}
long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")))
```
####add gestAge sensitivity from t1 table
```{r}
long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "gestAge_38term", "gestAge_39term")), by = "src_subject_id", all.x = TRUE)
```
##Calculate General P change between timepoints
###T1
```{r}
t1.full_test_df <- merge(t1.full_test_df, t2.full_test_df %>% select(c("src_subject_id", "General_p")) %>% rename(General_p.t2 = General_p), by = "src_subject_id", all.x = TRUE)%>% rename(General_p.t1 = General_p)
t1.full_test_df$General_p_change <- t1.full_test_df$General_p.t2 - t1.full_test_df$General_p.t1
```
###T2
```{r}
t2.full_test_df <- merge(t2.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "General_p.t1")), by = "src_subject_id", all.x = TRUE)%>% rename(General_p.t2 = General_p)
t2.full_test_df$General_p_change <- t2.full_test_df$General_p.t2 - t2.full_test_df$General_p.t1
```
###LONG
```{r}
  long.full_test_df <- merge(long.full_test_df, t1.full_test_df %>% select(c("src_subject_id", "General_p.t1")), by = "src_subject_id", all.x = TRUE)
  long.full_test_df <- merge(long.full_test_df, t2.full_test_df %>% select(c("src_subject_id", "General_p.t2")), by = "src_subject_id", all.x = TRUE)
long.full_test_df$General_p_change <- long.full_test_df$General_p.t2 - long.full_test_df$General_p.t1
```
##Combine dataframes
To look at centile scores of the same subject across models.
```{r}
t1.full_test_df <- t1.full_test_df %>% rename(age.t1 = age, site.t1 = site)
t2.full_test_df_merge <- t2.full_test_df %>% rename(age.t2 = age, site.t2 = site) %>%
  select(-c("split_ID", "sex", "gestAge", "PTB", "twin_statusFAM", "twin_statusP", "triplet_statusFAM", "rel_family_id", "rel_birth_id", "nonSingleton", "scrn_birthcomp", "birth_weight_oz_adj", "birth_weight_oz_sum_adj", "neonatal_comp_total", "bw_pgs", "ga_pgs", "PC1", "PC2", "PC3", "PC4", "PC5","PC6","PC6", "PC7", "PC7", "PC8", "PC9", "PC10", "matched_group", "handedness", "parental_education", "General_p.t1", "General_p.t2", "General_p_change")) #removing variables from the t2 table that are also in the t1 table (they are NA in the t2 table, so interferes with merging)
shared_names = c("src_subject_id")
full.df <- merge(t1.full_test_df, t2.full_test_df_merge, by = shared_names, all.x = TRUE, suffixes = c(".t1",".t2"))
#add longitudinal centiles
long.full_test_df_tomerge <- long.full_test_df %>% select(c(names(long.full_test_df)[grepl(".long_centiles", names(long.full_test_df))], "interscan_months_t1t2", "src_subject_id"))
full.df <- merge(full.df, long.full_test_df_tomerge, by = shared_names, all.x = TRUE)
```

##SES Variables
###Load file
```{r}
abcd_demo_file <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/raw_tables_5.1/abcd_p_demo.csv"
abcd_demo <- read.csv(abcd_demo_file)
```
###Change encoding of variables
```{r}
abcd_demo <- abcd_demo %>%
  mutate(t1.income_label = case_when(
    demo_comb_income_v2 == 1 ~ "Less than $5,000",
    demo_comb_income_v2 == 2 ~ "$5,000 through $11,999",
    demo_comb_income_v2 == 3 ~ "$12,000 through $15,999",
    demo_comb_income_v2 == 4 ~ "$16,000 through $24,999",
    demo_comb_income_v2 == 5 ~ "$25,000 through $34,999",
    demo_comb_income_v2 == 6 ~ "$35,000 through $49,999",
    demo_comb_income_v2 == 7 ~ "$50,000 through $74,999",
    demo_comb_income_v2 == 8 ~ "$75,000 through $99,999",
    demo_comb_income_v2 == 9 ~ "$100,000 through $199,999",
    demo_comb_income_v2 == 10 ~ "$200,000 and greater",
    demo_comb_income_v2 == 999 ~ "Don't know",
    demo_comb_income_v2 == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_comb_income_v2)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t2.income_label = case_when(
    demo_comb_income_v2_l == 1 ~ "Less than $5,000",
    demo_comb_income_v2_l == 2 ~ "$5,000 through $11,999",
    demo_comb_income_v2_l == 3 ~ "$12,000 through $15,999",
    demo_comb_income_v2_l == 4 ~ "$16,000 through $24,999",
    demo_comb_income_v2_l == 5 ~ "$25,000 through $34,999",
    demo_comb_income_v2_l == 6 ~ "$35,000 through $49,999",
    demo_comb_income_v2_l == 7 ~ "$50,000 through $74,999",
    demo_comb_income_v2_l == 8 ~ "$75,000 through $99,999",
    demo_comb_income_v2_l == 9 ~ "$100,000 through $199,999",
    demo_comb_income_v2_l == 10 ~ "$200,000 and greater",
    demo_comb_income_v2_l == 999 ~ "Don't know",
    demo_comb_income_v2_l == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_comb_income_v2_l)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t1.prnt_edu_label = case_when(
    demo_prnt_ed_v2 %in% c(0:12) ~ "Didn't complete highschool",
    demo_prnt_ed_v2 %in% c(13,14) ~ "Completed highschool/GED",
    demo_prnt_ed_v2 %in% c(15:17) ~ "Some college/Associate's",
    demo_prnt_ed_v2 == 18 ~ "Bachelor's Degree",
    demo_prnt_ed_v2 %in% c(19:21) ~ "Advanced Degree",
    demo_prnt_ed_v2 == 999 ~ "Don't know",
    demo_prnt_ed_v2 == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_prnt_ed_v2)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t2.prnt_edu_label = case_when(
    demo_prnt_ed_v2_2yr_l %in% c(0:12) ~ "Didn't complete highschool",
    demo_prnt_ed_v2_2yr_l %in% c(13,14) ~ "Completed highschool/GED",
    demo_prnt_ed_v2_2yr_l %in% c(22,23,16,17) ~ "Some college/Associate's",
    demo_prnt_ed_v2_2yr_l == 18 ~ "Bachelor's Degree",
    demo_prnt_ed_v2_2yr_l %in% c(19:21) ~ "Advanced Degree",
    demo_prnt_ed_v2_2yr_l == 999 ~ "Don't know",
    demo_prnt_ed_v2_2yr_l == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_prnt_ed_v2_2yr_l)  # Default case, if none of the above match
  ))
```
###Add variables to data frames
set "no response" to NA
make the factors ordered
```{r}
abcd_demo$t1.income_label_NAs <- ifelse(abcd_demo$t1.income_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t1.income_label)
abcd_demo$t2.income_label_NAs <- ifelse(abcd_demo$t2.income_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t2.income_label)

abcd_demo$t1.prnt_edu_label_NAs <- ifelse(abcd_demo$t1.prnt_edu_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t1.prnt_edu_label)
abcd_demo$t2.prnt_edu_label_NAs <- ifelse(abcd_demo$t2.prnt_edu_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t2.prnt_edu_label)

t2.abcd_demo <- abcd_demo %>% filter(eventname == "2_year_follow_up_y_arm_1") %>%
  filter(src_subject_id %in% full.df$src_subject_id)
t1.abcd_demo <- abcd_demo %>% filter(eventname == "baseline_year_1_arm_1")%>%
  filter(src_subject_id %in% full.df$src_subject_id)

income_levels_order <- c("Less than $5,000","$5,000 through $11,999","$12,000 through $15,999", 
  "$16,000 through $24,999","$25,000 through $34,999","$35,000 through $49,999",
  "$50,000 through $74,999","$75,000 through $99,999","$100,000 through $199,999",
  "$200,000 and greater")
prnt_edu_levels_order <- c("Didn't complete highschool", "Completed highschool/GED", "Some college/Associate's", "Bachelor's Degree", "Advanced Degree")

#Add Income Levels to full df and to t1 / t2 dfs. Set level orders for ordered factor
##T1 Income
full.df <- merge(full.df, t1.abcd_demo %>% select(c("src_subject_id", "t1.income_label_NAs", "t1.income_label")) %>% rename(t1.income_ordered = t1.income_label_NAs), by = "src_subject_id", all.x = TRUE)
#full.df$t1.income_ordered <- as.factor(t1.abcd_demo$t1.income_label_NAs[match(full.df$src_subject_id, t1.abcd_demo$src_subject_id)])
full.df$t1.income_ordered <- factor(full.df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

t1.full_test_df <- merge(t1.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.income_label_NAs", "t1.income_label")) %>% rename(t1.income_ordered = t1.income_label_NAs), by = "src_subject_id", all.x = TRUE)
t1.full_test_df$t1.income_ordered <- factor(t1.full_test_df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

t2.full_test_df <- merge(t2.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.income_label_NAs", "t1.income_label")) %>% rename(t1.income_ordered = t1.income_label_NAs), by = "src_subject_id", all.x = TRUE)
t2.full_test_df$t1.income_ordered <- factor(t2.full_test_df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

long.full_test_df <- merge(long.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.income_label_NAs", "t1.income_label")) %>% rename(t1.income_ordered = t1.income_label_NAs), by = "src_subject_id", all.x = TRUE)
long.full_test_df$t1.income_ordered <- factor(long.full_test_df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

##T2 Income
full.df <- merge(full.df, t2.abcd_demo %>% select(c("src_subject_id", "t2.income_label_NAs", "t2.income_label")) %>% rename(t2.income_ordered = t2.income_label_NAs), by = "src_subject_id", all.x = TRUE)
full.df$t2.income_ordered <- factor(full.df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

t1.full_test_df <- merge(t1.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.income_label_NAs", "t2.income_label")) %>% rename(t2.income_ordered = t2.income_label_NAs), by = "src_subject_id", all.x = TRUE)
t1.full_test_df$t2.income_ordered <- factor(t1.full_test_df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

t2.full_test_df <- merge(t2.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.income_label_NAs", "t2.income_label")) %>% rename(t2.income_ordered = t2.income_label_NAs), by = "src_subject_id", all.x = TRUE)
t2.full_test_df$t2.income_ordered <- factor(t2.full_test_df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

long.full_test_df <- merge(long.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.income_label_NAs", "t2.income_label")) %>% rename(t2.income_ordered = t2.income_label_NAs), by = "src_subject_id", all.x = TRUE)
long.full_test_df$t2.income_ordered <- factor(long.full_test_df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

#Add Parent Education Levels to full df and to t1 / t2 dfs. Set level orders for ordered factor
##T1 Parent Education
full.df <- merge(full.df, t1.abcd_demo %>% select(c("src_subject_id", "t1.prnt_edu_label_NAs", "t1.prnt_edu_label")) %>% rename(t1.prnt_edu_ordered = t1.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
full.df$t1.prnt_edu_ordered <- factor(full.df$t1.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

t1.full_test_df <- merge(t1.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.prnt_edu_label_NAs", "t1.prnt_edu_label")) %>% rename(t1.prnt_edu_ordered = t1.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
t1.full_test_df$t1.prnt_edu_ordered <- factor(t1.full_test_df$t1.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

t2.full_test_df <- merge(t2.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.prnt_edu_label_NAs", "t1.prnt_edu_label")) %>% rename(t1.prnt_edu_ordered = t1.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
t2.full_test_df$t1.prnt_edu_ordered <- factor(t2.full_test_df$t1.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

long.full_test_df <- merge(long.full_test_df, t1.abcd_demo %>% select(c("src_subject_id", "t1.prnt_edu_label_NAs", "t1.prnt_edu_label")) %>% rename(t1.prnt_edu_ordered = t1.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
long.full_test_df$t1.prnt_edu_ordered <- factor(long.full_test_df$t1.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

##T2 Parent Education
full.df <- merge(full.df, t2.abcd_demo %>% select(c("src_subject_id", "t2.prnt_edu_label_NAs", "t2.prnt_edu_label")) %>% rename(t2.prnt_edu_ordered = t2.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
full.df$t2.prnt_edu_ordered <- factor(full.df$t2.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

t1.full_test_df <- merge(t1.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.prnt_edu_label_NAs", "t2.prnt_edu_label")) %>% rename(t2.prnt_edu_ordered = t2.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
t1.full_test_df$t2.prnt_edu_ordered <- factor(t1.full_test_df$t2.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

t2.full_test_df <- merge(t2.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.prnt_edu_label_NAs", "t2.prnt_edu_label")) %>% rename(t2.prnt_edu_ordered = t2.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
t2.full_test_df$t2.prnt_edu_ordered <- factor(t2.full_test_df$t2.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)

long.full_test_df <- merge(long.full_test_df, t2.abcd_demo %>% select(c("src_subject_id", "t2.prnt_edu_label_NAs", "t2.prnt_edu_label")) %>% rename(t2.prnt_edu_ordered = t2.prnt_edu_label_NAs), by = "src_subject_id", all.x = TRUE)
long.full_test_df$t2.prnt_edu_ordered <- factor(long.full_test_df$t2.prnt_edu_ordered, levels = prnt_edu_levels_order, ordered = TRUE)
```
###Create a combo variable for income and parental education, using t1 if available and t2 if t1 is not available
```{r}
#T1
t1.full_test_df$combo.income_ordered <- t1.full_test_df$t1.income_ordered
t1.full_test_df$combo.income_ordered[is.na(t1.full_test_df$t1.income_ordered)] <- t1.full_test_df$t2.income_ordered[is.na(t1.full_test_df$t1.income_ordered)]

t1.full_test_df$combo.prnt_edu_ordered <- t1.full_test_df$t1.prnt_edu_ordered
t1.full_test_df$combo.prnt_edu_ordered[is.na(t1.full_test_df$t1.prnt_edu_ordered)] <- t1.full_test_df$t2.prnt_edu_ordered[is.na(t1.full_test_df$t1.prnt_edu_ordered)]

#T2
t2.full_test_df$combo.income_ordered <- t2.full_test_df$t1.income_ordered
t2.full_test_df$combo.income_ordered[is.na(t2.full_test_df$t1.income_ordered)] <- t2.full_test_df$t2.income_ordered[is.na(t2.full_test_df$t1.income_ordered)]

t2.full_test_df$combo.prnt_edu_ordered <- t2.full_test_df$t1.prnt_edu_ordered
t2.full_test_df$combo.prnt_edu_ordered[is.na(t2.full_test_df$t1.prnt_edu_ordered)] <- t2.full_test_df$t2.prnt_edu_ordered[is.na(t2.full_test_df$t1.prnt_edu_ordered)]

#LONG
long.full_test_df$combo.income_ordered <- long.full_test_df$t1.income_ordered
long.full_test_df$combo.income_ordered[is.na(long.full_test_df$t1.income_ordered)] <- long.full_test_df$t2.income_ordered[is.na(long.full_test_df$t1.income_ordered)]

long.full_test_df$combo.prnt_edu_ordered <- long.full_test_df$t1.prnt_edu_ordered
long.full_test_df$combo.prnt_edu_ordered[is.na(long.full_test_df$t1.prnt_edu_ordered)] <- long.full_test_df$t2.prnt_edu_ordered[is.na(long.full_test_df$t1.prnt_edu_ordered)]
```
#BW - PGSBW corr
```{r}
cor.test(t1.full_test_df$birth_weight_oz_sum_adj, t1.full_test_df$bw_pgs)
```
#Make Table One
by timepoint and split-half
```{r}
t1.full_test_df$table_group <- paste0(t1.full_test_df$matched_group, "_t1")
t1.full_test_df <- t1.full_test_df %>% rename(age = age.t1, site = site.t1)
t2.full_test_df$table_group <- paste0(t2.full_test_df$matched_group, "_t2")

names_no_centiles <- names(t1.full_test_df)[-grep("centiles", names(t1.full_test_df))]
table1_df <- rbind(t1.full_test_df %>% select(all_of(names_no_centiles)), 
                   t2.full_test_df %>% select(all_of(names_no_centiles))) %>%
  mutate(age_years = age/12) %>%
  mutate(bwpgs_zscore = as.numeric(scale(bw_pgs))) %>%
  mutate(neonatal_comp_total = as.numeric(neonatal_comp_total)) %>%
  mutate(table_group = factor(table_group, levels = c("1_t1", "2_t1", "1_t2", "2_t2"))) %>%
  arrange(table_group)


# Create Table 1 with additional variables
table1 <- table1_df %>%
  select(table_group, age_years, sex, gestAge, bwpgs_zscore, birth_weight_oz_sum_adj, neonatal_comp_total, General_p.t1, General_p.t2) %>%
  tbl_summary(
    by = table_group,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = c(bwpgs_zscore, General_p.t1, General_p.t2) ~ function(x) format(x, digits = 3, scientific = TRUE),
    missing = "always",
    missing_stat = "{N_nonmiss}", 
    missing_text = "N known"
  ) %>%
  bold_labels()

# View Table
table1

table1_save <- as_tibble(table1)

write.csv(table1_save, paste0(tableOne_folder, "Table_One_", Sys.Date(),".csv"))

#Neonatal comp total is added as a categorical (I can't fix the function above to see it as continuous), want to include as a continuous -- calculate mean and SD manually here.
table1_df %>%
  select(c("table_group", "neonatal_comp_total")) %>%
  group_by(table_group) %>%
 summarise(mean_value = mean(neonatal_comp_total, na.rm = TRUE),
    sd_value = sd(neonatal_comp_total, na.rm = TRUE))

# Create Supplemental Table 1 with additional variables
table1_sup <- table1_df %>%
  select(table_group, anthroweightcalc, anthroheightcalc, combo.income_ordered, combo.prnt_edu_ordered, bw_pgs, neonatal_comp_total) %>%
  tbl_summary(
    by = table_group,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = c(bw_pgs) ~ function(x) format(x, digits = 3, scientific = TRUE),
    missing = "always",
    missing_stat = "{N_nonmiss}", 
    missing_text = "N known"
  ) %>%
  bold_labels()

# View Table
table1_sup

table1_sup_save <- as_tibble(table1_sup)

write.csv(table1_sup_save, paste0(tableOne_folder, "Table_One_Supplement_", Sys.Date(), ".csv"))
```
#Load Global Phenotype Models
##t1 global phenotype models
```{r}
#load saved fits
t1.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/t1_BCT_fits.csv"
t1.all_fits <- read.csv(t1.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% c(global_phenotypes, "smri_vol_scs_wholeb"))
t1.sOne_fits <- t1.all_fits %>% filter(split_no == 1)
t1.sTwo_fits <- t1.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t1.sOne_best <- t1.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t1.sTwo_best <- t1.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t1.sOne_best_list <- paste0(splitOne_folder,"gamlssFIT_",t1.sOne_best$model_index,".rds")
t1.best_models_One <- lapply(t1.sOne_best_list, readRDS)
t1.sTwo_best_list <- paste0(splitTwo_folder,"gamlssFIT_",t1.sTwo_best$model_index,".rds")
t1.best_models_Two <- lapply(t1.sTwo_best_list, readRDS)
```
##t2 global phenotype models
```{r}
#load saved fits
t2.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/t2_BCT_fits.csv"
t2.all_fits <- read.csv(t2.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% c(global_phenotypes, "smri_vol_scs_wholeb"))
t2.sOne_fits <- t2.all_fits %>% filter(split_no == 1)
t2.sTwo_fits <- t2.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t2.sOne_best <- t2.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t2.sTwo_best <- t2.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t2.sOne_best_list <- paste0(t2.splitOne_folder,"gamlssFIT_",t2.sOne_best$model_index,".rds")
t2.best_models_One <- lapply(t2.sOne_best_list, readRDS)
t2.sTwo_best_list <- paste0(t2.splitTwo_folder,"gamlssFIT_",t2.sTwo_best$model_index,".rds")
t2.best_models_Two <- lapply(t2.sTwo_best_list, readRDS)
```
##longitudinal global phenotype models
```{r}
global_t2 <- paste0(c(global_phenotypes, "smri_vol_scs_wholeb"), ".t2")
#load saved fits
long.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/long_fits.csv"
long.all_fits <- read.csv(long.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% global_t2)
long.sOne_fits <- long.all_fits %>% filter(split_no == 1)
long.sTwo_fits <- long.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
long.sOne_best <- long.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

long.sTwo_best <- long.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
long.sOne_best_list <- paste0(long.splitOne_folder,"gamlssFIT_",long.sOne_best$model_index,".rds")
long.best_models_One <- lapply(long.sOne_best_list, readRDS)
long.sTwo_best_list <- paste0(long.splitTwo_folder,"gamlssFIT_",long.sTwo_best$model_index,".rds")
long.best_models_Two <- lapply(long.sTwo_best_list, readRDS)
```
#Centiles Across Models
##Plot centiles against each other & calculate correlations for each phenotype
```{r}
length_names <- length(grep(".t1_centiles", names(full.df)))
#Ensure all names are in the same order
names <- names(full.df)[grep(".t1_centiles", names(full.df))] %>% sub(".t1_centiles","",.)
names.t1 <- paste0(names, ".t1_centiles")
names.t2 <- paste0(names, ".t2_centiles")
names.long <- paste0(names, ".long_centiles")
plots <- vector(mode = "list", length = length_names)
plots.long <- vector(mode = "list", length = length_names)
plots.t2 <- vector(mode = "list", length = length_names)
plots.t1 <- vector(mode = "list", length = length_names)
df <- data.frame(matrix(ncol = 4, nrow = dim(full.df)[1]))
colnames(df) <- c("t1.vector", "t2.vector", "diff.vector", "long.vector")
cor_df <- data.frame(matrix(ncol = 10, nrow = length_names))
colnames(cor_df) <- c("t1_t2.cor", "t1_t2.p", "t1_t2.p_adj", "t1_long.cor", "t1_long.p", "t1_long.p_adj","t2_long.cor", "t2_long.p", "t2_long.p_adj", "label")
for(i in 1:length_names){
  df$t1.vector <- qnorm(full.df[,names.t1[i]])
  df$t2.vector <- qnorm(full.df[,names.t2[i]])
  col_name <- paste0(names[i], ".diff")
  full.df[[col_name]] <- df$t2.vector-df$t1.vector
  df$diff.vector <- df$t2.vector-df$t1.vector
  df$long.vector <- qnorm(full.df[,names.long[i]])
  title <-  as.character(name_mapping$region_name[match(names[i],  name_mapping$abbreviation)])
  plots[[i]] <- ggplot(data = df, mapping = aes(x = t1.vector, y = t2.vector, color = long.vector)) + geom_point(aes(alpha = 0.5)) + ggtitle(title)
  names(plots)[i] <- title
  plots.long[[i]]<- ggplot(data = df, mapping = aes(x = diff.vector, y = long.vector, color = t1.vector)) + geom_point(aes(alpha = 0.3)) + ggtitle(title) + xlab("t2-t1 centiles")
  names(plots.long)[i] <- title
  plots.t2[[i]]<- ggplot(data = df, mapping = aes(x = t2.vector, y = long.vector, color = t1.vector)) + geom_point(aes(alpha = 0.3)) + ggtitle(title)
  names(plots.t2)[i] <- title
  plots.t1[[i]]<- ggplot(data = df, mapping = aes(x = t1.vector, y = long.vector, color = t2.vector)) + geom_point(aes(alpha = 0.3)) + ggtitle(title)
  names(plots.t1)[i] <- title
  #Correlations between centile scores
  ##Set infinite to NA
  df <- df %>% 
  mutate(across(all_of(c("t1.vector", "t2.vector", "long.vector")), ~ replace(., is.infinite(.), NaN)))
  t1_t2.cor_test <- cor.test(df$t1.vector, df$t2.vector)
  t1_long.cor_test <- cor.test(df$t1.vector, df$long.vector)
  t2_long.cor_test <- cor.test(df$t2.vector, df$long.vector)
  cor_df$label[i] <- title
  cor_df$t1_t2.cor[i] <- t1_t2.cor_test$estimate
  cor_df$t1_t2.p[i] <- t1_t2.cor_test$p.value
  cor_df$t1_long.cor[i] <- t1_long.cor_test$estimate
  cor_df$t1_long.p[i] <- t1_long.cor_test$p.value
  cor_df$t2_long.cor[i] <- t2_long.cor_test$estimate
  cor_df$t2_long.p[i] <- t2_long.cor_test$p.value
}

cor_df$t1_t2.p_adj <- p.adjust(cor_df$t1_t2.p, method = "BH")
cor_df$t1_long.p_adj <- p.adjust(cor_df$t1_long.p, method = "BH")
cor_df$t2_long.p_adj <- p.adjust(cor_df$t2_long.p, method = "BH")

print(paste0("Correlation Coef Range t1-t2 centiles: ", range(cor_df[cor_df$t1_t2.p_adj < 0.05,]$t1_t2.cor)))
print(paste0("Correlation Coef Range t1-long centiles: ", range(cor_df[cor_df$t1_long.p_adj < 0.05,]$t1_long.cor)))
print(paste0("Correlation Coef Range t2-long centiles: ", range(cor_df[cor_df$t2_long.p_adj < 0.05,]$t2_long.cor)))
```
##Plot Correlations between centile scores on surface maps
```{r}
###plot
#T1-T2
#merge with atlas data
#merge with atlas data only regions that are significant in correlation
plot_data_dkt <- merge(cor_df %>% filter(t1_t2.p_adj < 0.05), ggseg::dk, by = "label")
plot_data_aseg <- merge(cor_df %>% filter(t1_t2.p_adj < 0.05), ggseg::aseg, by = "label")

#Setting manual limits (could match the colorbar limits between different variables)
(t1.t2_cor_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t1_t2.cor)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-1, 1)) +
  theme_void()+
  labs(title = "T1-T2 cor"))

(t1.t2_cor_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = t1_t2.cor)) +
  scale_fill_gradient2(low = "white", high = "#D65F5F", limits = c(-1, 1)) +
  theme_void() +
  labs(title = "T1-T2 cor"))

if(save_figures == TRUE){
panel_save(t1.t2_cor_dkt_plot, "t1_t2_dsk", "png", figure_panels_folder)
panel_save(t1.t2_cor_aseg_plot, "t1_t2_aseg", "png", figure_panels_folder)
}
#t1-long
#merge with atlas data only regions that are significant in correlation
plot_data_dkt <- merge(cor_df %>% filter(t1_long.p_adj < 0.05), ggseg::dk, by = "label")
plot_data_aseg <- merge(cor_df %>% filter(t1_long.p_adj < 0.05), ggseg::aseg, by = "label")

(t1.long_cor_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t1_long.cor)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-1, 1)) +
  theme_void()+
  labs(title = "T1-Long Cor"))

(t1.long_cor_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = t1_long.cor)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",limits = c(-1, 1)) +
  theme_void() +
  labs(title = "T1-Long Cor"))

if(save_figures == TRUE){
panel_save(t1.long_cor_dkt_plot, "t1_long_dsk", "png", figure_panels_folder)
panel_save(t1.long_cor_aseg_plot, "t1_long_aseg", "png", figure_panels_folder)
}

#T2-Long
#merge with atlas data only regions that are significant in correlation
plot_data_dkt <- merge(cor_df %>% filter(t2_long.p_adj < 0.05), ggseg::dk, by = "label")
plot_data_aseg <- merge(cor_df %>% filter(t2_long.p_adj < 0.05), ggseg::aseg, by = "label")

#Setting manual limits (could match the colorbar limits between different variables)
(t2.long_cor_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = t2_long.cor)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-1, 1)) +
  theme_void()+
  labs(title = "T2-Long Cor"))

(t2.long_cor_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = t2_long.cor)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",limits = c(-1, 1)) +
  theme_void() +
  labs(title = "T2-Long Cor"))

if(save_figures == TRUE){
panel_save(t2.long_cor_dkt_plot, "t2_long_dsk", "png", figure_panels_folder)
panel_save(t2.long_cor_aseg_plot, "t2_long_aseg", "png", figure_panels_folder)
}
```
##CMD-Centile Mahalanobis Distance
for t1, t2, and t3
```{r}
length_names <- length(grep(".t1_centiles", names(full.df)))
#Ensure all names are in the same order
names <- names(full.df)[grep(".t1_centiles", names(full.df))] %>% sub(".t1_centiles","",.)
names.t1 <- paste0(names, ".t1_centiles")
names.t2 <- paste0(names, ".t2_centiles")
names.long <- paste0(names, ".long_centiles")
df_var <- data.frame(matrix(ncol = 4, nrow = dim(full.df)[1]))
colnames(df_var) <- c("t1.variance", "t2.variance", "long.variance", "subject_id")
#CMD Calculation
##T1
t1.center <- colMeans(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t1_centiles"))))
t1.cov_matrix <- cov(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t1_centiles"))))
t1.md <- mahalanobis(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t1_centiles"))), t1.center, t1.cov_matrix)
full.df$t1.cmd <- t1.md
##T2
t2.center <- colMeans(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t2_centiles"))), na.rm = TRUE)
t2.cov_matrix <- cov(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t2_centiles"))), use = "complete.obs")
t2.md <- mahalanobis(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".t2_centiles"))), t2.center, t2.cov_matrix)
full.df$t2.cmd <- t2.md
##long
long.center <- colMeans(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".long_centiles"))), na.rm = TRUE)
long.cov_matrix <- cov(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".long_centiles"))), use = "complete.obs")
long.md <- mahalanobis(full.df %>% select(all_of(paste0(phenotypes_for_MC, ".long_centiles"))), long.center, long.cov_matrix)
full.df$long.cmd <- long.md

#remove outliers as defined by >5 sd from the mean
test.df <- full.df %>% filter(t1.cmd < mean(full.df$t1.cmd) + 10*sd(full.df$t1.cmd))

#correlations between CMDs across three centiles
cor.test(test.df$t1.cmd, test.df$t2.cmd)
cor.test(test.df$t1.cmd, test.df$long.cmd)
cor.test(test.df$t2.cmd, test.df$long.cmd)

#Plots for CMD correlations
(t1_t2_cmd <- ggplot(data = test.df, mapping = aes(x = t1.cmd, y = t2.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal() + labs (x = "timepoint 1", y = "timepoint 2"))

(t1_long_cmd <- ggplot(data = test.df, mapping = aes(x = t1.cmd, y = long.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal() + labs (x = "timepoint 1", y = "conditional longitudinal"))

(t2_long_cmd <- ggplot(data = test.df, mapping = aes(x = t2.cmd, y = long.cmd)) + 
  geom_point(alpha = 0.3, color = "gray") + 
  geom_smooth(method = "lm", se = FALSE, color = "magenta") +
  theme_minimal()  + labs (x = "timepoint 2", y = "conditional longitudinal"))

if(save_figures == TRUE){
ggsave(plot=t1_t2_cmd, filename=paste0(figure_panels_folder,'t1_t2_cmd_plot.svg'), dpi=300, width=12, height=8)
ggsave(plot=t1_long_cmd, filename=paste0(figure_panels_folder,'t1_long_cmd_plot.svg'), dpi=300, width=12, height=8)
ggsave(plot=t2_long_cmd, filename=paste0(figure_panels_folder,'t2_long_cmd_plot.svg'), dpi=300, width=12, height=8)
}
```
#Plots for Fig 1
##Choose individuals to plot
```{r}
full.df %>% filter(smri_vol_cdk_total.t1_centiles > 0.9 & smri_vol_cdk_total.long_centiles > 0.95) %>%
  select(c(src_subject_id, smri_vol_cdk_total.long_centiles, smri_vol_cdk_total.t1_centiles, smri_vol_cdk_total.t2_centiles))

full.df %>% filter(smri_vol_cdk_total.t1_centiles < 0.1 & smri_vol_cdk_total.long_centiles > 0.95) %>%
  select(c(src_subject_id, smri_vol_cdk_total.long_centiles, smri_vol_cdk_total.t1_centiles, smri_vol_cdk_total.t2_centiles))

full.df %>% filter(smri_vol_cdk_total.t1_centiles > 0.9 & smri_vol_cdk_total.long_centiles < 0.1) %>%
  select(c(src_subject_id, smri_vol_cdk_total.long_centiles, smri_vol_cdk_total.t1_centiles, smri_vol_cdk_total.t2_centiles))

full.df %>% filter(smri_vol_cdk_total.t1_centiles < 0.1 & smri_vol_cdk_total.long_centiles < 0.1) %>%
  select(c(src_subject_id, smri_vol_cdk_total.long_centiles, smri_vol_cdk_total.t1_centiles, smri_vol_cdk_total.t2_centiles))

full.df %>% filter(smri_vol_cdk_total.t1_centiles < 0.65 & smri_vol_cdk_total.t1_centiles > 0.45 & smri_vol_cdk_total.long_centiles < 0.6 & smri_vol_cdk_total.long_centiles > 0.4 & smri_vol_cdk_total.diff > 0.1) %>%
  select(c(src_subject_id, smri_vol_cdk_total.long_centiles, smri_vol_cdk_total.t1_centiles, smri_vol_cdk_total.t2_centiles, smri_vol_cdk_total.diff))
```
##t1 plot
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV101HGWPC", "NDAR_INVUAD5V60L", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t1.best_models_One[[1]]
df.t1 <- full.df  %>% select(c("smri_vol_cdk_total.t1", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1, smri_vol_cdk_total = smri_vol_cdk_total.t1)

#subject 1
sub1.t1 <- df.t1 %>% filter(src_subject_id == subjects[1])
sub1_age.t1 <- sub1.t1$age
sub1_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub1.t1  <- sub1.t1 %>% slice(rep(1,100))

#simulate across age
sub1.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub1_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t1))

t1.sub1_plot <- t1.sub1_plot + geom_point(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1], label = round(sub1_centile.t1, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5), 
    panel.grid = element_blank(),
    axis.line.x = element_line(color = 'lightgrey'),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(96, 144, by = 12),              # positions (in months)
   labels = as.character(seq(8, 12, by = 1)),    # corresponding labels (in years)
   limits = c(105,133)               # fix x-axis range
  )

#subject 2
sub2.t1 <- df.t1 %>% filter(src_subject_id == subjects[2])
sub2_age.t1 <- sub2.t1$age
sub2_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub2.t1  <- sub2.t1 %>% slice(rep(1,100))

#simulate across age
sub2.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub2_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t1))

t1.sub2_plot <- t1.sub2_plot + geom_point(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1], label = round(sub2_centile.t1, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5), panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(96, 144, by = 12),              # positions (in months)
   labels = as.character(seq(8, 12, by = 1)),    # corresponding labels (in years)
   limits = c(105,133)               # fix x-axis range
  )

#subject 3
sub3.t1 <- df.t1 %>% filter(src_subject_id == subjects[3])
sub3_age.t1 <- sub3.t1$age
sub3_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub3.t1  <- sub3.t1 %>% slice(rep(1,100))

#simulate across age
sub3.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub3_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t1))

t1.sub3_plot <- t1.sub3_plot + geom_point(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1], label = round(sub3_centile.t1, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5), panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(96, 144, by = 12),              # positions (in months)
   labels = as.character(seq(8, 12, by = 1)),    # corresponding labels (in years)
   limits = c(105,133)               # fix x-axis range
  )

#subject 4
sub4.t1 <- df.t1 %>% filter(src_subject_id == subjects[4])
sub4_age.t1 <- sub4.t1$age
sub4_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub4.t1  <- sub4.t1 %>% slice(rep(1,100))

#simulate across age
sub4.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub4_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t1))

t1.sub4_plot <- t1.sub4_plot + geom_point(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1], label = round(sub4_centile.t1, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5), panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(96, 144, by = 12),              # positions (in months)
   labels = as.character(seq(8, 12, by = 1)),    # corresponding labels (in years)
   limits = c(105,133)               # fix x-axis range
  )

#Save the panels
if(save_figures == TRUE){
ggsave(plot=t1.sub1_plot, filename=paste0(figure_panels_folder,'t1_sub1.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t1.sub2_plot, filename=paste0(figure_panels_folder,'t1_sub2.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t1.sub3_plot, filename=paste0(figure_panels_folder,'t1_sub3.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t1.sub4_plot, filename=paste0(figure_panels_folder,'t1_sub4.svg'), dpi=300, width=12, height=8, device = "svg")
}
```
##t2 plot
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV101HGWPC", "NDAR_INVUAD5V60L", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t2.best_models_One[[1]]
df.t2 <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2, smri_vol_cdk_total = smri_vol_cdk_total.t2)

#subject 1
sub1.t2 <- df.t2 %>% filter(src_subject_id == subjects[1])
sub1_age.t2 <- sub1.t2$age
sub1_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub1.t2  <- sub1.t2 %>% slice(rep(1,100))

#simulate across age
sub1.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub1_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t2))

t2.sub1_plot <- t2.sub1_plot + geom_point(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total[1], label = round(sub1_centile.t2, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 2
sub2.t2 <- df.t2 %>% filter(src_subject_id == subjects[2])
sub2_age.t2 <- sub2.t2$age
sub2_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub2.t2  <- sub2.t2 %>% slice(rep(1,100))

#simulate across age
sub2.t2$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub2_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t2))

t2.sub2_plot <- t2.sub2_plot + geom_point(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total[1], label = round(sub2_centile.t2, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 3
sub3.t2 <- df.t2 %>% filter(src_subject_id == subjects[3])
sub3_age.t2 <- sub3.t2$age
sub3_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub3.t2  <- sub3.t2 %>% slice(rep(1,100))

#simulate across age
sub3.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub3_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t2))

t2.sub3_plot <- t2.sub3_plot + geom_point(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total[1], label = round(sub3_centile.t2, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 4
sub4.t2 <- df.t2 %>% filter(src_subject_id == subjects[4])
sub4_age.t2 <- sub4.t2$age
sub4_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub4.t2  <- sub4.t2 %>% slice(rep(1,100))

#simulate across age
sub4.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub4_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t2))

t2.sub4_plot <- t2.sub4_plot + geom_point(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total[1], label = round(sub4_centile.t2, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 780000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#Save the panels
if(save_figures == TRUE){
ggsave(plot=t2.sub1_plot, filename=paste0(figure_panels_folder,'t2_sub1.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t2.sub2_plot, filename=paste0(figure_panels_folder,'t2_sub2.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t2.sub3_plot, filename=paste0(figure_panels_folder,'t2_sub3.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=t2.sub4_plot, filename=paste0(figure_panels_folder,'t2_sub4.svg'), dpi=300, width=12, height=8, device = "svg")
}
```
##longitudinal plot
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV101HGWPC", "NDAR_INVUAD5V60L", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- long.best_models_One[[1]]
df.long <- full.df  %>% select(c("smri_vol_cdk_total.t2", "smri_vol_cdk_total.t1", "interscan_months_t1t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2)

#subject 1
sub1.long <- df.long %>% filter(src_subject_id == subjects[1])
sub1_age.long <- sub1.long$age
sub1_centile.long <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub1.long  <- sub1.long %>% slice(rep(1,100))

#simulate across age
sub1.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub1_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[1], average_over = FALSE, sim_data_list = list(one = sub1.long))

long.sub1_plot <- long.sub1_plot + geom_point(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1], label = round(sub1_centile.long, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(500000, 650000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(530000, 620000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 2
sub2.long <- df.long %>% filter(src_subject_id == subjects[2])
sub2_age.long <- sub2.long$age
sub2_centile.long <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub2.long  <- sub2.long %>% slice(rep(1,100))

#simulate across age
sub2.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub2_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[2], average_over = FALSE, sim_data_list = list(one = sub2.long))

long.sub2_plot <- long.sub2_plot + geom_point(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1], label = round(sub2_centile.long, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(600000, 800000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(660000, 750000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 3
sub3.long <- df.long %>% filter(src_subject_id == subjects[3])
sub3_age.long <- sub3.long$age
sub3_centile.long <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub3.long  <- sub3.long %>% slice(rep(1,100))

#simulate across age
sub3.long$age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub3_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[3], average_over = FALSE, sim_data_list = list(one = sub3.long))

long.sub3_plot <- long.sub3_plot + geom_point(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1], label = round(sub3_centile.long, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(550000, 700000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(580000, 670000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#subject 4
sub4.long <- df.long %>% filter(src_subject_id == subjects[4])
sub4_age.long <- sub4.long$age
sub4_centile.long <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub4.long  <- sub4.long %>% slice(rep(1,100))

#simulate across age
sub4.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub4_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[4], average_over = FALSE, sim_data_list = list(one = sub4.long))

long.sub4_plot <- long.sub4_plot + geom_point(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1], label = round(sub4_centile.long, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),panel.grid = element_blank(),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(500000, 600000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(495000, 580000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(120, 168, by = 12),              # positions (in months)
   labels = as.character(seq(10, 14, by = 1)),    # corresponding labels (in years)
   limits = c(125,167)               # fix x-axis range
  )

#Save the panels
if(save_figures == TRUE){
ggsave(plot=long.sub1_plot, filename=paste0(figure_panels_folder,'long_sub1.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=long.sub2_plot, filename=paste0(figure_panels_folder,'long_sub2.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=long.sub3_plot, filename=paste0(figure_panels_folder,'long_sub3.svg'), dpi=300, width=12, height=8, device = "svg")
ggsave(plot=long.sub4_plot, filename=paste0(figure_panels_folder,'long_sub4.svg'), dpi=300, width=12, height=8, device = "svg")
}
```
##Put plots together
```{r}
# Define plots (3 columns of 3 plots each)
plots <- list(
  t1 = list(
    t1.sub1_plot, 
    t1.sub2_plot, 
    t1.sub3_plot, 
    t1.sub4_plot
  ),
  t2 = list(
    t2.sub1_plot, 
    t2.sub2_plot, 
    t2.sub3_plot,
    t2.sub4_plot
  ),
  long = list(
    long.sub1_plot, 
    long.sub2_plot, 
    long.sub3_plot,
    long.sub4_plot
  )
)

#Get x axis and title
x_axis_1 <- get_plot_component(plots$t1[[1]], "axis-b")
x_axis_2 <- get_plot_component(plots$t2[[1]], "axis-b")
x_axis_3 <- get_plot_component(plots$long[[1]], "axis-b")

xlab <- get_plot_component(plots$t1[[1]], "xlab-b")
ylab <- get_plot_component(plots$t1[[1]], "ylab-l")

title_1 <- get_plot_component(plots$t1[[1]], "title", return_all = TRUE)[[2]]
title_2 <- get_plot_component(plots$t2[[1]], "title", return_all = TRUE)[[2]]
title_3 <- get_plot_component(plots$long[[1]], "title", return_all = TRUE)[[2]]



# Remove x-axis and xlab and ylab and titles from all plots
##change this function to be adaptable for # of plots
clean_column <- function(plot_list) {
  plot_list[[1]] <- plot_list[[1]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[2]] <- plot_list[[2]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[3]] <- plot_list[[3]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[4]] <- plot_list[[4]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  return(plot_list)
}

plots$t1 <- clean_column(plots$t1)
plots$t2 <- clean_column(plots$t2)
plots$long <- clean_column(plots$long)

# Build each column with 3 plots + shared x-axis + shared title
make_column <- function(plot_list, x_axis, title) {
  col_body <- plot_grid(plotlist = plot_list, ncol = 1, align = 'v', rel_heights = c(1, 1, 1))
  with_x <- plot_grid(col_body, x_axis, ncol = 1, rel_heights = c(1, 0.1))
  with_title <- plot_grid(title, with_x, ncol = 1, rel_heights = c(0.1, 1))
  return(with_title)
}

col1 <- make_column(plots$t1, x_axis_1, title_1)
col2 <- make_column(plots$t2, x_axis_2, title_2)
col3 <- make_column(plots$long, x_axis_3, title_3)

# Combine all columns side by side
final_grid <- plot_grid(col1, col2, col3, ncol = 3, align = "h", rel_widths = c(1, 1, 1))
final_grid <- plot_grid(ylab, final_grid, ncol = 2,rel_widths = c(0.05, 1))
final_grid <- plot_grid(final_grid,xlab, ncol = 1, rel_heights = c(1, 0.05))

# Display final plot grid
print(final_grid)

#save plot grid
if(save_figures == TRUE){
filename_fig1 <- paste0(figure_panels_folder, "Fig1.svg")
ggsave(plot=final_grid, filename=filename_fig1, dpi=300, width=12, height=8)
}
```
#Plots for Fig 2/Fig 3/Fig 4 and supplements
##get number of infinite cells when qnormed, make a table of N per phenotype
```{r}

inf_nan_table <- as.data.frame(t(sapply(full.df[c(grep("centiles", names(full.df)))], function(x){
  x_norm <- qnorm(x)
  c(inf = sum(is.infinite(x_norm)), nan = sum(is.nan(x_norm)))
})))

max(inf_nan_table$inf)
max(inf_nan_table$nan)

inf_nan_table %>% filter(inf > 0)
```
##T1
###Gestational Age
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge))
ga_zscore <- scale(t1.full_test_df$gestAge)

#Global phenotypes
ga_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_reg_table_global.t1)), name_mapping$abbreviation)]

ga_reg_table_global.t1_sig <- ga_reg_table_global.t1 %>% filter(ga_p < 0.05)
ga_reg_table_global.t1$ga_p_adj <- p.adjust(ga_reg_table_global.t1$ga_p, method = "BH")
ga_reg_table_global.t1_sig_MC <- ga_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

ga_reg_table_global.t1_sig_MC

#Regional phenotypes
ga_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_reg_table_full.t1)), name_mapping$abbreviation)]

ga_reg_table_full.t1_sig <- ga_reg_table_full.t1 %>% filter(ga_p < 0.05)
ga_reg_table_full.t1$ga_p_adj <- p.adjust(ga_reg_table_full.t1$ga_p, method = "BH")
ga_reg_table_full.t1_sig_MC <- ga_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_all_t1.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_global_t1.csv")
filename_regional <- paste0(output_folder, "ga_regional_t1.csv")
write.csv(ga_reg_table_global.t1, filename_global)
write.csv(ga_reg_table_full.t1, filename_regional)
}
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t1_sig_MC[!(ga_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t1.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void()+
  labs(title = "GA T1"))

(t1.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.ga_dkt_plot, "ga_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.ga_aseg_plot, "ga_t1_aseg", "pdf", figure_panels_folder)
}
```
###Gestational Age - 38 week sensitivity
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge_38term))
ga_zscore <- scale(t1.full_test_df$gestAge_38term)

#Global phenotypes
ga_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_reg_table_global.t1)), name_mapping$abbreviation)]

ga_reg_table_global.t1_sig <- ga_reg_table_global.t1 %>% filter(ga_p < 0.05)
ga_reg_table_global.t1$ga_p_adj <- p.adjust(ga_reg_table_global.t1$ga_p, method = "BH")
ga_reg_table_global.t1_sig_MC <- ga_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

ga_reg_table_global.t1_sig_MC

#Regional phenotypes
ga_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_reg_table_full.t1)), name_mapping$abbreviation)]

ga_reg_table_full.t1_sig <- ga_reg_table_full.t1 %>% filter(ga_p < 0.05)
ga_reg_table_full.t1$ga_p_adj <- p.adjust(ga_reg_table_full.t1$ga_p, method = "BH")
ga_reg_table_full.t1_sig_MC <- ga_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_38term_all_t1.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga38term_global_t1.csv")
filename_regional <- paste0(output_folder, "ga38term_regional_t1.csv")
write.csv(ga_reg_table_global.t1, filename_global)
write.csv(ga_reg_table_full.t1, filename_regional)
}
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t1_sig_MC[!(ga_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t1.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void()+
  labs(title = "GA 38 week term T1"))

(t1.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA 38 week term T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.ga_dkt_plot, "ga_38term_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.ga_aseg_plot, "ga_38term_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$birth_weight_oz_sum_adj))
df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)

#Global models save
bw_global_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})
  
#Global phenotypes -- save betas and p-values
bw_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_reg_table_global.t1)), name_mapping$abbreviation)]

bw_reg_table_global.t1_sig <- bw_reg_table_global.t1 %>% filter(bw_p < 0.05)
bw_reg_table_global.t1$bw_p_adj <- p.adjust(bw_reg_table_global.t1$bw_p, method = "BH")
bw_reg_table_global.t1_sig_MC <- bw_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

bw_reg_table_global.t1_sig_MC

#Regional models save
bw_regional_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})

#Regional phenotypes -- save betas and p-values
bw_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_reg_table_full.t1)), name_mapping$abbreviation)]

bw_reg_table_full.t1_sig <- bw_reg_table_full.t1 %>% filter(bw_p < 0.05)
bw_reg_table_full.t1$bw_p_adj <- p.adjust(bw_reg_table_full.t1$bw_p, method = "BH")
bw_reg_table_full.t1_sig_MC <- bw_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_regional_t1.csv")
write.csv(bw_reg_table_global.t1, filename_global)
write.csv(bw_reg_table_full.t1, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full.t1_sig_MC[!(bw_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW T1"))

(t1.bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_reg_table_full.t1_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_reg_table_full.t1_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t1.bw_dkt_plot, "bw_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bw_aseg_plot, "bw_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bweight_percentile))
bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)

#Global Phenotypes
bwp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_reg_table_global.t1)), name_mapping$abbreviation)]

bwp_reg_table_global.t1_sig <- bwp_reg_table_global.t1 %>% filter(bwp_p < 0.05)
bwp_reg_table_global.t1$bwp_p_adj <- p.adjust(bwp_reg_table_global.t1$bwp_p, method = "BH")
bwp_reg_table_global.t1_sig_MC <- bwp_reg_table_global.t1 %>% filter(bwp_p_adj < 0.05)

bwp_reg_table_global.t1_sig_MC

#Regional Phenotypes
bwp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_reg_table_full.t1)), name_mapping$abbreviation)]

bwp_reg_table_full.t1_sig <- bwp_reg_table_full.t1 %>% filter(bwp_p < 0.05)
bwp_reg_table_full.t1$bwp_p_adj <- p.adjust(bwp_reg_table_full.t1$bwp_p, method = "BH")
bwp_reg_table_full.t1_sig_MC <- bwp_reg_table_full.t1 %>% filter(bwp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bwp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bwp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightpercentile_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_global_t1.csv")
filename_regional <- paste0(output_folder, "bwp_regional_t1.csv")
write.csv(bwp_reg_table_global.t1, filename_global)
write.csv(bwp_reg_table_full.t1, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_reg_table_full.t1_sig_MC[!(bwp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bwp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp T1"))

(t1.bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_reg_table_full.t1_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_reg_table_full.t1_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t1.bwp_dkt_plot, "bwp_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwp_aseg_plot, "bwp_t1_aseg", "pdf", figure_panels_folder)
}
```
###PRS-bw
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bw_pgs))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_reg_table_global.t1)), name_mapping$abbreviation)]

bw_pgs_reg_table_global.t1_sig <- bw_pgs_reg_table_global.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_global.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_global.t1$bw_pgs_p, method = "BH")
bw_pgs_reg_table_global.t1_sig_MC <- bw_pgs_reg_table_global.t1 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_reg_table_global.t1_sig_MC

#Regional Phenotypes
bw_pgs_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[,which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_reg_table_full.t1)), name_mapping$abbreviation)]

bw_pgs_reg_table_full.t1_sig <- bw_pgs_reg_table_full.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full.t1$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full.t1_sig_MC <- bw_pgs_reg_table_full.t1 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_pgs_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightPGS_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_pgs_regional_t1.csv")
write.csv(bw_pgs_reg_table_global.t1, filename_global)
write.csv(bw_pgs_reg_table_full.t1, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full.t1_sig_MC[!(bw_pgs_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs T1"))

(t1.bwpgs_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_reg_table_full.t1_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_reg_table_full.t1_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t1.bwpgs_dkt_plot, "bw_pgs_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwpgs_aseg_plot, "bw_pgs_t1_aseg", "pdf", figure_panels_folder)
}
```
####correlations with bw
- spin test in Python using neuromaps package
```{r}
bw_bwpgs.t1 <- merge(bw_pgs_reg_table_full.t1, bw_reg_table_full.t1, by = c("label"))
#all regions
plot(bw_bwpgs.t1$bw_beta, bw_bwpgs.t1$bw_pgs_beta)
cor.test(bw_bwpgs.t1$bw_beta, bw_bwpgs.t1$bw_pgs_beta)
#only significant post-FDR in both
bw_bwpgs.t1_sig <- bw_bwpgs.t1 %>% filter(bw_p_adj < 0.05 & bw_pgs_p_adj < 0.05)
if(dim(bw_bwpgs.t1_sig)[1] > 0 ){
  plot(bw_bwpgs.t1_sig$bw_beta, bw_bwpgs.t1_sig$bw_pgs_beta)
  cor.test(bw_bwpgs.t1_sig$bw_beta, bw_bwpgs.t1_sig$bw_pgs_beta)
}
```
###Neonatal complications
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$neonatal_comp_total))
neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)

#Global Phenotypes
neocomp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ neocomp_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_reg_table_global.t1)), name_mapping$abbreviation)]

neocomp_reg_table_global.t1_sig <- neocomp_reg_table_global.t1 %>% filter(neocomp_p < 0.05)
neocomp_reg_table_global.t1$neocomp_p_adj <- p.adjust(neocomp_reg_table_global.t1$neocomp_p, method = "BH")
neocomp_reg_table_global.t1_sig_MC <- neocomp_reg_table_global.t1 %>% filter(neocomp_p_adj < 0.05)

neocomp_reg_table_global.t1_sig_MC

#Regional Phenotypes
neocomp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ neocomp_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_reg_table_full.t1)), name_mapping$abbreviation)]

neocomp_reg_table_full.t1_sig <- neocomp_reg_table_full.t1 %>% filter(neocomp_p < 0.05)
neocomp_reg_table_full.t1$neocomp_p_adj <- p.adjust(neocomp_reg_table_full.t1$neocomp_p, method = "BH")
neocomp_reg_table_full.t1_sig_MC <- neocomp_reg_table_full.t1 %>% filter(neocomp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- neocomp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "neocomp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_neocomp_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_neocomp_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_global_t1.csv")
filename_regional <- paste0(output_folder, "neocomp_regional_t1.csv")
write.csv(neocomp_reg_table_global.t1, filename_global)
write.csv(neocomp_reg_table_full.t1, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_reg_table_full.t1_sig_MC[!(neocomp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),] %>% 
  select(c('neocomp_beta', 'neocomp_p_adj', 'label'))

# Plot using ggseg
(t1.neocomp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",                        limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp t1"))

(t1.neocomp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",                        limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp t1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_reg_table_full.t1_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_reg_table_full.t1_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t1.neocomp_dkt_plot, "neocomp_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.neocomp_aseg_plot, "neocomp_t1_aseg", "pdf", figure_panels_folder)
}
```
###general P-factor
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$General_p.t1))
gp_zscore <- scale(t1.full_test_df$General_p.t1)

#Global Phenotypes
gp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_reg_table_global.t1)), name_mapping$abbreviation)]

gp_reg_table_global.t1_sig <- gp_reg_table_global.t1 %>% filter(gp_p < 0.05)
gp_reg_table_global.t1$gp_p_adj <- p.adjust(gp_reg_table_global.t1$gp_p, method = "BH")
gp_reg_table_global.t1_sig_MC <- gp_reg_table_global.t1 %>% filter(gp_p_adj < 0.05)

gp_reg_table_global.t1_sig_MC

#Regional Phenotypes
gp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_reg_table_full.t1)), name_mapping$abbreviation)]

gp_reg_table_full.t1_sig <- gp_reg_table_full.t1 %>% filter(gp_p < 0.05)
gp_reg_table_full.t1$gp_p_adj <- p.adjust(gp_reg_table_full.t1$gp_p, method = "BH")
gp_reg_table_full.t1_sig_MC <- gp_reg_table_full.t1 %>% filter(gp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- gp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_gp_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_gp_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_global_t1.csv")
filename_regional <- paste0(output_folder, "gp_regional_t1.csv")
write.csv(gp_reg_table_global.t1, filename_global)
write.csv(gp_reg_table_full.t1, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full.t1_sig_MC[!(gp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "P-factor T1"))

(t1.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
 scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "P-factor T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_reg_table_full.t1_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_reg_table_full.t1_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t1.gp_dkt_plot, "gp_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.gp_aseg_plot, "gp_t1_aseg", "pdf", figure_panels_folder)
}
```

###General P-factor - change in P-factor -- including baseline P-factor as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$General_p_change) & !is.na(t1.full_test_df$General_p.t1))
gp_change_zscore <- scale(t1.full_test_df$General_p_change)
gp_change_baseline_zscore <- scale(t1.full_test_df$General_p.t1)

#Global Phenotypes
gp_change_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_change_zscore + gp_change_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_change_beta = summary$coefficients[2,1], gp_change_p = summary$coefficients[2,4], gp_change_se = summary$coefficients[2,2],gp_change_base_beta = summary$coefficients[3,1], gp_change_base_p = summary$coefficients[3,4], gp_change_base_se = summary$coefficients[3,2])
})))

gp_change_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_change_reg_table_global.t1)), name_mapping$abbreviation)]

gp_change_reg_table_global.t1_sig <- gp_change_reg_table_global.t1 %>% filter(gp_change_p < 0.05)
gp_change_reg_table_global.t1$gp_change_p_adj <- p.adjust(gp_change_reg_table_global.t1$gp_change_p, method = "BH")
gp_change_reg_table_global.t1$gp_change_base_p_adj <- p.adjust(gp_change_reg_table_global.t1$gp_change_base_p, method = "BH")
gp_change_reg_table_global.t1_sig_MC <- gp_change_reg_table_global.t1 %>% filter(gp_change_p_adj < 0.05)

gp_change_reg_table_global.t1_sig_MC

#Regional Phenotypes
gp_change_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_change_zscore + gp_change_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_change_beta = summary$coefficients[2,1], gp_change_p = summary$coefficients[2,4], gp_change_se = summary$coefficients[2,2],gp_change_base_beta = summary$coefficients[3,1], gp_change_base_p = summary$coefficients[3,4], gp_change_base_se = summary$coefficients[3,2])
})))

gp_change_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_change_reg_table_full.t1)), name_mapping$abbreviation)]

gp_change_reg_table_full.t1_sig <- gp_change_reg_table_full.t1 %>% filter(gp_change_p < 0.05)
gp_change_reg_table_full.t1$gp_change_p_adj <- p.adjust(gp_change_reg_table_full.t1$gp_change_p, method = "BH")
gp_change_reg_table_full.t1$gp_change_base_p_adj <- p.adjust(gp_change_reg_table_full.t1$gp_change_base_p, method = "BH")
gp_change_reg_table_full.t1_sig_MC <- gp_change_reg_table_full.t1 %>% filter(gp_change_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_change_global_t1.csv")
filename_regional <- paste0(output_folder, "gp_change_regional_t1.csv")
write.csv(gp_change_reg_table_global.t1, filename_global)
write.csv(gp_change_reg_table_full.t1, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_change_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_change_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_change_reg_table_full.t1_sig_MC[!(gp_change_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(gp_change_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.gp_change_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_change_beta)) +
  theme_void() +
  labs(title = "GP Change, t1"))

(t1.gp_change_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_change_beta)) +
  theme_void() +
  labs(title = "GP Change, t1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_change_reg_table_full.t1_sig_MC %>% filter(gp_change_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_change_reg_table_full.t1_sig_MC$gp_change_beta)))

if(save_figures == TRUE){
panel_save(t1.gp_change_dkt_plot, "gp_change_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.gp_change_aseg_plot, "gp_change_t1_aseg", "pdf", figure_panels_folder)
}
```

###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$bweight_percentile))
ga_zscore <- scale(t1.full_test_df$gestAge)
bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ga_reg_table_global.t1)), name_mapping$abbreviation)]

ga_reg_table_global.t1_sig <- bwp_ga_reg_table_global.t1 %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global.t1$ga_p_adj <- p.adjust(bwp_ga_reg_table_global.t1$ga_p, method = "BH")
bwp_ga_reg_table_global.t1$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global.t1$bwp_p, method = "BH")
ga_reg_table_global.t1_sig_MC <- bwp_ga_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global.t1_sig <- bwp_ga_reg_table_global.t1 %>% filter(bwp_p < 0.05)
bwpga_reg_table_global.t1_sig_MC <- bwp_ga_reg_table_global.t1 %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global.t1_sig_MC


#regional regression
bwp_ga_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ga_reg_table_full.t1)), name_mapping$abbreviation)]

ga_reg_table_full.t1_sig <- bwp_ga_reg_table_full.t1 %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full.t1$ga_p_adj <- p.adjust(bwp_ga_reg_table_full.t1$ga_p, method = "BH")
bwp_ga_reg_table_full.t1$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full.t1$bwp_p, method = "BH")
ga_reg_table_full.t1_sig_MC <- bwp_ga_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full.t1_sig <- bwp_ga_reg_table_full.t1 %>% filter(bwp_p < 0.05)
bwpga_reg_table_full.t1_sig_MC <- bwp_ga_reg_table_full.t1 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ga_global_t1.csv")
filename_regional <- paste0(output_folder, "bwp_ga_regional_t1.csv")
write.csv(bwp_ga_reg_table_global.t1, filename_global)
write.csv(bwp_ga_reg_table_full.t1, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t1_sig_MC[!(ga_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, T1"))

(t1.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.bwpga_ga_dkt_plot, "bwpga_ga_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwpga_ga_aseg_plot, "bwpga_ga_t1_aseg", "pdf", figure_panels_folder)
}
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full.t1_sig_MC[!(bwpga_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, T1"))

(t1.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwpga_reg_table_full.t1_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwpga_reg_table_full.t1_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t1.bwpga_bwp_dkt_plot, "bwpga_bwp_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwpga_bwp_aseg_plot, "bwpga_bwp_t1_aseg", "pdf", figure_panels_folder)
}
```

###BW + BW PGS 
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bw_pgs) & !is.na(t1.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(t1.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwbwpgs_reg_table_global.t1)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global.t1_sig <- bwbwpgs_reg_table_global.t1 %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global.t1$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global.t1$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global.t1_sig_MC <- bwbwpgs_reg_table_global.t1 %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global.t1_sig_MC

bw_bwbwpgs_reg_table_global.t1_sig <- bwbwpgs_reg_table_global.t1 %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global.t1$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global.t1$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global.t1_sig_MC <- bwbwpgs_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global.t1_sig_MC

#Regional variables
bwbwpgs_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwbwpgs_reg_table_full.t1)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full.t1_sig <- bwbwpgs_reg_table_full.t1 %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full.t1$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full.t1$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full.t1_sig_MC <- bwbwpgs_reg_table_full.t1 %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full.t1_sig <- bwbwpgs_reg_table_full.t1 %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full.t1$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full.t1$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full.t1_sig_MC <- bwbwpgs_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_bwpgs_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_bwpgs_regional_t1.csv")
write.csv(bwbwpgs_reg_table_global.t1, filename_global)
write.csv(bwbwpgs_reg_table_full.t1, filename_regional)
}
```
###GA with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$neonatal_comp_total))
ga_zscore <- scale(t1.full_test_df$gestAge)
neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)

#Global phenotypes
ga_neocomp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_neocomp_reg_table_global.t1)), name_mapping$abbreviation)]

ga_neocomp_reg_table_global.t1_sig <- ga_neocomp_reg_table_global.t1 %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_global.t1$ga_p_adj <- p.adjust(ga_neocomp_reg_table_global.t1$ga_p, method = "BH")
ga_neocomp_reg_table_global.t1_sig_MC <- ga_neocomp_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

ga_neocomp_reg_table_global.t1_sig_MC

#Regional phenotypes
ga_neocomp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_neocomp_reg_table_full.t1)), name_mapping$abbreviation)]

ga_neocomp_reg_table_full.t1_sig <- ga_neocomp_reg_table_full.t1 %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_full.t1$ga_p_adj <- p.adjust(ga_neocomp_reg_table_full.t1$ga_p, method = "BH")
ga_neocomp_reg_table_full.t1_sig_MC <- ga_neocomp_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_neocomp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_neocomp_all_t1.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_neocomp_global_t1.csv")
filename_regional <- paste0(output_folder, "ga_neocomp_regional_t1.csv")
write.csv(ga_neocomp_reg_table_global.t1, filename_global)
write.csv(ga_neocomp_reg_table_full.t1, filename_regional)
}
```
###BW with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$birth_weight_oz_sum_adj) & !is.na(t1.full_test_df$neonatal_comp_total))
bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)
neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)

#Global phenotypes
bw_neocomp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_neocomp_reg_table_global.t1)), name_mapping$abbreviation)]

bw_neocomp_reg_table_global.t1_sig <- bw_neocomp_reg_table_global.t1 %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_global.t1$bw_p_adj <- p.adjust(bw_neocomp_reg_table_global.t1$bw_p, method = "BH")
bw_neocomp_reg_table_global.t1_sig_MC <- bw_neocomp_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

bw_neocomp_reg_table_global.t1_sig_MC

#Regional phenotypes
bw_neocomp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_neocomp_reg_table_full.t1)), name_mapping$abbreviation)]

bw_neocomp_reg_table_full.t1_sig <- bw_neocomp_reg_table_full.t1 %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_full.t1$bw_p_adj <- p.adjust(bw_neocomp_reg_table_full.t1$bw_p, method = "BH")
bw_neocomp_reg_table_full.t1_sig_MC <- bw_neocomp_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_neocomp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_bw_neocomp_all_t1.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_neocomp_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_neocomp_regional_t1.csv")
write.csv(bw_neocomp_reg_table_global.t1, filename_global)
write.csv(bw_neocomp_reg_table_full.t1, filename_regional)
}
```
###Gestational Age - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
ga_zscore <- scale(t1.full_test_df$gestAge)

#Global regression
ga_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_ses_reg_table_global.t1)), name_mapping$abbreviation)]

ga_ses_table_global.t1_sig <- ga_ses_reg_table_global.t1 %>% filter(ga_p < 0.05)
ga_ses_reg_table_global.t1$ga_p_adj <- p.adjust(ga_ses_reg_table_global.t1$ga_p, method = "BH")
ga_ses_reg_table_global.t1_sig_MC <- ga_ses_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

ga_ses_reg_table_global.t1_sig_MC

#regional regression
ga_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_ses_reg_table_full.t1)), name_mapping$abbreviation)]

ga_ses_reg_table_full.t1_sig <- ga_ses_reg_table_full.t1 %>% filter(ga_p < 0.05)
ga_ses_reg_table_full.t1$ga_p_adj <- p.adjust(ga_ses_reg_table_full.t1$ga_p, method = "BH")
ga_ses_reg_table_full.t1_sig_MC <- ga_ses_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "ga_ses_regional_t1.csv")
write.csv(ga_ses_reg_table_global.t1, filename_global)
write.csv(ga_ses_reg_table_full.t1, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_ses_reg_table_full.t1_sig_MC[!(ga_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(ga_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.ga_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, T1"))

(t1.ga_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_ses_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_ses_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.ga_ses_dkt_plot, "ga_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.ga_ses_aseg_plot, "ga_ses_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$birth_weight_oz_sum_adj) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)

#Global regression
bw_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_ses_reg_table_global.t1)), name_mapping$abbreviation)]

bw_ses_table_global.t1_sig <- bw_ses_reg_table_global.t1 %>% filter(bw_p < 0.05)
bw_ses_reg_table_global.t1$bw_p_adj <- p.adjust(bw_ses_reg_table_global.t1$bw_p, method = "BH")
bw_ses_reg_table_global.t1_sig_MC <- bw_ses_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

bw_ses_reg_table_global.t1_sig_MC

#regional regression
bw_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_ses_reg_table_full.t1)), name_mapping$abbreviation)]

bw_ses_reg_table_full.t1_sig <- bw_ses_reg_table_full.t1 %>% filter(bw_p < 0.05)
bw_ses_reg_table_full.t1$bw_p_adj <- p.adjust(bw_ses_reg_table_full.t1$bw_p, method = "BH")
bw_ses_reg_table_full.t1_sig_MC <- bw_ses_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_ses_regional_t1.csv")
write.csv(bw_ses_reg_table_global.t1, filename_global)
write.csv(bw_ses_reg_table_full.t1, filename_regional)
}
```
####BW coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_ses_reg_table_full.t1_sig_MC[!(bw_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bw_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, T1"))

(t1.bw_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_ses_reg_table_full.t1_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_ses_reg_table_full.t1_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t1.bw_ses_dkt_plot, "bw_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bw_ses_aseg_plot, "bw_ses_t1_aseg", "pdf", figure_panels_folder)
}
```

###birth weight percentile - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bweight_percentile) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
bwp_zscore <- scale(t1.full_test_df$bweight_percentile)

#Global regression
bwp_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ses_reg_table_global.t1)), name_mapping$abbreviation)]

bwp_ses_table_global.t1_sig <- bwp_ses_reg_table_global.t1 %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_global.t1$bwp_p_adj <- p.adjust(bwp_ses_reg_table_global.t1$bwp_p, method = "BH")
bwp_ses_reg_table_global.t1_sig_MC <- bwp_ses_reg_table_global.t1 %>% filter(bwp_p_adj < 0.05)

bwp_ses_reg_table_global.t1_sig_MC

#regional regression
bwp_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ses_reg_table_full.t1)), name_mapping$abbreviation)]

bwp_ses_reg_table_full.t1_sig <- bwp_ses_reg_table_full.t1 %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_full.t1$bwp_p_adj <- p.adjust(bwp_ses_reg_table_full.t1$bwp_p, method = "BH")
bwp_ses_reg_table_full.t1_sig_MC <- bwp_ses_reg_table_full.t1 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "bwp_ses_regional_t1.csv")
write.csv(bwp_ses_reg_table_global.t1, filename_global)
write.csv(bwp_ses_reg_table_full.t1, filename_regional)
}
```
####bwp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_ses_reg_table_full.t1_sig_MC[!(bwp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bwp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, T1"))

(t1.bwp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_ses_reg_table_full.t1_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_ses_reg_table_full.t1_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t1.bwp_ses_dkt_plot, "bwp_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwp_ses_aseg_plot, "bwp_ses_t1_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bw_pgs) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_ses_reg_table_global.t1)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_global.t1_sig <- bw_pgs_ses_reg_table_global.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_global.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_global.t1$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_global.t1_sig_MC <- bw_pgs_ses_reg_table_global.t1 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_ses_reg_table_global.t1_sig_MC

#Regional Phenotypes
bw_pgs_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[,which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_ses_reg_table_full.t1)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_full.t1_sig <- bw_pgs_ses_reg_table_full.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_full.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_full.t1$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_full.t1_sig_MC <- bw_pgs_ses_reg_table_full.t1 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_pgs_ses_regional_t1.csv")
write.csv(bw_pgs_ses_reg_table_global.t1, filename_global)
write.csv(bw_pgs_ses_reg_table_full.t1, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_ses_reg_table_full.t1_sig_MC[!(bw_pgs_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpgs_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES T1"))

(t1.bwpgs_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_ses_reg_table_full.t1_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_ses_reg_table_full.t1_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t1.bwpgs_ses_dkt_plot, "bw_pgs_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwpgs_ses_aseg_plot, "bw_pgs_ses_t1_aseg", "pdf", figure_panels_folder)
}
```
###Neocomp Total - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$neonatal_comp_total) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)

#Global regression
neocomp_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_ses_reg_table_global.t1)), name_mapping$abbreviation)]

neocomp_ses_table_global.t1_sig <- neocomp_ses_reg_table_global.t1 %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_global.t1$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_global.t1$neocomp_p, method = "BH")
neocomp_ses_reg_table_global.t1_sig_MC <- neocomp_ses_reg_table_global.t1 %>% filter(neocomp_p_adj < 0.05)

neocomp_ses_reg_table_global.t1_sig_MC

#regional regression
neocomp_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_ses_reg_table_full.t1)), name_mapping$abbreviation)]

neocomp_ses_reg_table_full.t1_sig <- neocomp_ses_reg_table_full.t1 %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_full.t1$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_full.t1$neocomp_p, method = "BH")
neocomp_ses_reg_table_full.t1_sig_MC <- neocomp_ses_reg_table_full.t1 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "neocomp_ses_regional_t1.csv")
write.csv(neocomp_ses_reg_table_global.t1, filename_global)
write.csv(neocomp_ses_reg_table_full.t1, filename_regional)
}
```
####Surface plots - neocomp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_ses_reg_table_full.t1_sig_MC[!(neocomp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),] %>% 
  select(c('neocomp_beta', 'neocomp_p_adj', 'label'))

# Plot using ggseg
(t1.neocomp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, T1"))

(t1.neocomp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_ses_reg_table_full.t1_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_ses_reg_table_full.t1_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t1.neocomp_ses_dkt_plot, "neocomp_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.neocomp_ses_aseg_plot, "neocomp_ses_t1_aseg", "pdf", figure_panels_folder)
}
```

###general P-factor - SES as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$General_p.t1) & !is.na(t1.full_test_df$combo.income_ordered) & !is.na(t1.full_test_df$combo.prnt_edu_ordered))
gp_zscore <- scale(t1.full_test_df$General_p.t1)

#Global regression
gp_ses_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_ses_reg_table_global.t1)), name_mapping$abbreviation)]

gp_ses_table_global.t1_sig <- gp_ses_reg_table_global.t1 %>% filter(gp_p < 0.05)
gp_ses_reg_table_global.t1$gp_p_adj <- p.adjust(gp_ses_reg_table_global.t1$gp_p, method = "BH")
gp_ses_reg_table_global.t1_sig_MC <- gp_ses_reg_table_global.t1 %>% filter(gp_p_adj < 0.05)

gp_ses_reg_table_global.t1_sig_MC

#regional regression
gp_ses_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_ses_reg_table_full.t1)), name_mapping$abbreviation)]

gp_ses_reg_table_full.t1_sig <- gp_ses_reg_table_full.t1 %>% filter(gp_p < 0.05)
gp_ses_reg_table_full.t1$gp_p_adj <- p.adjust(gp_ses_reg_table_full.t1$gp_p, method = "BH")
gp_ses_reg_table_full.t1_sig_MC <- gp_ses_reg_table_full.t1 %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_ses_global_t1.csv")
filename_regional <- paste0(output_folder, "gp_ses_regional_t1.csv")
write.csv(gp_ses_reg_table_global.t1, filename_global)
write.csv(gp_ses_reg_table_full.t1, filename_regional)
}
```
####gp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_ses_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_ses_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_ses_reg_table_full.t1_sig_MC[!(gp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(gp_ses_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.gp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, T1"))

(t1.gp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_ses_reg_table_full.t1_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_ses_reg_table_full.t1_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t1.gp_ses_dkt_plot, "gp_ses_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.gp_ses_aseg_plot, "gp_ses_t1_aseg", "pdf", figure_panels_folder)
}
```
###GA - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))

df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t1.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t1.full_test_df$anthroheightcalc)
df$ga_zscore <- scale(t1.full_test_df$gestAge)

#Global phenotypes
ga_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_wh_reg_table_global.t1)), name_mapping$abbreviation)]

ga_wh_reg_table_global.t1_sig <- ga_wh_reg_table_global.t1 %>% filter(ga_p < 0.05)
ga_wh_reg_table_global.t1$ga_p_adj <- p.adjust(ga_wh_reg_table_global.t1$ga_p, method = "BH")
ga_wh_reg_table_global.t1_sig_MC <- ga_wh_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

ga_wh_reg_table_global.t1_sig_MC

#Regional phenotypes
ga_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_wh_reg_table_full.t1)), name_mapping$abbreviation)]

ga_wh_reg_table_full.t1_sig <- ga_wh_reg_table_full.t1 %>% filter(ga_p < 0.05)
ga_wh_reg_table_full.t1$ga_p_adj <- p.adjust(ga_wh_reg_table_full.t1$ga_p, method = "BH")
ga_wh_reg_table_full.t1_sig_MC <- ga_wh_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_wh_global_t1.csv")
filename_regional <- paste0(output_folder, "ga_wh_regional_t1.csv")
write.csv(ga_wh_reg_table_global.t1, filename_global)
write.csv(ga_wh_reg_table_full.t1, filename_regional)
}
```
####surface plots
```{r}
ga_wh_reg_table_full.t1_sig_MC$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_wh_reg_table_full.t1_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_wh_reg_table_full.t1_sig_MC[!(ga_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(ga_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.ga_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, T1"))

(t1.ga_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_wh_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_wh_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.ga_wh_dkt_plot, "ga_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.ga_wh_aseg_plot, "ga_wh_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$birth_weight_oz_sum_adj) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))

df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t1.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t1.full_test_df$anthroheightcalc)
df$bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)

#Global phenotypes
bw_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_wh_reg_table_global.t1)), name_mapping$abbreviation)]

bw_wh_reg_table_global.t1_sig <- bw_wh_reg_table_global.t1 %>% filter(bw_p < 0.05)
bw_wh_reg_table_global.t1$bw_p_adj <- p.adjust(bw_wh_reg_table_global.t1$bw_p, method = "BH")
bw_wh_reg_table_global.t1_sig_MC <- bw_wh_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

bw_wh_reg_table_global.t1_sig_MC

#Regional phenotypes
bw_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_wh_reg_table_full.t1)), name_mapping$abbreviation)]

bw_wh_reg_table_full.t1_sig <- bw_wh_reg_table_full.t1 %>% filter(bw_p < 0.05)
bw_wh_reg_table_full.t1$bw_p_adj <- p.adjust(bw_wh_reg_table_full.t1$bw_p, method = "BH")
bw_wh_reg_table_full.t1_sig_MC <- bw_wh_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_wh_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_wh_regional_t1.csv")
write.csv(bw_wh_reg_table_global.t1, filename_global)
write.csv(bw_wh_reg_table_full.t1, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_wh_reg_table_full.t1_sig_MC[!(bw_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),c("bw_beta", "bw_p_adj", "label")]

# Plot using ggseg
(t1.bw_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, T1"))

(t1.bw_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_wh_reg_table_full.t1_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_wh_reg_table_full.t1_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t1.bw_wh_dkt_plot, "bw_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bw_wh_aseg_plot, "bw_wh_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bweight_percentile) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))

df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t1.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t1.full_test_df$anthroheightcalc)
df$bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)

#Global phenotypes
bwp_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_wh_reg_table_global.t1)), name_mapping$abbreviation)]

bwp_wh_reg_table_global.t1_sig <- bwp_wh_reg_table_global.t1 %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_global.t1$bwp_p_adj <- p.adjust(bwp_wh_reg_table_global.t1$bwp_p, method = "BH")
bwp_wh_reg_table_global.t1_sig_MC <- bwp_wh_reg_table_global.t1 %>% filter(bwp_p_adj < 0.05)

bwp_wh_reg_table_global.t1_sig_MC

#Regional phenotypes
bwp_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_wh_reg_table_full.t1)), name_mapping$abbreviation)]

bwp_wh_reg_table_full.t1_sig <- bwp_wh_reg_table_full.t1 %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_full.t1$bwp_p_adj <- p.adjust(bwp_wh_reg_table_full.t1$bwp_p, method = "BH")
bwp_wh_reg_table_full.t1_sig_MC <- bwp_wh_reg_table_full.t1 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_wh_global_t1.csv")
filename_regional <- paste0(output_folder, "bwp_wh_regional_t1.csv")
write.csv(bwp_wh_reg_table_global.t1, filename_global)
write.csv(bwp_wh_reg_table_full.t1, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_wh_reg_table_full.t1_sig_MC[!(bwp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bwp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),c("bwp_beta", "bwp_p_adj", "label")]

# Plot using ggseg
(t1.bwp_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, T1"))

(t1.bwp_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_wh_reg_table_full.t1_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_wh_reg_table_full.t1_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t1.bwp_wh_dkt_plot, "bwp_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwp_wh_aseg_plot, "bwp_wh_t1_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - wh as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bw_pgs) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t1.full_test_df$anthroweightcalc + t1.full_test_df$anthroheightcalc + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_wh_reg_table_global.t1)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_global.t1_sig <- bw_pgs_wh_reg_table_global.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_global.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_global.t1$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_global.t1_sig_MC <- bw_pgs_wh_reg_table_global.t1 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_wh_reg_table_global.t1_sig_MC

#Regional Phenotypes
bw_pgs_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[,which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t1.full_test_df$combo.income_ordered + t1.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_wh_reg_table_full.t1)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_full.t1_sig <- bw_pgs_wh_reg_table_full.t1 %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_full.t1$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_full.t1$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_full.t1_sig_MC <- bw_pgs_wh_reg_table_full.t1 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-betas_folder
  filename_global <- paste0(output_folder, "bw_pgs_wh_global_t1.csv")
  filename_regional <- paste0(output_folder, "bw_pgs_wh_regional_t1.csv")
  write.csv(bw_pgs_wh_reg_table_global.t1, filename_global)
  write.csv(bw_pgs_wh_reg_table_full.t1, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_wh_reg_table_full.t1_sig_MC[!(bw_pgs_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpgs_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh T1"))

(t1.bwpgs_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_wh_reg_table_full.t1_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_wh_reg_table_full.t1_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t1.bwpgs_wh_dkt_plot, "bw_pgs_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.bwpgs_wh_aseg_plot, "bw_pgs_wh_t1_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal comp - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$neonatal_comp_total) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))

df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t1.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t1.full_test_df$anthroheightcalc)
df$neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)

#Global phenotypes
neocomp_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_wh_reg_table_global.t1)), name_mapping$abbreviation)]

neocomp_wh_reg_table_global.t1_sig <- neocomp_wh_reg_table_global.t1 %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_global.t1$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_global.t1$neocomp_p, method = "BH")
neocomp_wh_reg_table_global.t1_sig_MC <- neocomp_wh_reg_table_global.t1 %>% filter(neocomp_p_adj < 0.05)

neocomp_wh_reg_table_global.t1_sig_MC

#Regional phenotypes
neocomp_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(neocomp_wh_reg_table_full.t1)), name_mapping$abbreviation)]

neocomp_wh_reg_table_full.t1_sig <- neocomp_wh_reg_table_full.t1 %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_full.t1$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_full.t1$neocomp_p, method = "BH")
neocomp_wh_reg_table_full.t1_sig_MC <- neocomp_wh_reg_table_full.t1 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_wh_global_t1.csv")
filename_regional <- paste0(output_folder, "neocomp_wh_regional_t1.csv")
write.csv(neocomp_wh_reg_table_global.t1, filename_global)
write.csv(neocomp_wh_reg_table_full.t1, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_wh_reg_table_full.t1_sig_MC[!(neocomp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),c("neocomp_beta", "neocomp_p_adj", "label")]

# Plot using ggseg
(t1.neocomp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, T1"))

(t1.neocomp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_wh_reg_table_full.t1_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_wh_reg_table_full.t1_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t1.neocomp_wh_dkt_plot, "neocomp_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.neocomp_wh_aseg_plot, "neocomp_wh_t1_aseg", "pdf", figure_panels_folder)
}
```

###General p - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$General_p.t1) & !is.na(t1.full_test_df$anthroweightcalc) & !is.na(t1.full_test_df$anthroheightcalc))

df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t1.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t1.full_test_df$anthroheightcalc)
df$gp_zscore <- scale(t1.full_test_df$General_p.t1)

#Global phenotypes
gp_wh_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_wh_reg_table_global.t1)), name_mapping$abbreviation)]

gp_wh_reg_table_global.t1_sig <- gp_wh_reg_table_global.t1 %>% filter(gp_p < 0.05)
gp_wh_reg_table_global.t1$gp_p_adj <- p.adjust(gp_wh_reg_table_global.t1$gp_p, method = "BH")
gp_wh_reg_table_global.t1_sig_MC <- gp_wh_reg_table_global.t1 %>% filter(gp_p_adj < 0.05)

gp_wh_reg_table_global.t1_sig_MC

#Regional phenotypes
gp_wh_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_wh_reg_table_full.t1)), name_mapping$abbreviation)]

gp_wh_reg_table_full.t1_sig <- gp_wh_reg_table_full.t1 %>% filter(gp_p < 0.05)
gp_wh_reg_table_full.t1$gp_p_adj <- p.adjust(gp_wh_reg_table_full.t1$gp_p, method = "BH")
gp_wh_reg_table_full.t1_sig_MC <- gp_wh_reg_table_full.t1 %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_wh_global_t1.csv")
filename_regional <- paste0(output_folder, "gp_wh_regional_t1.csv")
write.csv(gp_wh_reg_table_global.t1, filename_global)
write.csv(gp_wh_reg_table_full.t1, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_wh_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_wh_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_wh_reg_table_full.t1_sig_MC[!(gp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(gp_wh_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),c("gp_beta", "gp_p_adj", "label")]

# Plot using ggseg
(t1.gp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, T1"))

(t1.gp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_wh_reg_table_full.t1_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_wh_reg_table_full.t1_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t1.gp_wh_dkt_plot, "gp_wh_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.gp_wh_aseg_plot, "gp_wh_t1_aseg", "pdf", figure_panels_folder)
}
```

##T1 - controlling for intracranial volume
###Gestational Age
####linear regressions
```{r}
ga_zscore <- scale(t1.full_test_df$gestAge)
total_volume_zcore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global phenotypes
icv_ga_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_ga_reg_table_global.t1)), name_mapping$abbreviation)]

icv_ga_reg_table_global.t1_sig <- icv_ga_reg_table_global.t1 %>% filter(ga_p < 0.05)
icv_ga_reg_table_global.t1$ga_p_adj <- p.adjust(icv_ga_reg_table_global.t1$ga_p, method = "BH")
icv_ga_reg_table_global.t1_sig_MC <- icv_ga_reg_table_global.t1 %>% filter(ga_p_adj < 0.05)

icv_ga_reg_table_global.t1_sig_MC

#Regional phenotypes
icv_ga_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_ga_reg_table_full.t1)), name_mapping$abbreviation)]

icv_ga_reg_table_full.t1_sig <- icv_ga_reg_table_full.t1 %>% filter(ga_p < 0.05)
icv_ga_reg_table_full.t1$ga_p_adj <- p.adjust(icv_ga_reg_table_full.t1$ga_p, method = "BH")
icv_ga_reg_table_full.t1_sig_MC <- icv_ga_reg_table_full.t1 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_ga_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_icv_all_t1.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "ga_icv_regional_t1.csv")
write.csv(icv_ga_reg_table_global.t1, filename_global)
write.csv(icv_ga_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
ga_reg_table_all.t1 <- rbind(ga_reg_table_global.t1, ga_reg_table_full.t1)
icv_ga_reg_table_all.t1 <- rbind(icv_ga_reg_table_global.t1, icv_ga_reg_table_full.t1)
#all phenotypes
#univariate x~ga regression
ga_reg_table_all.t1$ga_lower <- (ga_reg_table_all.t1$ga_beta - 1.96*ga_reg_table_all.t1$ga_se)
ga_reg_table_all.t1$ga_upper <- (ga_reg_table_all.t1$ga_beta + 1.96*ga_reg_table_all.t1$ga_se)
ga_reg_table_all.t1 <- ga_reg_table_all.t1 %>% mutate(lm = "ga_uni")

#multivariate x~ga*bw regression, significant for ga_beta
icv_ga_reg_table_all.t1$ga_lower <- (icv_ga_reg_table_all.t1$ga_beta - 1.96*icv_ga_reg_table_all.t1$ga_se)
icv_ga_reg_table_all.t1$ga_upper <- (icv_ga_reg_table_all.t1$ga_beta + 1.96*icv_ga_reg_table_all.t1$ga_se)
icv_ga_reg_table_all.t1_plot <- icv_ga_reg_table_all.t1 %>% mutate(lm = "ga_icv") %>% select(all_of(names(ga_reg_table_all.t1)))
#combine tables
combined_reg_table <- rbind(ga_reg_table_all.t1, icv_ga_reg_table_all.t1_plot)

#add a TRUE/FALSE column for ga_beta in the SAME direction, and for ga_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(ga_reg_table_all.t1, icv_ga_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$ga_beta_uni) == sign(wide_combined_reg_table$ga_beta_icv)) & wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$ga_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = ga_beta, xmin = ga_lower, xmax = ga_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("ga_uni" = "grey", "ga_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "ga_beta_uni", "ga_p_adj_uni", "ga_beta_icv", "ga_p_adj_icv")]

(t1.icv_ga_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, T1"))

(t1.icv_ga_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'ga_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_ga_survive_dkt_plot, "icv_ga_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_ga_survive_aseg_plot, "icv_ga_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_ga_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_ga_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_ga_reg_table_full.t1_sig_MC[!(icv_ga_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_ga_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_ga_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, T1"))

(t1.icv_ga_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_ga_reg_table_full.t1_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_ga_reg_table_full.t1_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_ga_full_dkt_plot, "icv_ga_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_ga_full_aseg_plot, "icv_ga_full_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight
####linear regressions
```{r}
df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$bw_zscore <- scale(t1.full_test_df$birth_weight_oz_sum_adj)
df$total_volume_zcore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global phenotypes -- save betas and p-values
icv_bw_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bw_reg_table_global.t1)), name_mapping$abbreviation)]

icv_bw_reg_table_global.t1_sig <- icv_bw_reg_table_global.t1 %>% filter(bw_p < 0.05)
icv_bw_reg_table_global.t1$bw_p_adj <- p.adjust(icv_bw_reg_table_global.t1$bw_p, method = "BH")
icv_bw_reg_table_global.t1_sig_MC <- icv_bw_reg_table_global.t1 %>% filter(bw_p_adj < 0.05)

icv_bw_reg_table_global.t1_sig_MC

#Regional phenotypes -- save betas and p-values
icv_bw_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bw_reg_table_full.t1)), name_mapping$abbreviation)]

icv_bw_reg_table_full.t1_sig <- icv_bw_reg_table_full.t1 %>% filter(bw_p < 0.05)
icv_bw_reg_table_full.t1$bw_p_adj <- p.adjust(icv_bw_reg_table_full.t1$bw_p, method = "BH")
icv_bw_reg_table_full.t1_sig_MC <- icv_bw_reg_table_full.t1 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_icv_all_t1.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_icv_sig_t1.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_icv_regional_t1.csv")
write.csv(icv_bw_reg_table_global.t1, filename_global)
write.csv(icv_bw_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_reg_table_all.t1 <- rbind(bw_reg_table_global.t1, bw_reg_table_full.t1)
icv_bw_reg_table_all.t1 <- rbind(icv_bw_reg_table_global.t1, icv_bw_reg_table_full.t1)
#all phenotypes
#univariate x~ga regression
bw_reg_table_all.t1$bw_lower <- (bw_reg_table_all.t1$bw_beta - 1.96*bw_reg_table_all.t1$bw_se)
bw_reg_table_all.t1$bw_upper <- (bw_reg_table_all.t1$bw_beta + 1.96*bw_reg_table_all.t1$bw_se)
bw_reg_table_all.t1 <- bw_reg_table_all.t1 %>% mutate(lm = "bw_uni")

#multivariate x~ga*bw regression, significant for bw_beta
icv_bw_reg_table_all.t1$bw_lower <- (icv_bw_reg_table_all.t1$bw_beta - 1.96*icv_bw_reg_table_all.t1$bw_se)
icv_bw_reg_table_all.t1$bw_upper <- (icv_bw_reg_table_all.t1$bw_beta + 1.96*icv_bw_reg_table_all.t1$bw_se)
icv_bw_reg_table_all.t1_plot <- icv_bw_reg_table_all.t1 %>% mutate(lm = "bw_icv") %>% select(all_of(names(bw_reg_table_all.t1)))
#combine tables
combined_reg_table <- rbind(bw_reg_table_all.t1, icv_bw_reg_table_all.t1_plot)

#add a TRUE/FALSE column for bw_beta in the SAME direction, and for bw_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_reg_table_all.t1, icv_bw_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_beta_uni) == sign(wide_combined_reg_table$bw_beta_icv)) & wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$bw_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = bw_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_uni" = "grey", "bw_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_beta_uni", "bw_p_adj_uni", "bw_beta_icv", "bw_p_adj_icv")]

(t1.icv_bw_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, T1"))

(t1.icv_bw_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_bw_survive_dkt_plot, "icv_bw_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bw_survive_aseg_plot, "icv_bw_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_reg_table_full.t1_sig_MC[!(icv_bw_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_bw_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, T1"))

(t1.icv_bw_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_reg_table_full.t1_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_reg_table_full.t1_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_bw_full_dkt_plot, "icv_bw_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bw_full_aseg_plot, "icv_bw_full_t1_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile
####linear regressions
```{r}
bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)
total_volume_zcore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global Phenotypes
icv_bwp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bwp_reg_table_global.t1)), name_mapping$abbreviation)]

icv_bwp_reg_table_global.t1_sig <- icv_bwp_reg_table_global.t1 %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_global.t1$bwp_p_adj <- p.adjust(icv_bwp_reg_table_global.t1$bwp_p, method = "BH")
icv_bwp_reg_table_global.t1_sig_MC <- icv_bwp_reg_table_global.t1 %>% filter(bwp_p_adj < 0.05)

icv_bwp_reg_table_global.t1_sig_MC

#Regional Phenotypes
icv_bwp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bwp_reg_table_full.t1)), name_mapping$abbreviation)]

icv_bwp_reg_table_full.t1_sig <- icv_bwp_reg_table_full.t1 %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_full.t1$bwp_p_adj <- p.adjust(icv_bwp_reg_table_full.t1$bwp_p, method = "BH")
icv_bwp_reg_table_full.t1_sig_MC <- icv_bwp_reg_table_full.t1 %>% filter(bwp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bwp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_icv_all_t1.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "bwp_icv_regional_t1.csv")
write.csv(icv_bwp_reg_table_global.t1, filename_global)
write.csv(icv_bwp_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bwp_reg_table_all.t1 <- rbind(bwp_reg_table_global.t1, bwp_reg_table_full.t1)
icv_bwp_reg_table_all.t1 <- rbind(icv_bwp_reg_table_global.t1, icv_bwp_reg_table_full.t1)
#all phenotypes
#univariate x~bwp regression
bwp_reg_table_all.t1$bwp_lower <- (bwp_reg_table_all.t1$bwp_beta - 1.96*bwp_reg_table_all.t1$bwp_se)
bwp_reg_table_all.t1$bwp_upper <- (bwp_reg_table_all.t1$bwp_beta + 1.96*bwp_reg_table_all.t1$bwp_se)
bwp_reg_table_all.t1 <- bwp_reg_table_all.t1 %>% mutate(lm = "bwp_uni")

#multivariate x~bwp*bw regression, significant for bwp_beta
icv_bwp_reg_table_all.t1$bwp_lower <- (icv_bwp_reg_table_all.t1$bwp_beta - 1.96*icv_bwp_reg_table_all.t1$bwp_se)
icv_bwp_reg_table_all.t1$bwp_upper <- (icv_bwp_reg_table_all.t1$bwp_beta + 1.96*icv_bwp_reg_table_all.t1$bwp_se)
icv_bwp_reg_table_all.t1_plot <- icv_bwp_reg_table_all.t1 %>% mutate(lm = "bwp_icv") %>% select(all_of(names(bwp_reg_table_all.t1)))
#combine tables
combined_bwp_reg_table <- rbind(bwp_reg_table_all.t1, icv_bwp_reg_table_all.t1_plot)

#add a TRUE/FALSE column for bwp_beta in the SAME direction, and for bwp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bwp_reg_table_all.t1, icv_bwp_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bwp_beta_uni) == sign(wide_combined_reg_table$bwp_beta_icv)) & wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$bwp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bwp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bwp_reg_table)),], aes(y = label, x = bwp_beta, xmin = bwp_lower, xmax = bwp_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bwp_uni" = "grey", "bwp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bwp_beta_uni", "bwp_p_adj_uni", "bwp_beta_icv", "bwp_p_adj_icv")]

(t1.icv_bwp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, T1"))

(t1.icv_bwp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bwp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_bwp_survive_dkt_plot, "icv_bwp_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bwp_survive_aseg_plot, "icv_bwp_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bwp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bwp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bwp_reg_table_full.t1_sig_MC[!(icv_bwp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_bwp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_bwp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, T1"))

(t1.icv_bwp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bwp_reg_table_full.t1_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bwp_reg_table_full.t1_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_bwp_full_dkt_plot, "icv_bwp_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bwp_full_aseg_plot, "icv_bwp_full_t1_aseg", "pdf", figure_panels_folder)
}
```
###PRS-bw
####linear regressions
```{r}
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
total_volume_zscore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global Phenotypes
icv_bw_pgs_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bw_pgs_reg_table_global.t1)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_global.t1_sig <- icv_bw_pgs_reg_table_global.t1 %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_global.t1$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_global.t1$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_global.t1_sig_MC <- icv_bw_pgs_reg_table_global.t1 %>% filter(bw_pgs_p_adj < 0.05)

icv_bw_pgs_reg_table_global.t1_sig_MC

#Regional Phenotypes
icv_bw_pgs_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[,which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_bw_pgs_reg_table_full.t1)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_full.t1_sig <- icv_bw_pgs_reg_table_full.t1 %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_full.t1$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_full.t1$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_full.t1_sig_MC <- icv_bw_pgs_reg_table_full.t1 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_pgs_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_icv_all_t1.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "bw_pgs_icv_regional_t1.csv")
write.csv(icv_bw_pgs_reg_table_global.t1, filename_global)
write.csv(icv_bw_pgs_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_pgs_reg_table_all.t1 <- rbind(bw_pgs_reg_table_global.t1, bw_pgs_reg_table_full.t1)
icv_bw_pgs_reg_table_all.t1 <- rbind(icv_bw_pgs_reg_table_global.t1, icv_bw_pgs_reg_table_full.t1)
#all phenotypes
#univariate x~bw_pgs regression
bw_pgs_reg_table_all.t1$bw_lower <- (bw_pgs_reg_table_all.t1$bw_pgs_beta - 1.96*bw_pgs_reg_table_all.t1$bw_pgs_se)
bw_pgs_reg_table_all.t1$bw_upper <- (bw_pgs_reg_table_all.t1$bw_pgs_beta + 1.96*bw_pgs_reg_table_all.t1$bw_pgs_se)
bw_pgs_reg_table_all.t1 <- bw_pgs_reg_table_all.t1 %>% mutate(lm = "bw_pgs_uni")

#multivariate x~bw_pgs*bw regression, significant for bw_pgs_beta
icv_bw_pgs_reg_table_all.t1$bw_lower <- (icv_bw_pgs_reg_table_all.t1$bw_pgs_beta - 1.96*icv_bw_pgs_reg_table_all.t1$bw_pgs_se)
icv_bw_pgs_reg_table_all.t1$bw_upper <- (icv_bw_pgs_reg_table_all.t1$bw_pgs_beta + 1.96*icv_bw_pgs_reg_table_all.t1$bw_pgs_se)
icv_bw_pgs_reg_table_all.t1_plot <- icv_bw_pgs_reg_table_all.t1 %>% mutate(lm = "bw_pgs_icv") %>% select(all_of(names(bw_pgs_reg_table_all.t1)))
#combine tables
combined_bw_pgs_reg_table <- rbind(bw_pgs_reg_table_all.t1, icv_bw_pgs_reg_table_all.t1_plot)

#add a TRUE/FALSE column for bw_pgs_beta in the SAME direction, and for bw_pgs_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_pgs_reg_table_all.t1, icv_bw_pgs_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_pgs_beta_uni) == sign(wide_combined_reg_table$bw_pgs_beta_icv)) & wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$bw_pgs_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bw_pgs_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bw_pgs_reg_table)),], aes(y = label, x = bw_pgs_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_pgs_uni" = "grey", "bw_pgs_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")
```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_pgs_beta_uni", "bw_pgs_p_adj_uni", "bw_pgs_beta_icv", "bw_pgs_p_adj_icv")]

(t1.icv_bw_pgs_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, T1"))

(t1.icv_bw_pgs_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_pgs_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_bw_pgs_survive_dkt_plot, "icv_bw_pgs_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bw_pgs_survive_aseg_plot, "icv_bw_pgs_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_pgs_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_pgs_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_pgs_reg_table_full.t1_sig_MC[!(icv_bw_pgs_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_pgs_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_bw_pgs_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, T1"))

(t1.icv_bw_pgs_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_pgs_reg_table_full.t1_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_pgs_reg_table_full.t1_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_bw_pgs_full_dkt_plot, "icv_bw_pgs_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_bw_pgs_full_aseg_plot, "icv_bw_pgs_full_t1_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal Comp
####linear regressions
```{r}
neocomp_zscore <- scale(t1.full_test_df$neonatal_comp_total)
total_volume_zscore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global Phenotypes
icv_neocomp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_neocomp_reg_table_global.t1)), name_mapping$abbreviation)]

icv_neocomp_reg_table_global.t1_sig <- icv_neocomp_reg_table_global.t1 %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_global.t1$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_global.t1$neocomp_p, method = "BH")
icv_neocomp_reg_table_global.t1_sig_MC <- icv_neocomp_reg_table_global.t1 %>% filter(neocomp_p_adj < 0.05)

icv_neocomp_reg_table_global.t1_sig_MC

#Regional Phenotypes
icv_neocomp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_neocomp_reg_table_full.t1)), name_mapping$abbreviation)]

icv_neocomp_reg_table_full.t1_sig <- icv_neocomp_reg_table_full.t1 %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_full.t1$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_full.t1$neocomp_p, method = "BH")
icv_neocomp_reg_table_full.t1_sig_MC <- icv_neocomp_reg_table_full.t1 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "neocomp_icv_regional_t1.csv")
write.csv(icv_neocomp_reg_table_global.t1, filename_global)
write.csv(icv_neocomp_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
neocomp_reg_table_all.t1 <- rbind(neocomp_reg_table_global.t1, neocomp_reg_table_full.t1)
icv_neocomp_reg_table_all.t1 <- rbind(icv_neocomp_reg_table_global.t1, icv_neocomp_reg_table_full.t1)
#all phenotypes
#univariate x~neocomp regression
neocomp_reg_table_all.t1$bw_lower <- (neocomp_reg_table_all.t1$neocomp_beta - 1.96*neocomp_reg_table_all.t1$neocomp_se)
neocomp_reg_table_all.t1$bw_upper <- (neocomp_reg_table_all.t1$neocomp_beta + 1.96*neocomp_reg_table_all.t1$neocomp_se)
neocomp_reg_table_all.t1 <- neocomp_reg_table_all.t1 %>% mutate(lm = "neocomp_uni")

#multivariate x~neocomp*bw regression, significant for neocomp_beta
icv_neocomp_reg_table_all.t1$bw_lower <- (icv_neocomp_reg_table_all.t1$neocomp_beta - 1.96*icv_neocomp_reg_table_all.t1$neocomp_se)
icv_neocomp_reg_table_all.t1$bw_upper <- (icv_neocomp_reg_table_all.t1$neocomp_beta + 1.96*icv_neocomp_reg_table_all.t1$neocomp_se)
icv_neocomp_reg_table_all.t1_plot <- icv_neocomp_reg_table_all.t1 %>% mutate(lm = "neocomp_icv") %>% select(all_of(names(neocomp_reg_table_all.t1)))
#combine tables
combined_neocomp_reg_table <- rbind(neocomp_reg_table_all.t1, icv_neocomp_reg_table_all.t1_plot)

#add a TRUE/FALSE column for neocomp_beta in the SAME direction, and for neocomp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(neocomp_reg_table_all.t1, icv_neocomp_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$neocomp_beta_uni) == sign(wide_combined_reg_table$neocomp_beta_icv)) & wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$neocomp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_neocomp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_neocomp_reg_table)),], aes(y = label, x = neocomp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
  geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
  ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("neocomp_uni" = "grey", "neocomp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "neocomp_beta_uni", "neocomp_p_adj_uni", "neocomp_beta_icv", "neocomp_p_adj_icv")]

(t1.icv_neocomp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, T1"))

(t1.icv_neocomp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'neocomp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_neocomp_survive_dkt_plot, "icv_neocomp_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_neocomp_survive_aseg_plot, "icv_neocomp_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_neocomp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_neocomp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_neocomp_reg_table_full.t1_sig_MC[!(icv_neocomp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_neocomp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_neocomp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, T1"))

(t1.icv_neocomp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_neocomp_reg_table_full.t1_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_neocomp_reg_table_full.t1_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_neocomp_full_dkt_plot, "icv_neocomp_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_neocomp_full_aseg_plot, "icv_neocomp_full_t1_aseg", "pdf", figure_panels_folder)
}
```
###general P-factor
####linear regressions
```{r}
gp_zscore <- scale(t1.full_test_df$General_p.t1)
total_volume_zscore <- qnorm(t1.full_test_df$smri_vol_scs_intracranialv.t1_centiles)

#Global Phenotypes
icv_gp_reg_table_global.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

icv_gp_reg_table_global.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_gp_reg_table_global.t1)), name_mapping$abbreviation)]

icv_gp_reg_table_global.t1_sig <- icv_gp_reg_table_global.t1 %>% filter(gp_p < 0.05)
icv_gp_reg_table_global.t1$gp_p_adj <- p.adjust(icv_gp_reg_table_global.t1$gp_p, method = "BH")
icv_gp_reg_table_global.t1_sig_MC <- icv_gp_reg_table_global.t1 %>% filter(gp_p_adj < 0.05)

icv_gp_reg_table_global.t1_sig_MC

#Regional Phenotypes
icv_gp_reg_table_full.t1 <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

icv_gp_reg_table_full.t1$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(icv_gp_reg_table_full.t1)), name_mapping$abbreviation)]

icv_gp_reg_table_full.t1_sig <- icv_gp_reg_table_full.t1 %>% filter(gp_p < 0.05)
icv_gp_reg_table_full.t1$gp_p_adj <- p.adjust(icv_gp_reg_table_full.t1$gp_p, method = "BH")
icv_gp_reg_table_full.t1_sig_MC <- icv_gp_reg_table_full.t1 %>% filter(gp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_gp_reg_table_full.t1
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gp_icv_all_t1.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_icv_global_t1.csv")
filename_regional <- paste0(output_folder, "gp_icv_regional_t1.csv")
write.csv(icv_gp_reg_table_global.t1, filename_global)
write.csv(icv_gp_reg_table_full.t1, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
gp_reg_table_all.t1 <- rbind(gp_reg_table_global.t1, gp_reg_table_full.t1)
icv_gp_reg_table_all.t1 <- rbind(icv_gp_reg_table_global.t1, icv_gp_reg_table_full.t1)
#all phenotypes
#univariate x~gp regression
gp_reg_table_all.t1$bw_lower <- (gp_reg_table_all.t1$gp_beta - 1.96*gp_reg_table_all.t1$gp_se)
gp_reg_table_all.t1$bw_upper <- (gp_reg_table_all.t1$gp_beta + 1.96*gp_reg_table_all.t1$gp_se)
gp_reg_table_all.t1 <- gp_reg_table_all.t1 %>% mutate(lm = "gp_uni")

#multivariate x~gp*bw regression, significant for gp_beta
icv_gp_reg_table_all.t1$bw_lower <- (icv_gp_reg_table_all.t1$gp_beta - 1.96*icv_gp_reg_table_all.t1$gp_se)
icv_gp_reg_table_all.t1$bw_upper <- (icv_gp_reg_table_all.t1$gp_beta + 1.96*icv_gp_reg_table_all.t1$gp_se)
icv_gp_reg_table_all.t1_plot <- icv_gp_reg_table_all.t1 %>% mutate(lm = "gp_icv") %>% select(all_of(names(gp_reg_table_all.t1)))
#combine tables
combined_gp_reg_table <- rbind(gp_reg_table_all.t1, icv_gp_reg_table_all.t1_plot)

#add a TRUE/FALSE column for gp_beta in the SAME direction, and for gp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(gp_reg_table_all.t1, icv_gp_reg_table_all.t1, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$gp_beta_uni) == sign(wide_combined_reg_table$gp_beta_icv)) & wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$gp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_gp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_gp_reg_table)),], aes(y = label, x = gp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("gp_uni" = "grey", "gp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "gp_beta_uni", "gp_p_adj_uni", "gp_beta_icv", "gp_p_adj_icv")]

(t1.icv_gp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, survive after controlling for icv, T1"))

(t1.icv_gp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, survive after controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t1_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t1_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'gp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t1.icv_gp_survive_dkt_plot, "icv_gp_survive_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_gp_survive_aseg_plot, "icv_gp_survive_t1_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_gp_reg_table_full.t1_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_gp_reg_table_full.t1_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_gp_reg_table_full.t1_sig_MC[!(icv_gp_reg_table_full.t1_sig_MC$label %in% plot_data_dkt$label) & !(icv_gp_reg_table_full.t1_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.icv_gp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, full controlling for icv, T1"))

(t1.icv_gp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, full controlling for icv, T1"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_gp_reg_table_full.t1_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_gp_reg_table_full.t1_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t1.icv_gp_full_dkt_plot, "icv_gp_full_t1_dkt", "pdf", figure_panels_folder)
panel_save(t1.icv_gp_full_aseg_plot, "icv_gp_full_t1_aseg", "pdf", figure_panels_folder)
}
```
##T2
###Gestational Age
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge))
ga_zscore <- scale(t2.full_test_df$gestAge)

#Global phenotypes
ga_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_reg_table_global.t2)), name_mapping$abbreviation)]

ga_reg_table_global.t2_sig <- ga_reg_table_global.t2 %>% filter(ga_p < 0.05)
ga_reg_table_global.t2$ga_p_adj <- p.adjust(ga_reg_table_global.t2$ga_p, method = "BH")
ga_reg_table_global.t2_sig_MC <- ga_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

ga_reg_table_global.t2_sig_MC

#Regional phenotypes
ga_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_reg_table_full.t2)), name_mapping$abbreviation)]

ga_reg_table_full.t2_sig <- ga_reg_table_full.t2 %>% filter(ga_p < 0.05)
ga_reg_table_full.t2$ga_p_adj <- p.adjust(ga_reg_table_full.t2$ga_p, method = "BH")
ga_reg_table_full.t2_sig_MC <- ga_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_all_t2.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_global_t2.csv")
filename_regional <- paste0(output_folder, "ga_regional_t2.csv")
write.csv(ga_reg_table_global.t2, filename_global)
write.csv(ga_reg_table_full.t2, filename_regional)
}
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t2_sig_MC[!(ga_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t2.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void()+
  labs(title = "GA t2"))

(t2.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.ga_dkt_plot, "ga_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.ga_aseg_plot, "ga_t2_aseg", "pdf", figure_panels_folder)
}
```
###Gestational Age - 38 week sensitivity
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge_38term))
ga_zscore <- scale(t2.full_test_df$gestAge_38term)

#Global phenotypes
ga_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_reg_table_global.t2)), name_mapping$abbreviation)]

ga_reg_table_global.t2_sig <- ga_reg_table_global.t2 %>% filter(ga_p < 0.05)
ga_reg_table_global.t2$ga_p_adj <- p.adjust(ga_reg_table_global.t2$ga_p, method = "BH")
ga_reg_table_global.t2_sig_MC <- ga_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

ga_reg_table_global.t2_sig_MC

#Regional phenotypes
ga_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_reg_table_full.t2)), name_mapping$abbreviation)]

ga_reg_table_full.t2_sig <- ga_reg_table_full.t2 %>% filter(ga_p < 0.05)
ga_reg_table_full.t2$ga_p_adj <- p.adjust(ga_reg_table_full.t2$ga_p, method = "BH")
ga_reg_table_full.t2_sig_MC <- ga_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_38term_all_t2.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga38term_global_t2.csv")
filename_regional <- paste0(output_folder, "ga38term_regional_t2.csv")
write.csv(ga_reg_table_global.t2, filename_global)
write.csv(ga_reg_table_full.t2, filename_regional)
}
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t2_sig_MC[!(ga_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t2.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void()+
  labs(title = "GA 38 week term t2"))

(t2.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA 38 week term t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.ga_dkt_plot, "ga_38term_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.ga_aseg_plot, "ga_38term_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$birth_weight_oz_sum_adj))
df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)

#Global models save
bw_global_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})
  
#Global phenotypes -- save betas and p-values
bw_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_global.t2)), name_mapping$abbreviation)]

bw_reg_table_global.t2_sig <- bw_reg_table_global.t2 %>% filter(bw_p < 0.05)
bw_reg_table_global.t2$bw_p_adj <- p.adjust(bw_reg_table_global.t2$bw_p, method = "BH")
bw_reg_table_global.t2_sig_MC <- bw_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

bw_reg_table_global.t2_sig_MC

#Regional models save
bw_regional_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})

#Regional phenotypes -- save betas and p-values
bw_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_full.t2)), name_mapping$abbreviation)]

bw_reg_table_full.t2_sig <- bw_reg_table_full.t2 %>% filter(bw_p < 0.05)
bw_reg_table_full.t2$bw_p_adj <- p.adjust(bw_reg_table_full.t2$bw_p, method = "BH")
bw_reg_table_full.t2_sig_MC <- bw_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_regional_t2.csv")
write.csv(bw_reg_table_global.t2, filename_global)
write.csv(bw_reg_table_full.t2, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full.t2_sig_MC[!(bw_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW t2"))

(t2.bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_reg_table_full.t2_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_reg_table_full.t2_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t2.bw_dkt_plot, "bw_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bw_aseg_plot, "bw_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bweight_percentile))
bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)

#Global Phenotypes
bwp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_reg_table_global.t2)), name_mapping$abbreviation)]

bwp_reg_table_global.t2_sig <- bwp_reg_table_global.t2 %>% filter(bwp_p < 0.05)
bwp_reg_table_global.t2$bwp_p_adj <- p.adjust(bwp_reg_table_global.t2$bwp_p, method = "BH")
bwp_reg_table_global.t2_sig_MC <- bwp_reg_table_global.t2 %>% filter(bwp_p_adj < 0.05)

bwp_reg_table_global.t2_sig_MC

#Regional Phenotypes
bwp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_reg_table_full.t2)), name_mapping$abbreviation)]

bwp_reg_table_full.t2_sig <- bwp_reg_table_full.t2 %>% filter(bwp_p < 0.05)
bwp_reg_table_full.t2$bwp_p_adj <- p.adjust(bwp_reg_table_full.t2$bwp_p, method = "BH")
bwp_reg_table_full.t2_sig_MC <- bwp_reg_table_full.t2 %>% filter(bwp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bwp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bwp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightpercentile_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_global_t2.csv")
filename_regional <- paste0(output_folder, "bwp_regional_t2.csv")
write.csv(bwp_reg_table_global.t2, filename_global)
write.csv(bwp_reg_table_full.t2, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_reg_table_full.t2_sig_MC[!(bwp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bwp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp t2"))

(t2.bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_reg_table_full.t2_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_reg_table_full.t2_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t2.bwp_dkt_plot, "bwp_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwp_aseg_plot, "bwp_t2_aseg", "pdf", figure_panels_folder)
}
```
###PRS-bw
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_reg_table_global.t2)), name_mapping$abbreviation)]

bw_pgs_reg_table_global.t2_sig <- bw_pgs_reg_table_global.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_global.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_global.t2$bw_pgs_p, method = "BH")
bw_pgs_reg_table_global.t2_sig_MC <- bw_pgs_reg_table_global.t2 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_reg_table_global.t2_sig_MC

#Regional Phenotypes
bw_pgs_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[,which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_reg_table_full.t2)), name_mapping$abbreviation)]

bw_pgs_reg_table_full.t2_sig <- bw_pgs_reg_table_full.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full.t2$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full.t2_sig_MC <- bw_pgs_reg_table_full.t2 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_pgs_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightPGS_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_pgs_regional_t2.csv")
write.csv(bw_pgs_reg_table_global.t2, filename_global)
write.csv(bw_pgs_reg_table_full.t2, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full.t2_sig_MC[!(bw_pgs_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs t2"))

(t2.bwpgs_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_reg_table_full.t2_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_reg_table_full.t2_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t2.bwpgs_dkt_plot, "bw_pgs_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwpgs_aseg_plot, "bw_pgs_t2_aseg", "pdf", figure_panels_folder)
}
```
####correlations with bw
- spin test in Python using neuromaps package
```{r}
bw_bwpgs.t2 <- merge(bw_pgs_reg_table_full.t2, bw_reg_table_full.t2, by = c("label"))
#all regions
plot(bw_bwpgs.t2$bw_beta, bw_bwpgs.t2$bw_pgs_beta)
cor.test(bw_bwpgs.t2$bw_beta, bw_bwpgs.t2$bw_pgs_beta)
#only significant post-FDR in both
bw_bwpgs.t2_sig <- bw_bwpgs.t2 %>% filter(bw_p_adj < 0.05 & bw_pgs_p_adj < 0.05)
if(dim(bw_bwpgs.t2_sig)[1] > 0 ){
  plot(bw_bwpgs.t2_sig$bw_beta, bw_bwpgs.t2_sig$bw_pgs_beta)
  cor.test(bw_bwpgs.t2_sig$bw_beta, bw_bwpgs.t2_sig$bw_pgs_beta)
}
```
###Neonatal complications
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$neonatal_comp_total))
neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)

#Global Phenotypes
neocomp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ neocomp_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_reg_table_global.t2)), name_mapping$abbreviation)]

neocomp_reg_table_global.t2_sig <- neocomp_reg_table_global.t2 %>% filter(neocomp_p < 0.05)
neocomp_reg_table_global.t2$neocomp_p_adj <- p.adjust(neocomp_reg_table_global.t2$neocomp_p, method = "BH")
neocomp_reg_table_global.t2_sig_MC <- neocomp_reg_table_global.t2 %>% filter(neocomp_p_adj < 0.05)

neocomp_reg_table_global.t2_sig_MC

#Regional Phenotypes
neocomp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ neocomp_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_reg_table_full.t2)), name_mapping$abbreviation)]

neocomp_reg_table_full.t2_sig <- neocomp_reg_table_full.t2 %>% filter(neocomp_p < 0.05)
neocomp_reg_table_full.t2$neocomp_p_adj <- p.adjust(neocomp_reg_table_full.t2$neocomp_p, method = "BH")
neocomp_reg_table_full.t2_sig_MC <- neocomp_reg_table_full.t2 %>% filter(neocomp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- neocomp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "neocomp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_neocomp_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_neocomp_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_global_t2.csv")
filename_regional <- paste0(output_folder, "neocomp_regional_t2.csv")
write.csv(neocomp_reg_table_global.t2, filename_global)
write.csv(neocomp_reg_table_full.t2, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_reg_table_full.t2_sig_MC[!(neocomp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),] %>% 
  select(c('neocomp_beta', 'neocomp_p_adj', 'label'))

# Plot using ggseg
(t2.neocomp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",                        limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp t2"))

(t2.neocomp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",                        limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_reg_table_full.t2_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_reg_table_full.t2_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t2.neocomp_dkt_plot, "neocomp_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.neocomp_aseg_plot, "neocomp_t2_aseg", "pdf", figure_panels_folder)
}
```
###general P-factor
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p.t2))
gp_zscore <- scale(t2.full_test_df$General_p.t2)

#Global Phenotypes
gp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_global.t2)), name_mapping$abbreviation)]

gp_reg_table_global.t2_sig <- gp_reg_table_global.t2 %>% filter(gp_p < 0.05)
gp_reg_table_global.t2$gp_p_adj <- p.adjust(gp_reg_table_global.t2$gp_p, method = "BH")
gp_reg_table_global.t2_sig_MC <- gp_reg_table_global.t2 %>% filter(gp_p_adj < 0.05)

gp_reg_table_global.t2_sig_MC

#Regional Phenotypes
gp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_full.t2)), name_mapping$abbreviation)]

gp_reg_table_full.t2_sig <- gp_reg_table_full.t2 %>% filter(gp_p < 0.05)
gp_reg_table_full.t2$gp_p_adj <- p.adjust(gp_reg_table_full.t2$gp_p, method = "BH")
gp_reg_table_full.t2_sig_MC <- gp_reg_table_full.t2 %>% filter(gp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- gp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_gp_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_gp_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_global_t2.csv")
filename_regional <- paste0(output_folder, "gp_regional_t2.csv")
write.csv(gp_reg_table_global.t2, filename_global)
write.csv(gp_reg_table_full.t2, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full.t2_sig_MC[!(gp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "P-factor t2"))

(t2.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
 scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "P-factor t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_reg_table_full.t2_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_reg_table_full.t2_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t2.gp_dkt_plot, "gp_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.gp_aseg_plot, "gp_t2_aseg", "pdf", figure_panels_folder)
}
```

###General P-factor - change in P-factor -- including baseline P-factor as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p_change) & !is.na(t2.full_test_df$General_p.t2))
gp_change_zscore <- scale(t2.full_test_df$General_p_change)
gp_change_baseline_zscore <- scale(t2.full_test_df$General_p.t2)

#Global Phenotypes
gp_change_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_change_zscore + gp_change_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_change_beta = summary$coefficients[2,1], gp_change_p = summary$coefficients[2,4], gp_change_se = summary$coefficients[2,2],gp_change_base_beta = summary$coefficients[3,1], gp_change_base_p = summary$coefficients[3,4], gp_change_base_se = summary$coefficients[3,2])
})))

gp_change_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_change_reg_table_global.t2)), name_mapping$abbreviation)]

gp_change_reg_table_global.t2_sig <- gp_change_reg_table_global.t2 %>% filter(gp_change_p < 0.05)
gp_change_reg_table_global.t2$gp_change_p_adj <- p.adjust(gp_change_reg_table_global.t2$gp_change_p, method = "BH")
gp_change_reg_table_global.t2$gp_change_base_p_adj <- p.adjust(gp_change_reg_table_global.t2$gp_change_base_p, method = "BH")
gp_change_reg_table_global.t2_sig_MC <- gp_change_reg_table_global.t2 %>% filter(gp_change_p_adj < 0.05)

gp_change_reg_table_global.t2_sig_MC

#Regional Phenotypes
gp_change_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_change_zscore + gp_change_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_change_beta = summary$coefficients[2,1], gp_change_p = summary$coefficients[2,4], gp_change_se = summary$coefficients[2,2],gp_change_base_beta = summary$coefficients[3,1], gp_change_base_p = summary$coefficients[3,4], gp_change_base_se = summary$coefficients[3,2])
})))

gp_change_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_change_reg_table_full.t2)), name_mapping$abbreviation)]

gp_change_reg_table_full.t2_sig <- gp_change_reg_table_full.t2 %>% filter(gp_change_p < 0.05)
gp_change_reg_table_full.t2$gp_change_p_adj <- p.adjust(gp_change_reg_table_full.t2$gp_change_p, method = "BH")
gp_change_reg_table_full.t2$gp_change_base_p_adj <- p.adjust(gp_change_reg_table_full.t2$gp_change_base_p, method = "BH")
gp_change_reg_table_full.t2_sig_MC <- gp_change_reg_table_full.t2 %>% filter(gp_change_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_change_global_t2.csv")
filename_regional <- paste0(output_folder, "gp_change_regional_t2.csv")
write.csv(gp_change_reg_table_global.t2, filename_global)
write.csv(gp_change_reg_table_full.t2, filename_regional)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_change_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_change_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_change_reg_table_full.t2_sig_MC[!(gp_change_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(gp_change_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.gp_change_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_change_beta)) +
  theme_void() +
  labs(title = "GP Change, t2"))

(t2.gp_change_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_change_beta)) +
  theme_void() +
  labs(title = "GP Change, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_change_reg_table_full.t2_sig_MC %>% filter(gp_change_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_change_reg_table_full.t2_sig_MC$gp_change_beta)))

if(save_figures == TRUE){
panel_save(t2.gp_change_dkt_plot, "gp_change_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.gp_change_aseg_plot, "gp_change_t2_aseg", "pdf", figure_panels_folder)
}
```

###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge) & !is.na(t2.full_test_df$bweight_percentile))
ga_zscore <- scale(t2.full_test_df$gestAge)
bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ga_reg_table_global.t2)), name_mapping$abbreviation)]

ga_reg_table_global.t2_sig <- bwp_ga_reg_table_global.t2 %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global.t2$ga_p_adj <- p.adjust(bwp_ga_reg_table_global.t2$ga_p, method = "BH")
bwp_ga_reg_table_global.t2$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global.t2$bwp_p, method = "BH")
ga_reg_table_global.t2_sig_MC <- bwp_ga_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global.t2_sig <- bwp_ga_reg_table_global.t2 %>% filter(bwp_p < 0.05)
bwpga_reg_table_global.t2_sig_MC <- bwp_ga_reg_table_global.t2 %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global.t2_sig_MC


#regional regression
bwp_ga_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ga_reg_table_full.t2)), name_mapping$abbreviation)]

ga_reg_table_full.t2_sig <- bwp_ga_reg_table_full.t2 %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full.t2$ga_p_adj <- p.adjust(bwp_ga_reg_table_full.t2$ga_p, method = "BH")
bwp_ga_reg_table_full.t2$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full.t2$bwp_p, method = "BH")
ga_reg_table_full.t2_sig_MC <- bwp_ga_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full.t2_sig <- bwp_ga_reg_table_full.t2 %>% filter(bwp_p < 0.05)
bwpga_reg_table_full.t2_sig_MC <- bwp_ga_reg_table_full.t2 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ga_global_t2.csv")
filename_regional <- paste0(output_folder, "bwp_ga_regional_t2.csv")
write.csv(bwp_ga_reg_table_global.t2, filename_global)
write.csv(bwp_ga_reg_table_full.t2, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.t2_sig_MC[!(ga_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, t2"))

(t2.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.bwpga_ga_dkt_plot, "bwpga_ga_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwpga_ga_aseg_plot, "bwpga_ga_t2_aseg", "pdf", figure_panels_folder)
}
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full.t2_sig_MC[!(bwpga_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, t2"))

(t2.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwpga_reg_table_full.t2_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwpga_reg_table_full.t2_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t2.bwpga_bwp_dkt_plot, "bwpga_bwp_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwpga_bwp_aseg_plot, "bwpga_bwp_t2_aseg", "pdf", figure_panels_folder)
}
```

###BW + BW PGS 
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs) & !is.na(t2.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(t2.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwbwpgs_reg_table_global.t2)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global.t2_sig <- bwbwpgs_reg_table_global.t2 %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global.t2$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global.t2$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global.t2_sig_MC <- bwbwpgs_reg_table_global.t2 %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global.t2_sig_MC

bw_bwbwpgs_reg_table_global.t2_sig <- bwbwpgs_reg_table_global.t2 %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global.t2$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global.t2$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global.t2_sig_MC <- bwbwpgs_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global.t2_sig_MC

#Regional variables
bwbwpgs_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwbwpgs_reg_table_full.t2)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full.t2_sig <- bwbwpgs_reg_table_full.t2 %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full.t2$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full.t2$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full.t2_sig_MC <- bwbwpgs_reg_table_full.t2 %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full.t2_sig <- bwbwpgs_reg_table_full.t2 %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full.t2$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full.t2$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full.t2_sig_MC <- bwbwpgs_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_bwpgs_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_bwpgs_regional_t2.csv")
write.csv(bwbwpgs_reg_table_global.t2, filename_global)
write.csv(bwbwpgs_reg_table_full.t2, filename_regional)
}
```
###GA with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge) & !is.na(t2.full_test_df$neonatal_comp_total))
ga_zscore <- scale(t2.full_test_df$gestAge)
neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)

#Global phenotypes
ga_neocomp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_neocomp_reg_table_global.t2)), name_mapping$abbreviation)]

ga_neocomp_reg_table_global.t2_sig <- ga_neocomp_reg_table_global.t2 %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_global.t2$ga_p_adj <- p.adjust(ga_neocomp_reg_table_global.t2$ga_p, method = "BH")
ga_neocomp_reg_table_global.t2_sig_MC <- ga_neocomp_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

ga_neocomp_reg_table_global.t2_sig_MC

#Regional phenotypes
ga_neocomp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_neocomp_reg_table_full.t2)), name_mapping$abbreviation)]

ga_neocomp_reg_table_full.t2_sig <- ga_neocomp_reg_table_full.t2 %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_full.t2$ga_p_adj <- p.adjust(ga_neocomp_reg_table_full.t2$ga_p, method = "BH")
ga_neocomp_reg_table_full.t2_sig_MC <- ga_neocomp_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_neocomp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_neocomp_all_t2.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_neocomp_global_t2.csv")
filename_regional <- paste0(output_folder, "ga_neocomp_regional_t2.csv")
write.csv(ga_neocomp_reg_table_global.t2, filename_global)
write.csv(ga_neocomp_reg_table_full.t2, filename_regional)
}
```
###BW with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$birth_weight_oz_sum_adj) & !is.na(t2.full_test_df$neonatal_comp_total))
bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)
neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)

#Global phenotypes
bw_neocomp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_neocomp_reg_table_global.t2)), name_mapping$abbreviation)]

bw_neocomp_reg_table_global.t2_sig <- bw_neocomp_reg_table_global.t2 %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_global.t2$bw_p_adj <- p.adjust(bw_neocomp_reg_table_global.t2$bw_p, method = "BH")
bw_neocomp_reg_table_global.t2_sig_MC <- bw_neocomp_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

bw_neocomp_reg_table_global.t2_sig_MC

#Regional phenotypes
bw_neocomp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_neocomp_reg_table_full.t2)), name_mapping$abbreviation)]

bw_neocomp_reg_table_full.t2_sig <- bw_neocomp_reg_table_full.t2 %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_full.t2$bw_p_adj <- p.adjust(bw_neocomp_reg_table_full.t2$bw_p, method = "BH")
bw_neocomp_reg_table_full.t2_sig_MC <- bw_neocomp_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_neocomp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_bw_neocomp_all_t2.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_neocomp_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_neocomp_regional_t2.csv")
write.csv(bw_neocomp_reg_table_global.t2, filename_global)
write.csv(bw_neocomp_reg_table_full.t2, filename_regional)
}
```
###Gestational Age - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
ga_zscore <- scale(t2.full_test_df$gestAge)

#Global regression
ga_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_ses_reg_table_global.t2)), name_mapping$abbreviation)]

ga_ses_table_global.t2_sig <- ga_ses_reg_table_global.t2 %>% filter(ga_p < 0.05)
ga_ses_reg_table_global.t2$ga_p_adj <- p.adjust(ga_ses_reg_table_global.t2$ga_p, method = "BH")
ga_ses_reg_table_global.t2_sig_MC <- ga_ses_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

ga_ses_reg_table_global.t2_sig_MC

#regional regression
ga_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_ses_reg_table_full.t2)), name_mapping$abbreviation)]

ga_ses_reg_table_full.t2_sig <- ga_ses_reg_table_full.t2 %>% filter(ga_p < 0.05)
ga_ses_reg_table_full.t2$ga_p_adj <- p.adjust(ga_ses_reg_table_full.t2$ga_p, method = "BH")
ga_ses_reg_table_full.t2_sig_MC <- ga_ses_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "ga_ses_regional_t2.csv")
write.csv(ga_ses_reg_table_global.t2, filename_global)
write.csv(ga_ses_reg_table_full.t2, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_ses_reg_table_full.t2_sig_MC[!(ga_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(ga_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.ga_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, t2"))

(t2.ga_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_ses_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_ses_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.ga_ses_dkt_plot, "ga_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.ga_ses_aseg_plot, "ga_ses_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$birth_weight_oz_sum_adj) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)

#Global regression
bw_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_ses_reg_table_global.t2)), name_mapping$abbreviation)]

bw_ses_table_global.t2_sig <- bw_ses_reg_table_global.t2 %>% filter(bw_p < 0.05)
bw_ses_reg_table_global.t2$bw_p_adj <- p.adjust(bw_ses_reg_table_global.t2$bw_p, method = "BH")
bw_ses_reg_table_global.t2_sig_MC <- bw_ses_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

bw_ses_reg_table_global.t2_sig_MC

#regional regression
bw_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_ses_reg_table_full.t2)), name_mapping$abbreviation)]

bw_ses_reg_table_full.t2_sig <- bw_ses_reg_table_full.t2 %>% filter(bw_p < 0.05)
bw_ses_reg_table_full.t2$bw_p_adj <- p.adjust(bw_ses_reg_table_full.t2$bw_p, method = "BH")
bw_ses_reg_table_full.t2_sig_MC <- bw_ses_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_ses_regional_t2.csv")
write.csv(bw_ses_reg_table_global.t2, filename_global)
write.csv(bw_ses_reg_table_full.t2, filename_regional)
}
```
####BW coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_ses_reg_table_full.t2_sig_MC[!(bw_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bw_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, t2"))

(t2.bw_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_ses_reg_table_full.t2_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_ses_reg_table_full.t2_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t2.bw_ses_dkt_plot, "bw_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bw_ses_aseg_plot, "bw_ses_t2_aseg", "pdf", figure_panels_folder)
}
```

###birth weight percentile - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bweight_percentile) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
bwp_zscore <- scale(t2.full_test_df$bweight_percentile)

#Global regression
bwp_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ses_reg_table_global.t2)), name_mapping$abbreviation)]

bwp_ses_table_global.t2_sig <- bwp_ses_reg_table_global.t2 %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_global.t2$bwp_p_adj <- p.adjust(bwp_ses_reg_table_global.t2$bwp_p, method = "BH")
bwp_ses_reg_table_global.t2_sig_MC <- bwp_ses_reg_table_global.t2 %>% filter(bwp_p_adj < 0.05)

bwp_ses_reg_table_global.t2_sig_MC

#regional regression
bwp_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ses_reg_table_full.t2)), name_mapping$abbreviation)]

bwp_ses_reg_table_full.t2_sig <- bwp_ses_reg_table_full.t2 %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_full.t2$bwp_p_adj <- p.adjust(bwp_ses_reg_table_full.t2$bwp_p, method = "BH")
bwp_ses_reg_table_full.t2_sig_MC <- bwp_ses_reg_table_full.t2 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "bwp_ses_regional_t2.csv")
write.csv(bwp_ses_reg_table_global.t2, filename_global)
write.csv(bwp_ses_reg_table_full.t2, filename_regional)
}
```
####bwp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_ses_reg_table_full.t2_sig_MC[!(bwp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bwp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, t2"))

(t2.bwp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_ses_reg_table_full.t2_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_ses_reg_table_full.t2_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t2.bwp_ses_dkt_plot, "bwp_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwp_ses_aseg_plot, "bwp_ses_t2_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_ses_reg_table_global.t2)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_global.t2_sig <- bw_pgs_ses_reg_table_global.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_global.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_global.t2$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_global.t2_sig_MC <- bw_pgs_ses_reg_table_global.t2 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_ses_reg_table_global.t2_sig_MC

#Regional Phenotypes
bw_pgs_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[,which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_ses_reg_table_full.t2)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_full.t2_sig <- bw_pgs_ses_reg_table_full.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_full.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_full.t2$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_full.t2_sig_MC <- bw_pgs_ses_reg_table_full.t2 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_pgs_ses_regional_t2.csv")
write.csv(bw_pgs_ses_reg_table_global.t2, filename_global)
write.csv(bw_pgs_ses_reg_table_full.t2, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_ses_reg_table_full.t2_sig_MC[!(bw_pgs_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpgs_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES t2"))

(t2.bwpgs_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_ses_reg_table_full.t2_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_ses_reg_table_full.t2_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t2.bwpgs_ses_dkt_plot, "bw_pgs_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwpgs_ses_aseg_plot, "bw_pgs_ses_t2_aseg", "pdf", figure_panels_folder)
}
```
###Neocomp Total - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$neonatal_comp_total) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)

#Global regression
neocomp_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_ses_reg_table_global.t2)), name_mapping$abbreviation)]

neocomp_ses_table_global.t2_sig <- neocomp_ses_reg_table_global.t2 %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_global.t2$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_global.t2$neocomp_p, method = "BH")
neocomp_ses_reg_table_global.t2_sig_MC <- neocomp_ses_reg_table_global.t2 %>% filter(neocomp_p_adj < 0.05)

neocomp_ses_reg_table_global.t2_sig_MC

#regional regression
neocomp_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_ses_reg_table_full.t2)), name_mapping$abbreviation)]

neocomp_ses_reg_table_full.t2_sig <- neocomp_ses_reg_table_full.t2 %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_full.t2$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_full.t2$neocomp_p, method = "BH")
neocomp_ses_reg_table_full.t2_sig_MC <- neocomp_ses_reg_table_full.t2 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "neocomp_ses_regional_t2.csv")
write.csv(neocomp_ses_reg_table_global.t2, filename_global)
write.csv(neocomp_ses_reg_table_full.t2, filename_regional)
}
```
####Surface plots - neocomp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_ses_reg_table_full.t2_sig_MC[!(neocomp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),] %>% 
  select(c('neocomp_beta', 'neocomp_p_adj', 'label'))

# Plot using ggseg
(t2.neocomp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, t2"))

(t2.neocomp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_ses_reg_table_full.t2_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_ses_reg_table_full.t2_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t2.neocomp_ses_dkt_plot, "neocomp_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.neocomp_ses_aseg_plot, "neocomp_ses_t2_aseg", "pdf", figure_panels_folder)
}
```

###general P-factor - SES as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p.t2) & !is.na(t2.full_test_df$combo.income_ordered) & !is.na(t2.full_test_df$combo.prnt_edu_ordered))
gp_zscore <- scale(t2.full_test_df$General_p.t2)

#Global regression
gp_ses_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_ses_reg_table_global.t2)), name_mapping$abbreviation)]

gp_ses_table_global.t2_sig <- gp_ses_reg_table_global.t2 %>% filter(gp_p < 0.05)
gp_ses_reg_table_global.t2$gp_p_adj <- p.adjust(gp_ses_reg_table_global.t2$gp_p, method = "BH")
gp_ses_reg_table_global.t2_sig_MC <- gp_ses_reg_table_global.t2 %>% filter(gp_p_adj < 0.05)

gp_ses_reg_table_global.t2_sig_MC

#regional regression
gp_ses_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_ses_reg_table_full.t2)), name_mapping$abbreviation)]

gp_ses_reg_table_full.t2_sig <- gp_ses_reg_table_full.t2 %>% filter(gp_p < 0.05)
gp_ses_reg_table_full.t2$gp_p_adj <- p.adjust(gp_ses_reg_table_full.t2$gp_p, method = "BH")
gp_ses_reg_table_full.t2_sig_MC <- gp_ses_reg_table_full.t2 %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_ses_global_t2.csv")
filename_regional <- paste0(output_folder, "gp_ses_regional_t2.csv")
write.csv(gp_ses_reg_table_global.t2, filename_global)
write.csv(gp_ses_reg_table_full.t2, filename_regional)
}
```
####gp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_ses_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_ses_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_ses_reg_table_full.t2_sig_MC[!(gp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(gp_ses_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.gp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, t2"))

(t2.gp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_ses_reg_table_full.t2_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_ses_reg_table_full.t2_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t2.gp_ses_dkt_plot, "gp_ses_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.gp_ses_aseg_plot, "gp_ses_t2_aseg", "pdf", figure_panels_folder)
}
```
###GA - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))

df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t2.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t2.full_test_df$anthroheightcalc)
df$ga_zscore <- scale(t2.full_test_df$gestAge)

#Global phenotypes
ga_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_wh_reg_table_global.t2)), name_mapping$abbreviation)]

ga_wh_reg_table_global.t2_sig <- ga_wh_reg_table_global.t2 %>% filter(ga_p < 0.05)
ga_wh_reg_table_global.t2$ga_p_adj <- p.adjust(ga_wh_reg_table_global.t2$ga_p, method = "BH")
ga_wh_reg_table_global.t2_sig_MC <- ga_wh_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

ga_wh_reg_table_global.t2_sig_MC

#Regional phenotypes
ga_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_wh_reg_table_full.t2)), name_mapping$abbreviation)]

ga_wh_reg_table_full.t2_sig <- ga_wh_reg_table_full.t2 %>% filter(ga_p < 0.05)
ga_wh_reg_table_full.t2$ga_p_adj <- p.adjust(ga_wh_reg_table_full.t2$ga_p, method = "BH")
ga_wh_reg_table_full.t2_sig_MC <- ga_wh_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_wh_global_t2.csv")
filename_regional <- paste0(output_folder, "ga_wh_regional_t2.csv")
write.csv(ga_wh_reg_table_global.t2, filename_global)
write.csv(ga_wh_reg_table_full.t2, filename_regional)
}
```
####surface plots
```{r}
ga_wh_reg_table_full.t2_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_wh_reg_table_full.t2_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_wh_reg_table_full.t2_sig_MC[!(ga_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(ga_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.ga_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, t2"))

(t2.ga_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_wh_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_wh_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.ga_wh_dkt_plot, "ga_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.ga_wh_aseg_plot, "ga_wh_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$birth_weight_oz_sum_adj) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))

df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t2.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t2.full_test_df$anthroheightcalc)
df$bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)

#Global phenotypes
bw_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_wh_reg_table_global.t2)), name_mapping$abbreviation)]

bw_wh_reg_table_global.t2_sig <- bw_wh_reg_table_global.t2 %>% filter(bw_p < 0.05)
bw_wh_reg_table_global.t2$bw_p_adj <- p.adjust(bw_wh_reg_table_global.t2$bw_p, method = "BH")
bw_wh_reg_table_global.t2_sig_MC <- bw_wh_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

bw_wh_reg_table_global.t2_sig_MC

#Regional phenotypes
bw_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_wh_reg_table_full.t2)), name_mapping$abbreviation)]

bw_wh_reg_table_full.t2_sig <- bw_wh_reg_table_full.t2 %>% filter(bw_p < 0.05)
bw_wh_reg_table_full.t2$bw_p_adj <- p.adjust(bw_wh_reg_table_full.t2$bw_p, method = "BH")
bw_wh_reg_table_full.t2_sig_MC <- bw_wh_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_wh_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_wh_regional_t2.csv")
write.csv(bw_wh_reg_table_global.t2, filename_global)
write.csv(bw_wh_reg_table_full.t2, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_wh_reg_table_full.t2_sig_MC[!(bw_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),c("bw_beta", "bw_p_adj", "label")]

# Plot using ggseg
(t2.bw_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, t2"))

(t2.bw_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_wh_reg_table_full.t2_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_wh_reg_table_full.t2_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t2.bw_wh_dkt_plot, "bw_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bw_wh_aseg_plot, "bw_wh_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bweight_percentile) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))

df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t2.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t2.full_test_df$anthroheightcalc)
df$bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)

#Global phenotypes
bwp_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_wh_reg_table_global.t2)), name_mapping$abbreviation)]

bwp_wh_reg_table_global.t2_sig <- bwp_wh_reg_table_global.t2 %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_global.t2$bwp_p_adj <- p.adjust(bwp_wh_reg_table_global.t2$bwp_p, method = "BH")
bwp_wh_reg_table_global.t2_sig_MC <- bwp_wh_reg_table_global.t2 %>% filter(bwp_p_adj < 0.05)

bwp_wh_reg_table_global.t2_sig_MC

#Regional phenotypes
bwp_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_wh_reg_table_full.t2)), name_mapping$abbreviation)]

bwp_wh_reg_table_full.t2_sig <- bwp_wh_reg_table_full.t2 %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_full.t2$bwp_p_adj <- p.adjust(bwp_wh_reg_table_full.t2$bwp_p, method = "BH")
bwp_wh_reg_table_full.t2_sig_MC <- bwp_wh_reg_table_full.t2 %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_wh_global_t2.csv")
filename_regional <- paste0(output_folder, "bwp_wh_regional_t2.csv")
write.csv(bwp_wh_reg_table_global.t2, filename_global)
write.csv(bwp_wh_reg_table_full.t2, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_wh_reg_table_full.t2_sig_MC[!(bwp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bwp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),c("bwp_beta", "bwp_p_adj", "label")]

# Plot using ggseg
(t2.bwp_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, t2"))

(t2.bwp_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_wh_reg_table_full.t2_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_wh_reg_table_full.t2_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t2.bwp_wh_dkt_plot, "bwp_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwp_wh_aseg_plot, "bwp_wh_t2_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - wh as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t2.full_test_df$anthroweightcalc + t2.full_test_df$anthroheightcalc + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_wh_reg_table_global.t2)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_global.t2_sig <- bw_pgs_wh_reg_table_global.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_global.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_global.t2$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_global.t2_sig_MC <- bw_pgs_wh_reg_table_global.t2 %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_wh_reg_table_global.t2_sig_MC

#Regional Phenotypes
bw_pgs_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[,which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + t2.full_test_df$combo.income_ordered + t2.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_wh_reg_table_full.t2)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_full.t2_sig <- bw_pgs_wh_reg_table_full.t2 %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_full.t2$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_full.t2$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_full.t2_sig_MC <- bw_pgs_wh_reg_table_full.t2 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-betas_folder
  filename_global <- paste0(output_folder, "bw_pgs_wh_global_t2.csv")
  filename_regional <- paste0(output_folder, "bw_pgs_wh_regional_t2.csv")
  write.csv(bw_pgs_wh_reg_table_global.t2, filename_global)
  write.csv(bw_pgs_wh_reg_table_full.t2, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_wh_reg_table_full.t2_sig_MC[!(bw_pgs_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpgs_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh t2"))

(t2.bwpgs_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_wh_reg_table_full.t2_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_wh_reg_table_full.t2_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t2.bwpgs_wh_dkt_plot, "bw_pgs_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.bwpgs_wh_aseg_plot, "bw_pgs_wh_t2_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal comp - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$neonatal_comp_total) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))

df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t2.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t2.full_test_df$anthroheightcalc)
df$neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)

#Global phenotypes
neocomp_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_wh_reg_table_global.t2)), name_mapping$abbreviation)]

neocomp_wh_reg_table_global.t2_sig <- neocomp_wh_reg_table_global.t2 %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_global.t2$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_global.t2$neocomp_p, method = "BH")
neocomp_wh_reg_table_global.t2_sig_MC <- neocomp_wh_reg_table_global.t2 %>% filter(neocomp_p_adj < 0.05)

neocomp_wh_reg_table_global.t2_sig_MC

#Regional phenotypes
neocomp_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neocomp_wh_reg_table_full.t2)), name_mapping$abbreviation)]

neocomp_wh_reg_table_full.t2_sig <- neocomp_wh_reg_table_full.t2 %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_full.t2$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_full.t2$neocomp_p, method = "BH")
neocomp_wh_reg_table_full.t2_sig_MC <- neocomp_wh_reg_table_full.t2 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_wh_global_t2.csv")
filename_regional <- paste0(output_folder, "neocomp_wh_regional_t2.csv")
write.csv(neocomp_wh_reg_table_global.t2, filename_global)
write.csv(neocomp_wh_reg_table_full.t2, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_wh_reg_table_full.t2_sig_MC[!(neocomp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),c("neocomp_beta", "neocomp_p_adj", "label")]

# Plot using ggseg
(t2.neocomp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, t2"))

(t2.neocomp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_wh_reg_table_full.t2_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_wh_reg_table_full.t2_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t2.neocomp_wh_dkt_plot, "neocomp_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.neocomp_wh_aseg_plot, "neocomp_wh_t2_aseg", "pdf", figure_panels_folder)
}
```

###General p - weight & height as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p.t2) & !is.na(t2.full_test_df$anthroweightcalc) & !is.na(t2.full_test_df$anthroheightcalc))

df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(t2.full_test_df$anthroweightcalc)
df$height_zscore <- scale(t2.full_test_df$anthroheightcalc)
df$gp_zscore <- scale(t2.full_test_df$General_p.t2)

#Global phenotypes
gp_wh_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_wh_reg_table_global.t2)), name_mapping$abbreviation)]

gp_wh_reg_table_global.t2_sig <- gp_wh_reg_table_global.t2 %>% filter(gp_p < 0.05)
gp_wh_reg_table_global.t2$gp_p_adj <- p.adjust(gp_wh_reg_table_global.t2$gp_p, method = "BH")
gp_wh_reg_table_global.t2_sig_MC <- gp_wh_reg_table_global.t2 %>% filter(gp_p_adj < 0.05)

gp_wh_reg_table_global.t2_sig_MC

#Regional phenotypes
gp_wh_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_wh_reg_table_full.t2)), name_mapping$abbreviation)]

gp_wh_reg_table_full.t2_sig <- gp_wh_reg_table_full.t2 %>% filter(gp_p < 0.05)
gp_wh_reg_table_full.t2$gp_p_adj <- p.adjust(gp_wh_reg_table_full.t2$gp_p, method = "BH")
gp_wh_reg_table_full.t2_sig_MC <- gp_wh_reg_table_full.t2 %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_wh_global_t2.csv")
filename_regional <- paste0(output_folder, "gp_wh_regional_t2.csv")
write.csv(gp_wh_reg_table_global.t2, filename_global)
write.csv(gp_wh_reg_table_full.t2, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_wh_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_wh_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_wh_reg_table_full.t2_sig_MC[!(gp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(gp_wh_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),c("gp_beta", "gp_p_adj", "label")]

# Plot using ggseg
(t2.gp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, t2"))

(t2.gp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_wh_reg_table_full.t2_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_wh_reg_table_full.t2_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t2.gp_wh_dkt_plot, "gp_wh_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.gp_wh_aseg_plot, "gp_wh_t2_aseg", "pdf", figure_panels_folder)
}
```

##T2 - controlling for intracranial volume
###Gestational Age
####linear regressions
```{r}
ga_zscore <- scale(t2.full_test_df$gestAge)
total_volume_zcore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global phenotypes
icv_ga_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_ga_reg_table_global.t2)), name_mapping$abbreviation)]

icv_ga_reg_table_global.t2_sig <- icv_ga_reg_table_global.t2 %>% filter(ga_p < 0.05)
icv_ga_reg_table_global.t2$ga_p_adj <- p.adjust(icv_ga_reg_table_global.t2$ga_p, method = "BH")
icv_ga_reg_table_global.t2_sig_MC <- icv_ga_reg_table_global.t2 %>% filter(ga_p_adj < 0.05)

icv_ga_reg_table_global.t2_sig_MC

#Regional phenotypes
icv_ga_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_ga_reg_table_full.t2)), name_mapping$abbreviation)]

icv_ga_reg_table_full.t2_sig <- icv_ga_reg_table_full.t2 %>% filter(ga_p < 0.05)
icv_ga_reg_table_full.t2$ga_p_adj <- p.adjust(icv_ga_reg_table_full.t2$ga_p, method = "BH")
icv_ga_reg_table_full.t2_sig_MC <- icv_ga_reg_table_full.t2 %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_ga_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_icv_all_t2.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "ga_icv_regional_t2.csv")
write.csv(icv_ga_reg_table_global.t2, filename_global)
write.csv(icv_ga_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
ga_reg_table_all.t2 <- rbind(ga_reg_table_global.t2, ga_reg_table_full.t2)
icv_ga_reg_table_all.t2 <- rbind(icv_ga_reg_table_global.t2, icv_ga_reg_table_full.t2)
#all phenotypes
#univariate x~ga regression
ga_reg_table_all.t2$ga_lower <- (ga_reg_table_all.t2$ga_beta - 1.96*ga_reg_table_all.t2$ga_se)
ga_reg_table_all.t2$ga_upper <- (ga_reg_table_all.t2$ga_beta + 1.96*ga_reg_table_all.t2$ga_se)
ga_reg_table_all.t2 <- ga_reg_table_all.t2 %>% mutate(lm = "ga_uni")

#multivariate x~ga*bw regression, significant for ga_beta
icv_ga_reg_table_all.t2$ga_lower <- (icv_ga_reg_table_all.t2$ga_beta - 1.96*icv_ga_reg_table_all.t2$ga_se)
icv_ga_reg_table_all.t2$ga_upper <- (icv_ga_reg_table_all.t2$ga_beta + 1.96*icv_ga_reg_table_all.t2$ga_se)
icv_ga_reg_table_all.t2_plot <- icv_ga_reg_table_all.t2 %>% mutate(lm = "ga_icv") %>% select(all_of(names(ga_reg_table_all.t2)))
#combine tables
combined_reg_table <- rbind(ga_reg_table_all.t2, icv_ga_reg_table_all.t2_plot)

#add a TRUE/FALSE column for ga_beta in the SAME direction, and for ga_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(ga_reg_table_all.t2, icv_ga_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$ga_beta_uni) == sign(wide_combined_reg_table$ga_beta_icv)) & wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$ga_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = ga_beta, xmin = ga_lower, xmax = ga_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("ga_uni" = "grey", "ga_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "ga_beta_uni", "ga_p_adj_uni", "ga_beta_icv", "ga_p_adj_icv")]

(t2.icv_ga_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, t2"))

(t2.icv_ga_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'ga_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_ga_survive_dkt_plot, "icv_ga_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_ga_survive_aseg_plot, "icv_ga_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_ga_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_ga_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_ga_reg_table_full.t2_sig_MC[!(icv_ga_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_ga_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_ga_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, t2"))

(t2.icv_ga_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_ga_reg_table_full.t2_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_ga_reg_table_full.t2_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_ga_full_dkt_plot, "icv_ga_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_ga_full_aseg_plot, "icv_ga_full_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight
####linear regressions
```{r}
df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$bw_zscore <- scale(t2.full_test_df$birth_weight_oz_sum_adj)
df$total_volume_zcore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global phenotypes -- save betas and p-values
icv_bw_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bw_reg_table_global.t2)), name_mapping$abbreviation)]

icv_bw_reg_table_global.t2_sig <- icv_bw_reg_table_global.t2 %>% filter(bw_p < 0.05)
icv_bw_reg_table_global.t2$bw_p_adj <- p.adjust(icv_bw_reg_table_global.t2$bw_p, method = "BH")
icv_bw_reg_table_global.t2_sig_MC <- icv_bw_reg_table_global.t2 %>% filter(bw_p_adj < 0.05)

icv_bw_reg_table_global.t2_sig_MC

#Regional phenotypes -- save betas and p-values
icv_bw_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bw_reg_table_full.t2)), name_mapping$abbreviation)]

icv_bw_reg_table_full.t2_sig <- icv_bw_reg_table_full.t2 %>% filter(bw_p < 0.05)
icv_bw_reg_table_full.t2$bw_p_adj <- p.adjust(icv_bw_reg_table_full.t2$bw_p, method = "BH")
icv_bw_reg_table_full.t2_sig_MC <- icv_bw_reg_table_full.t2 %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_icv_all_t2.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_icv_sig_t2.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_icv_regional_t2.csv")
write.csv(icv_bw_reg_table_global.t2, filename_global)
write.csv(icv_bw_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_reg_table_all.t2 <- rbind(bw_reg_table_global.t2, bw_reg_table_full.t2)
icv_bw_reg_table_all.t2 <- rbind(icv_bw_reg_table_global.t2, icv_bw_reg_table_full.t2)
#all phenotypes
#univariate x~ga regression
bw_reg_table_all.t2$bw_lower <- (bw_reg_table_all.t2$bw_beta - 1.96*bw_reg_table_all.t2$bw_se)
bw_reg_table_all.t2$bw_upper <- (bw_reg_table_all.t2$bw_beta + 1.96*bw_reg_table_all.t2$bw_se)
bw_reg_table_all.t2 <- bw_reg_table_all.t2 %>% mutate(lm = "bw_uni")

#multivariate x~ga*bw regression, significant for bw_beta
icv_bw_reg_table_all.t2$bw_lower <- (icv_bw_reg_table_all.t2$bw_beta - 1.96*icv_bw_reg_table_all.t2$bw_se)
icv_bw_reg_table_all.t2$bw_upper <- (icv_bw_reg_table_all.t2$bw_beta + 1.96*icv_bw_reg_table_all.t2$bw_se)
icv_bw_reg_table_all.t2_plot <- icv_bw_reg_table_all.t2 %>% mutate(lm = "bw_icv") %>% select(all_of(names(bw_reg_table_all.t2)))
#combine tables
combined_reg_table <- rbind(bw_reg_table_all.t2, icv_bw_reg_table_all.t2_plot)

#add a TRUE/FALSE column for bw_beta in the SAME direction, and for bw_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_reg_table_all.t2, icv_bw_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_beta_uni) == sign(wide_combined_reg_table$bw_beta_icv)) & wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$bw_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = bw_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_uni" = "grey", "bw_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_beta_uni", "bw_p_adj_uni", "bw_beta_icv", "bw_p_adj_icv")]

(t2.icv_bw_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, t2"))

(t2.icv_bw_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_bw_survive_dkt_plot, "icv_bw_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bw_survive_aseg_plot, "icv_bw_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_reg_table_full.t2_sig_MC[!(icv_bw_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_bw_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, t2"))

(t2.icv_bw_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_reg_table_full.t2_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_reg_table_full.t2_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_bw_full_dkt_plot, "icv_bw_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bw_full_aseg_plot, "icv_bw_full_t2_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile
####linear regressions
```{r}
bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)
total_volume_zcore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global Phenotypes
icv_bwp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bwp_reg_table_global.t2)), name_mapping$abbreviation)]

icv_bwp_reg_table_global.t2_sig <- icv_bwp_reg_table_global.t2 %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_global.t2$bwp_p_adj <- p.adjust(icv_bwp_reg_table_global.t2$bwp_p, method = "BH")
icv_bwp_reg_table_global.t2_sig_MC <- icv_bwp_reg_table_global.t2 %>% filter(bwp_p_adj < 0.05)

icv_bwp_reg_table_global.t2_sig_MC

#Regional Phenotypes
icv_bwp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bwp_reg_table_full.t2)), name_mapping$abbreviation)]

icv_bwp_reg_table_full.t2_sig <- icv_bwp_reg_table_full.t2 %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_full.t2$bwp_p_adj <- p.adjust(icv_bwp_reg_table_full.t2$bwp_p, method = "BH")
icv_bwp_reg_table_full.t2_sig_MC <- icv_bwp_reg_table_full.t2 %>% filter(bwp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bwp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_icv_all_t2.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "bwp_icv_regional_t2.csv")
write.csv(icv_bwp_reg_table_global.t2, filename_global)
write.csv(icv_bwp_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bwp_reg_table_all.t2 <- rbind(bwp_reg_table_global.t2, bwp_reg_table_full.t2)
icv_bwp_reg_table_all.t2 <- rbind(icv_bwp_reg_table_global.t2, icv_bwp_reg_table_full.t2)
#all phenotypes
#univariate x~bwp regression
bwp_reg_table_all.t2$bwp_lower <- (bwp_reg_table_all.t2$bwp_beta - 1.96*bwp_reg_table_all.t2$bwp_se)
bwp_reg_table_all.t2$bwp_upper <- (bwp_reg_table_all.t2$bwp_beta + 1.96*bwp_reg_table_all.t2$bwp_se)
bwp_reg_table_all.t2 <- bwp_reg_table_all.t2 %>% mutate(lm = "bwp_uni")

#multivariate x~bwp*bw regression, significant for bwp_beta
icv_bwp_reg_table_all.t2$bwp_lower <- (icv_bwp_reg_table_all.t2$bwp_beta - 1.96*icv_bwp_reg_table_all.t2$bwp_se)
icv_bwp_reg_table_all.t2$bwp_upper <- (icv_bwp_reg_table_all.t2$bwp_beta + 1.96*icv_bwp_reg_table_all.t2$bwp_se)
icv_bwp_reg_table_all.t2_plot <- icv_bwp_reg_table_all.t2 %>% mutate(lm = "bwp_icv") %>% select(all_of(names(bwp_reg_table_all.t2)))
#combine tables
combined_bwp_reg_table <- rbind(bwp_reg_table_all.t2, icv_bwp_reg_table_all.t2_plot)

#add a TRUE/FALSE column for bwp_beta in the SAME direction, and for bwp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bwp_reg_table_all.t2, icv_bwp_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bwp_beta_uni) == sign(wide_combined_reg_table$bwp_beta_icv)) & wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$bwp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bwp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bwp_reg_table)),], aes(y = label, x = bwp_beta, xmin = bwp_lower, xmax = bwp_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bwp_uni" = "grey", "bwp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bwp_beta_uni", "bwp_p_adj_uni", "bwp_beta_icv", "bwp_p_adj_icv")]

(t2.icv_bwp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, t2"))

(t2.icv_bwp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bwp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_bwp_survive_dkt_plot, "icv_bwp_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bwp_survive_aseg_plot, "icv_bwp_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bwp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bwp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bwp_reg_table_full.t2_sig_MC[!(icv_bwp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_bwp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_bwp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, t2"))

(t2.icv_bwp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bwp_reg_table_full.t2_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bwp_reg_table_full.t2_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_bwp_full_dkt_plot, "icv_bwp_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bwp_full_aseg_plot, "icv_bwp_full_t2_aseg", "pdf", figure_panels_folder)
}
```
###PRS-bw
####linear regressions
```{r}
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
total_volume_zscore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global Phenotypes
icv_bw_pgs_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bw_pgs_reg_table_global.t2)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_global.t2_sig <- icv_bw_pgs_reg_table_global.t2 %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_global.t2$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_global.t2$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_global.t2_sig_MC <- icv_bw_pgs_reg_table_global.t2 %>% filter(bw_pgs_p_adj < 0.05)

icv_bw_pgs_reg_table_global.t2_sig_MC

#Regional Phenotypes
icv_bw_pgs_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[,which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_bw_pgs_reg_table_full.t2)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_full.t2_sig <- icv_bw_pgs_reg_table_full.t2 %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_full.t2$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_full.t2$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_full.t2_sig_MC <- icv_bw_pgs_reg_table_full.t2 %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_pgs_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_icv_all_t2.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "bw_pgs_icv_regional_t2.csv")
write.csv(icv_bw_pgs_reg_table_global.t2, filename_global)
write.csv(icv_bw_pgs_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_pgs_reg_table_all.t2 <- rbind(bw_pgs_reg_table_global.t2, bw_pgs_reg_table_full.t2)
icv_bw_pgs_reg_table_all.t2 <- rbind(icv_bw_pgs_reg_table_global.t2, icv_bw_pgs_reg_table_full.t2)
#all phenotypes
#univariate x~bw_pgs regression
bw_pgs_reg_table_all.t2$bw_lower <- (bw_pgs_reg_table_all.t2$bw_pgs_beta - 1.96*bw_pgs_reg_table_all.t2$bw_pgs_se)
bw_pgs_reg_table_all.t2$bw_upper <- (bw_pgs_reg_table_all.t2$bw_pgs_beta + 1.96*bw_pgs_reg_table_all.t2$bw_pgs_se)
bw_pgs_reg_table_all.t2 <- bw_pgs_reg_table_all.t2 %>% mutate(lm = "bw_pgs_uni")

#multivariate x~bw_pgs*bw regression, significant for bw_pgs_beta
icv_bw_pgs_reg_table_all.t2$bw_lower <- (icv_bw_pgs_reg_table_all.t2$bw_pgs_beta - 1.96*icv_bw_pgs_reg_table_all.t2$bw_pgs_se)
icv_bw_pgs_reg_table_all.t2$bw_upper <- (icv_bw_pgs_reg_table_all.t2$bw_pgs_beta + 1.96*icv_bw_pgs_reg_table_all.t2$bw_pgs_se)
icv_bw_pgs_reg_table_all.t2_plot <- icv_bw_pgs_reg_table_all.t2 %>% mutate(lm = "bw_pgs_icv") %>% select(all_of(names(bw_pgs_reg_table_all.t2)))
#combine tables
combined_bw_pgs_reg_table <- rbind(bw_pgs_reg_table_all.t2, icv_bw_pgs_reg_table_all.t2_plot)

#add a TRUE/FALSE column for bw_pgs_beta in the SAME direction, and for bw_pgs_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_pgs_reg_table_all.t2, icv_bw_pgs_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_pgs_beta_uni) == sign(wide_combined_reg_table$bw_pgs_beta_icv)) & wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$bw_pgs_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bw_pgs_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bw_pgs_reg_table)),], aes(y = label, x = bw_pgs_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_pgs_uni" = "grey", "bw_pgs_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")
```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_pgs_beta_uni", "bw_pgs_p_adj_uni", "bw_pgs_beta_icv", "bw_pgs_p_adj_icv")]

(t2.icv_bw_pgs_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, t2"))

(t2.icv_bw_pgs_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_pgs_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_bw_pgs_survive_dkt_plot, "icv_bw_pgs_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bw_pgs_survive_aseg_plot, "icv_bw_pgs_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_pgs_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_pgs_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_pgs_reg_table_full.t2_sig_MC[!(icv_bw_pgs_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_pgs_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_bw_pgs_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, t2"))

(t2.icv_bw_pgs_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_pgs_reg_table_full.t2_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_pgs_reg_table_full.t2_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_bw_pgs_full_dkt_plot, "icv_bw_pgs_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_bw_pgs_full_aseg_plot, "icv_bw_pgs_full_t2_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal Comp
####linear regressions
```{r}
neocomp_zscore <- scale(t2.full_test_df$neonatal_comp_total)
total_volume_zscore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global Phenotypes
icv_neocomp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_neocomp_reg_table_global.t2)), name_mapping$abbreviation)]

icv_neocomp_reg_table_global.t2_sig <- icv_neocomp_reg_table_global.t2 %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_global.t2$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_global.t2$neocomp_p, method = "BH")
icv_neocomp_reg_table_global.t2_sig_MC <- icv_neocomp_reg_table_global.t2 %>% filter(neocomp_p_adj < 0.05)

icv_neocomp_reg_table_global.t2_sig_MC

#Regional Phenotypes
icv_neocomp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_neocomp_reg_table_full.t2)), name_mapping$abbreviation)]

icv_neocomp_reg_table_full.t2_sig <- icv_neocomp_reg_table_full.t2 %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_full.t2$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_full.t2$neocomp_p, method = "BH")
icv_neocomp_reg_table_full.t2_sig_MC <- icv_neocomp_reg_table_full.t2 %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "neocomp_icv_regional_t2.csv")
write.csv(icv_neocomp_reg_table_global.t2, filename_global)
write.csv(icv_neocomp_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
neocomp_reg_table_all.t2 <- rbind(neocomp_reg_table_global.t2, neocomp_reg_table_full.t2)
icv_neocomp_reg_table_all.t2 <- rbind(icv_neocomp_reg_table_global.t2, icv_neocomp_reg_table_full.t2)
#all phenotypes
#univariate x~neocomp regression
neocomp_reg_table_all.t2$bw_lower <- (neocomp_reg_table_all.t2$neocomp_beta - 1.96*neocomp_reg_table_all.t2$neocomp_se)
neocomp_reg_table_all.t2$bw_upper <- (neocomp_reg_table_all.t2$neocomp_beta + 1.96*neocomp_reg_table_all.t2$neocomp_se)
neocomp_reg_table_all.t2 <- neocomp_reg_table_all.t2 %>% mutate(lm = "neocomp_uni")

#multivariate x~neocomp*bw regression, significant for neocomp_beta
icv_neocomp_reg_table_all.t2$bw_lower <- (icv_neocomp_reg_table_all.t2$neocomp_beta - 1.96*icv_neocomp_reg_table_all.t2$neocomp_se)
icv_neocomp_reg_table_all.t2$bw_upper <- (icv_neocomp_reg_table_all.t2$neocomp_beta + 1.96*icv_neocomp_reg_table_all.t2$neocomp_se)
icv_neocomp_reg_table_all.t2_plot <- icv_neocomp_reg_table_all.t2 %>% mutate(lm = "neocomp_icv") %>% select(all_of(names(neocomp_reg_table_all.t2)))
#combine tables
combined_neocomp_reg_table <- rbind(neocomp_reg_table_all.t2, icv_neocomp_reg_table_all.t2_plot)

#add a TRUE/FALSE column for neocomp_beta in the SAME direction, and for neocomp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(neocomp_reg_table_all.t2, icv_neocomp_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$neocomp_beta_uni) == sign(wide_combined_reg_table$neocomp_beta_icv)) & wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$neocomp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_neocomp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_neocomp_reg_table)),], aes(y = label, x = neocomp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
  geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
  ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("neocomp_uni" = "grey", "neocomp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "neocomp_beta_uni", "neocomp_p_adj_uni", "neocomp_beta_icv", "neocomp_p_adj_icv")]

(t2.icv_neocomp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, t2"))

(t2.icv_neocomp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'neocomp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_neocomp_survive_dkt_plot, "icv_neocomp_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_neocomp_survive_aseg_plot, "icv_neocomp_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_neocomp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_neocomp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_neocomp_reg_table_full.t2_sig_MC[!(icv_neocomp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_neocomp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_neocomp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, t2"))

(t2.icv_neocomp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_neocomp_reg_table_full.t2_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_neocomp_reg_table_full.t2_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_neocomp_full_dkt_plot, "icv_neocomp_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_neocomp_full_aseg_plot, "icv_neocomp_full_t2_aseg", "pdf", figure_panels_folder)
}
```
###general P-factor
####linear regressions
```{r}
gp_zscore <- scale(t2.full_test_df$General_p.t2)
total_volume_zscore <- qnorm(t2.full_test_df$smri_vol_scs_intracranialv.t2_centiles)

#Global Phenotypes
icv_gp_reg_table_global.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

icv_gp_reg_table_global.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_gp_reg_table_global.t2)), name_mapping$abbreviation)]

icv_gp_reg_table_global.t2_sig <- icv_gp_reg_table_global.t2 %>% filter(gp_p < 0.05)
icv_gp_reg_table_global.t2$gp_p_adj <- p.adjust(icv_gp_reg_table_global.t2$gp_p, method = "BH")
icv_gp_reg_table_global.t2_sig_MC <- icv_gp_reg_table_global.t2 %>% filter(gp_p_adj < 0.05)

icv_gp_reg_table_global.t2_sig_MC

#Regional Phenotypes
icv_gp_reg_table_full.t2 <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

icv_gp_reg_table_full.t2$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(icv_gp_reg_table_full.t2)), name_mapping$abbreviation)]

icv_gp_reg_table_full.t2_sig <- icv_gp_reg_table_full.t2 %>% filter(gp_p < 0.05)
icv_gp_reg_table_full.t2$gp_p_adj <- p.adjust(icv_gp_reg_table_full.t2$gp_p, method = "BH")
icv_gp_reg_table_full.t2_sig_MC <- icv_gp_reg_table_full.t2 %>% filter(gp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_gp_reg_table_full.t2
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gp_icv_all_t2.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_icv_global_t2.csv")
filename_regional <- paste0(output_folder, "gp_icv_regional_t2.csv")
write.csv(icv_gp_reg_table_global.t2, filename_global)
write.csv(icv_gp_reg_table_full.t2, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
gp_reg_table_all.t2 <- rbind(gp_reg_table_global.t2, gp_reg_table_full.t2)
icv_gp_reg_table_all.t2 <- rbind(icv_gp_reg_table_global.t2, icv_gp_reg_table_full.t2)
#all phenotypes
#univariate x~gp regression
gp_reg_table_all.t2$bw_lower <- (gp_reg_table_all.t2$gp_beta - 1.96*gp_reg_table_all.t2$gp_se)
gp_reg_table_all.t2$bw_upper <- (gp_reg_table_all.t2$gp_beta + 1.96*gp_reg_table_all.t2$gp_se)
gp_reg_table_all.t2 <- gp_reg_table_all.t2 %>% mutate(lm = "gp_uni")

#multivariate x~gp*bw regression, significant for gp_beta
icv_gp_reg_table_all.t2$bw_lower <- (icv_gp_reg_table_all.t2$gp_beta - 1.96*icv_gp_reg_table_all.t2$gp_se)
icv_gp_reg_table_all.t2$bw_upper <- (icv_gp_reg_table_all.t2$gp_beta + 1.96*icv_gp_reg_table_all.t2$gp_se)
icv_gp_reg_table_all.t2_plot <- icv_gp_reg_table_all.t2 %>% mutate(lm = "gp_icv") %>% select(all_of(names(gp_reg_table_all.t2)))
#combine tables
combined_gp_reg_table <- rbind(gp_reg_table_all.t2, icv_gp_reg_table_all.t2_plot)

#add a TRUE/FALSE column for gp_beta in the SAME direction, and for gp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(gp_reg_table_all.t2, icv_gp_reg_table_all.t2, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$gp_beta_uni) == sign(wide_combined_reg_table$gp_beta_icv)) & wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$gp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_gp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_gp_reg_table)),], aes(y = label, x = gp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("gp_uni" = "grey", "gp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "gp_beta_uni", "gp_p_adj_uni", "gp_beta_icv", "gp_p_adj_icv")]

(t2.icv_gp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, survive after controlling for icv, t2"))

(t2.icv_gp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, survive after controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".t2_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".t2_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'gp_beta_icv'])))

if(save_figures == TRUE){
panel_save(t2.icv_gp_survive_dkt_plot, "icv_gp_survive_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_gp_survive_aseg_plot, "icv_gp_survive_t2_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_gp_reg_table_full.t2_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_gp_reg_table_full.t2_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_gp_reg_table_full.t2_sig_MC[!(icv_gp_reg_table_full.t2_sig_MC$label %in% plot_data_dkt$label) & !(icv_gp_reg_table_full.t2_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.icv_gp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, full controlling for icv, t2"))

(t2.icv_gp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp, full controlling for icv, t2"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_gp_reg_table_full.t2_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_gp_reg_table_full.t2_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(t2.icv_gp_full_dkt_plot, "icv_gp_full_t2_dkt", "pdf", figure_panels_folder)
panel_save(t2.icv_gp_full_aseg_plot, "icv_gp_full_t2_aseg", "pdf", figure_panels_folder)
}
```





##LONG
###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge) & !is.na(long.full_test_df$bweight_percentile))
ga_zscore <- scale(long.full_test_df$gestAge)
bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ga_reg_table_global.long)), name_mapping$abbreviation)]

ga_reg_table_global.long_sig <- bwp_ga_reg_table_global.long %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global.long$ga_p_adj <- p.adjust(bwp_ga_reg_table_global.long$ga_p, method = "BH")
bwp_ga_reg_table_global.long$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global.long$bwp_p, method = "BH")
ga_reg_table_global.long_sig_MC <- bwp_ga_reg_table_global.long %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global.long_sig <- bwp_ga_reg_table_global.long %>% filter(bwp_p < 0.05)
bwpga_reg_table_global.long_sig_MC <- bwp_ga_reg_table_global.long %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global.long_sig_MC


#regional regression
bwp_ga_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ga_reg_table_full.long)), name_mapping$abbreviation)]

ga_reg_table_full.long_sig <- bwp_ga_reg_table_full.long %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full.long$ga_p_adj <- p.adjust(bwp_ga_reg_table_full.long$ga_p, method = "BH")
bwp_ga_reg_table_full.long$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full.long$bwp_p, method = "BH")
ga_reg_table_full.long_sig_MC <- bwp_ga_reg_table_full.long %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full.long_sig <- bwp_ga_reg_table_full.long %>% filter(bwp_p < 0.05)
bwpga_reg_table_full.long_sig_MC <- bwp_ga_reg_table_full.long %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ga_global_long.csv")
filename_regional <- paste0(output_folder, "bwp_ga_regional_long.csv")
write.csv(bwp_ga_reg_table_global.long, filename_global)
write.csv(bwp_ga_reg_table_full.long, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full.long_sig_MC[!(ga_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, long"))

(long.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_reg_table_full.long_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_reg_table_full.long_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(long.bwpga_ga_dkt_plot, "bwpga_ga_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwpga_ga_aseg_plot, "bwpga_ga_long_aseg", "pdf", figure_panels_folder)
}
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full.long_sig_MC[!(bwpga_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, long"))

(long.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwpga_reg_table_full.long_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwpga_reg_table_full.long_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(long.bwpga_bwp_dkt_plot, "bwpga_bwp_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwpga_bwp_aseg_plot, "bwpga_bwp_long_aseg", "pdf", figure_panels_folder)
}
```

###BW + BW PGS 
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bw_pgs) & !is.na(long.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(long.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- scale(long.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwbwpgs_reg_table_global.long)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global.long_sig <- bwbwpgs_reg_table_global.long %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global.long$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global.long$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global.long_sig_MC <- bwbwpgs_reg_table_global.long %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global.long_sig_MC

bw_bwbwpgs_reg_table_global.long_sig <- bwbwpgs_reg_table_global.long %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global.long$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global.long$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global.long_sig_MC <- bwbwpgs_reg_table_global.long %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global.long_sig_MC

#Regional variables
bwbwpgs_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwbwpgs_reg_table_full.long)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full.long_sig <- bwbwpgs_reg_table_full.long %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full.long$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full.long$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full.long_sig_MC <- bwbwpgs_reg_table_full.long %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full.long_sig <- bwbwpgs_reg_table_full.long %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full.long$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full.long$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full.long_sig_MC <- bwbwpgs_reg_table_full.long %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_bwpgs_global_long.csv")
filename_regional <- paste0(output_folder, "bw_bwpgs_regional_long.csv")
write.csv(bwbwpgs_reg_table_global.long, filename_global)
write.csv(bwbwpgs_reg_table_full.long, filename_regional)
}
```
###GA with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge) & !is.na(long.full_test_df$neonatal_comp_total))
ga_zscore <- scale(long.full_test_df$gestAge)
neocomp_zscore <- scale(long.full_test_df$neonatal_comp_total)

#Global phenotypes
ga_neocomp_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_neocomp_reg_table_global.long)), name_mapping$abbreviation)]

ga_neocomp_reg_table_global.long_sig <- ga_neocomp_reg_table_global.long %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_global.long$ga_p_adj <- p.adjust(ga_neocomp_reg_table_global.long$ga_p, method = "BH")
ga_neocomp_reg_table_global.long_sig_MC <- ga_neocomp_reg_table_global.long %>% filter(ga_p_adj < 0.05)

ga_neocomp_reg_table_global.long_sig_MC

#Regional phenotypes
ga_neocomp_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

ga_neocomp_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_neocomp_reg_table_full.long)), name_mapping$abbreviation)]

ga_neocomp_reg_table_full.long_sig <- ga_neocomp_reg_table_full.long %>% filter(ga_p < 0.05)
ga_neocomp_reg_table_full.long$ga_p_adj <- p.adjust(ga_neocomp_reg_table_full.long$ga_p, method = "BH")
ga_neocomp_reg_table_full.long_sig_MC <- ga_neocomp_reg_table_full.long %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- ga_neocomp_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_neocomp_all_long.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_neocomp_global_long.csv")
filename_regional <- paste0(output_folder, "ga_neocomp_regional_long.csv")
write.csv(ga_neocomp_reg_table_global.long, filename_global)
write.csv(ga_neocomp_reg_table_full.long, filename_regional)
}
```
###BW with neonatal comp as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$birth_weight_oz_sum_adj) & !is.na(long.full_test_df$neonatal_comp_total))
bw_zscore <- scale(long.full_test_df$birth_weight_oz_sum_adj)
neocomp_zscore <- scale(long.full_test_df$neonatal_comp_total)

#Global phenotypes
bw_neocomp_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_neocomp_reg_table_global.long)), name_mapping$abbreviation)]

bw_neocomp_reg_table_global.long_sig <- bw_neocomp_reg_table_global.long %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_global.long$bw_p_adj <- p.adjust(bw_neocomp_reg_table_global.long$bw_p, method = "BH")
bw_neocomp_reg_table_global.long_sig_MC <- bw_neocomp_reg_table_global.long %>% filter(bw_p_adj < 0.05)

bw_neocomp_reg_table_global.long_sig_MC

#Regional phenotypes
bw_neocomp_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + neocomp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2],
    neocomp_beta = summary$coefficients[3,1], neocomp_p = summary$coefficients[3,4], neocomp_se = summary$coefficients[3,2])
})))

bw_neocomp_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_neocomp_reg_table_full.long)), name_mapping$abbreviation)]

bw_neocomp_reg_table_full.long_sig <- bw_neocomp_reg_table_full.long %>% filter(bw_p < 0.05)
bw_neocomp_reg_table_full.long$bw_p_adj <- p.adjust(bw_neocomp_reg_table_full.long$bw_p, method = "BH")
bw_neocomp_reg_table_full.long_sig_MC <- bw_neocomp_reg_table_full.long %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- bw_neocomp_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_bw_neocomp_all_long.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_neocomp_global_long.csv")
filename_regional <- paste0(output_folder, "bw_neocomp_regional_long.csv")
write.csv(bw_neocomp_reg_table_global.long, filename_global)
write.csv(bw_neocomp_reg_table_full.long, filename_regional)
}
```
###Gestational Age - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
ga_zscore <- scale(long.full_test_df$gestAge)

#Global regression
ga_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_ses_reg_table_global.long)), name_mapping$abbreviation)]

ga_ses_table_global.long_sig <- ga_ses_reg_table_global.long %>% filter(ga_p < 0.05)
ga_ses_reg_table_global.long$ga_p_adj <- p.adjust(ga_ses_reg_table_global.long$ga_p, method = "BH")
ga_ses_reg_table_global.long_sig_MC <- ga_ses_reg_table_global.long %>% filter(ga_p_adj < 0.05)

ga_ses_reg_table_global.long_sig_MC

#regional regression
ga_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_ses_reg_table_full.long)), name_mapping$abbreviation)]

ga_ses_reg_table_full.long_sig <- ga_ses_reg_table_full.long %>% filter(ga_p < 0.05)
ga_ses_reg_table_full.long$ga_p_adj <- p.adjust(ga_ses_reg_table_full.long$ga_p, method = "BH")
ga_ses_reg_table_full.long_sig_MC <- ga_ses_reg_table_full.long %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_ses_global_long.csv")
filename_regional <- paste0(output_folder, "ga_ses_regional_long.csv")
write.csv(ga_ses_reg_table_global.long, filename_global)
write.csv(ga_ses_reg_table_full.long, filename_regional)
}
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_ses_reg_table_full.long_sig_MC[!(ga_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(ga_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.ga_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, long"))

(long.ga_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_ses_reg_table_full.long_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_ses_reg_table_full.long_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(long.ga_ses_dkt_plot, "ga_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.ga_ses_aseg_plot, "ga_ses_long_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$birth_weight_oz_sum_adj) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
bw_zscore <- scale(long.full_test_df$birth_weight_oz_sum_adj)

#Global regression
bw_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_ses_reg_table_global.long)), name_mapping$abbreviation)]

bw_ses_table_global.long_sig <- bw_ses_reg_table_global.long %>% filter(bw_p < 0.05)
bw_ses_reg_table_global.long$bw_p_adj <- p.adjust(bw_ses_reg_table_global.long$bw_p, method = "BH")
bw_ses_reg_table_global.long_sig_MC <- bw_ses_reg_table_global.long %>% filter(bw_p_adj < 0.05)

bw_ses_reg_table_global.long_sig_MC

#regional regression
bw_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_ses_reg_table_full.long)), name_mapping$abbreviation)]

bw_ses_reg_table_full.long_sig <- bw_ses_reg_table_full.long %>% filter(bw_p < 0.05)
bw_ses_reg_table_full.long$bw_p_adj <- p.adjust(bw_ses_reg_table_full.long$bw_p, method = "BH")
bw_ses_reg_table_full.long_sig_MC <- bw_ses_reg_table_full.long %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_ses_global_long.csv")
filename_regional <- paste0(output_folder, "bw_ses_regional_long.csv")
write.csv(bw_ses_reg_table_global.long, filename_global)
write.csv(bw_ses_reg_table_full.long, filename_regional)
}
```
####BW coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_ses_reg_table_full.long_sig_MC[!(bw_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bw_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bw_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, long"))

(long.bw_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with SES, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_ses_reg_table_full.long_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_ses_reg_table_full.long_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(long.bw_ses_dkt_plot, "bw_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bw_ses_aseg_plot, "bw_ses_long_aseg", "pdf", figure_panels_folder)
}
```

###birth weight percentile - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bweight_percentile) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
bwp_zscore <- scale(long.full_test_df$bweight_percentile)

#Global regression
bwp_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ses_reg_table_global.long)), name_mapping$abbreviation)]

bwp_ses_table_global.long_sig <- bwp_ses_reg_table_global.long %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_global.long$bwp_p_adj <- p.adjust(bwp_ses_reg_table_global.long$bwp_p, method = "BH")
bwp_ses_reg_table_global.long_sig_MC <- bwp_ses_reg_table_global.long %>% filter(bwp_p_adj < 0.05)

bwp_ses_reg_table_global.long_sig_MC

#regional regression
bwp_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ses_reg_table_full.long)), name_mapping$abbreviation)]

bwp_ses_reg_table_full.long_sig <- bwp_ses_reg_table_full.long %>% filter(bwp_p < 0.05)
bwp_ses_reg_table_full.long$bwp_p_adj <- p.adjust(bwp_ses_reg_table_full.long$bwp_p, method = "BH")
bwp_ses_reg_table_full.long_sig_MC <- bwp_ses_reg_table_full.long %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_ses_global_long.csv")
filename_regional <- paste0(output_folder, "bwp_ses_regional_long.csv")
write.csv(bwp_ses_reg_table_global.long, filename_global)
write.csv(bwp_ses_reg_table_full.long, filename_regional)
}
```
####bwp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_ses_reg_table_full.long_sig_MC[!(bwp_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bwp_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, long"))

(long.bwp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWP with SES, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_ses_reg_table_full.long_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_ses_reg_table_full.long_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(long.bwp_ses_dkt_plot, "bwp_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwp_ses_aseg_plot, "bwp_ses_long_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bw_pgs) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_ses_reg_table_global.long)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_global.long_sig <- bw_pgs_ses_reg_table_global.long %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_global.long$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_global.long$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_global.long_sig_MC <- bw_pgs_ses_reg_table_global.long %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_ses_reg_table_global.long_sig_MC

#Regional Phenotypes
bw_pgs_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[,which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_ses_reg_table_full.long)), name_mapping$abbreviation)]

bw_pgs_ses_reg_table_full.long_sig <- bw_pgs_ses_reg_table_full.long %>% filter(bw_pgs_p < 0.05)
bw_pgs_ses_reg_table_full.long$bw_pgs_p_adj <- p.adjust(bw_pgs_ses_reg_table_full.long$bw_pgs_p, method = "BH")
bw_pgs_ses_reg_table_full.long_sig_MC <- bw_pgs_ses_reg_table_full.long %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_ses_global_long.csv")
filename_regional <- paste0(output_folder, "bw_pgs_ses_regional_long.csv")
write.csv(bw_pgs_ses_reg_table_global.long, filename_global)
write.csv(bw_pgs_ses_reg_table_full.long, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_ses_reg_table_full.long_sig_MC[!(bw_pgs_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpgs_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES long"))

(long.bwpgs_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs SES long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_ses_reg_table_full.long_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_ses_reg_table_full.long_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(long.bwpgs_ses_dkt_plot, "bw_pgs_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwpgs_ses_aseg_plot, "bw_pgs_ses_long_aseg", "pdf", figure_panels_folder)
}
```
###Neocomp Total - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$neonatal_comp_total) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
neocomp_zscore <- scale(long.full_test_df$neonatal_comp_total)

#Global regression
neocomp_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(neocomp_ses_reg_table_global.long)), name_mapping$abbreviation)]

neocomp_ses_table_global.long_sig <- neocomp_ses_reg_table_global.long %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_global.long$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_global.long$neocomp_p, method = "BH")
neocomp_ses_reg_table_global.long_sig_MC <- neocomp_ses_reg_table_global.long %>% filter(neocomp_p_adj < 0.05)

neocomp_ses_reg_table_global.long_sig_MC

#regional regression
neocomp_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(neocomp_ses_reg_table_full.long)), name_mapping$abbreviation)]

neocomp_ses_reg_table_full.long_sig <- neocomp_ses_reg_table_full.long %>% filter(neocomp_p < 0.05)
neocomp_ses_reg_table_full.long$neocomp_p_adj <- p.adjust(neocomp_ses_reg_table_full.long$neocomp_p, method = "BH")
neocomp_ses_reg_table_full.long_sig_MC <- neocomp_ses_reg_table_full.long %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_ses_global_long.csv")
filename_regional <- paste0(output_folder, "neocomp_ses_regional_long.csv")
write.csv(neocomp_ses_reg_table_global.long, filename_global)
write.csv(neocomp_ses_reg_table_full.long, filename_regional)
}
```
####Surface plots - neocomp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_ses_reg_table_full.long_sig_MC[!(neocomp_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),] %>% 
  select(c('neocomp_beta', 'neocomp_p_adj', 'label'))

# Plot using ggseg
(long.neocomp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, long"))

(long.neocomp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp with SES, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_ses_reg_table_full.long_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_ses_reg_table_full.long_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(long.neocomp_ses_dkt_plot, "neocomp_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.neocomp_ses_aseg_plot, "neocomp_ses_long_aseg", "pdf", figure_panels_folder)
}
```

###general P-factor - SES as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p.long) & !is.na(long.full_test_df$combo.income_ordered) & !is.na(long.full_test_df$combo.prnt_edu_ordered))
gp_zscore <- scale(long.full_test_df$General_p.long)

#Global regression
gp_ses_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_ses_reg_table_global.long)), name_mapping$abbreviation)]

gp_ses_table_global.long_sig <- gp_ses_reg_table_global.long %>% filter(gp_p < 0.05)
gp_ses_reg_table_global.long$gp_p_adj <- p.adjust(gp_ses_reg_table_global.long$gp_p, method = "BH")
gp_ses_reg_table_global.long_sig_MC <- gp_ses_reg_table_global.long %>% filter(gp_p_adj < 0.05)

gp_ses_reg_table_global.long_sig_MC

#regional regression
gp_ses_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_ses_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_ses_reg_table_full.long)), name_mapping$abbreviation)]

gp_ses_reg_table_full.long_sig <- gp_ses_reg_table_full.long %>% filter(gp_p < 0.05)
gp_ses_reg_table_full.long$gp_p_adj <- p.adjust(gp_ses_reg_table_full.long$gp_p, method = "BH")
gp_ses_reg_table_full.long_sig_MC <- gp_ses_reg_table_full.long %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_ses_global_long.csv")
filename_regional <- paste0(output_folder, "gp_ses_regional_long.csv")
write.csv(gp_ses_reg_table_global.long, filename_global)
write.csv(gp_ses_reg_table_full.long, filename_regional)
}
```
####gp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_ses_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_ses_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_ses_reg_table_full.long_sig_MC[!(gp_ses_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(gp_ses_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.gp_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, long"))

(long.gp_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp with SES, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_ses_reg_table_full.long_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_ses_reg_table_full.long_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(long.gp_ses_dkt_plot, "gp_ses_long_dkt", "pdf", figure_panels_folder)
panel_save(long.gp_ses_aseg_plot, "gp_ses_long_aseg", "pdf", figure_panels_folder)
}
```
###GA - weight & height as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))

df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(long.full_test_df$anthroweightcalc)
df$height_zscore <- scale(long.full_test_df$anthroheightcalc)
df$ga_zscore <- scale(long.full_test_df$gestAge)

#Global phenotypes
ga_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_wh_reg_table_global.long)), name_mapping$abbreviation)]

ga_wh_reg_table_global.long_sig <- ga_wh_reg_table_global.long %>% filter(ga_p < 0.05)
ga_wh_reg_table_global.long$ga_p_adj <- p.adjust(ga_wh_reg_table_global.long$ga_p, method = "BH")
ga_wh_reg_table_global.long_sig_MC <- ga_wh_reg_table_global.long %>% filter(ga_p_adj < 0.05)

ga_wh_reg_table_global.long_sig_MC

#Regional phenotypes
ga_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_wh_reg_table_full.long)), name_mapping$abbreviation)]

ga_wh_reg_table_full.long_sig <- ga_wh_reg_table_full.long %>% filter(ga_p < 0.05)
ga_wh_reg_table_full.long$ga_p_adj <- p.adjust(ga_wh_reg_table_full.long$ga_p, method = "BH")
ga_wh_reg_table_full.long_sig_MC <- ga_wh_reg_table_full.long %>% filter(ga_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_wh_global_long.csv")
filename_regional <- paste0(output_folder, "ga_wh_regional_long.csv")
write.csv(ga_wh_reg_table_global.long, filename_global)
write.csv(ga_wh_reg_table_full.long, filename_regional)
}
```
####surface plots
```{r}
ga_wh_reg_table_full.long_sig_MC$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(ga_wh_reg_table_full.long_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_wh_reg_table_full.long_sig_MC[!(ga_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(ga_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.ga_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, long"))

(long.ga_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with weight/height, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(ga_wh_reg_table_full.long_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(ga_wh_reg_table_full.long_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(long.ga_wh_dkt_plot, "ga_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.ga_wh_aseg_plot, "ga_wh_long_aseg", "pdf", figure_panels_folder)
}
```
###birth weight - weight & height as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$birth_weight_oz_sum_adj) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))

df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(long.full_test_df$anthroweightcalc)
df$height_zscore <- scale(long.full_test_df$anthroheightcalc)
df$bw_zscore <- scale(long.full_test_df$birth_weight_oz_sum_adj)

#Global phenotypes
bw_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_wh_reg_table_global.long)), name_mapping$abbreviation)]

bw_wh_reg_table_global.long_sig <- bw_wh_reg_table_global.long %>% filter(bw_p < 0.05)
bw_wh_reg_table_global.long$bw_p_adj <- p.adjust(bw_wh_reg_table_global.long$bw_p, method = "BH")
bw_wh_reg_table_global.long_sig_MC <- bw_wh_reg_table_global.long %>% filter(bw_p_adj < 0.05)

bw_wh_reg_table_global.long_sig_MC

#Regional phenotypes
bw_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_wh_reg_table_full.long)), name_mapping$abbreviation)]

bw_wh_reg_table_full.long_sig <- bw_wh_reg_table_full.long %>% filter(bw_p < 0.05)
bw_wh_reg_table_full.long$bw_p_adj <- p.adjust(bw_wh_reg_table_full.long$bw_p, method = "BH")
bw_wh_reg_table_full.long_sig_MC <- bw_wh_reg_table_full.long %>% filter(bw_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_wh_global_long.csv")
filename_regional <- paste0(output_folder, "bw_wh_regional_long.csv")
write.csv(bw_wh_reg_table_global.long, filename_global)
write.csv(bw_wh_reg_table_full.long, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_wh_reg_table_full.long_sig_MC[!(bw_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bw_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),c("bw_beta", "bw_p_adj", "label")]

# Plot using ggseg
(long.bw_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, long"))

(long.bw_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BW with weight/height, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_wh_reg_table_full.long_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_wh_reg_table_full.long_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(long.bw_wh_dkt_plot, "bw_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bw_wh_aseg_plot, "bw_wh_long_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile - weight & height as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bweight_percentile) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))

df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(long.full_test_df$anthroweightcalc)
df$height_zscore <- scale(long.full_test_df$anthroheightcalc)
df$bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)

#Global phenotypes
bwp_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_wh_reg_table_global.long)), name_mapping$abbreviation)]

bwp_wh_reg_table_global.long_sig <- bwp_wh_reg_table_global.long %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_global.long$bwp_p_adj <- p.adjust(bwp_wh_reg_table_global.long$bwp_p, method = "BH")
bwp_wh_reg_table_global.long_sig_MC <- bwp_wh_reg_table_global.long %>% filter(bwp_p_adj < 0.05)

bwp_wh_reg_table_global.long_sig_MC

#Regional phenotypes
bwp_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bwp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

bwp_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_wh_reg_table_full.long)), name_mapping$abbreviation)]

bwp_wh_reg_table_full.long_sig <- bwp_wh_reg_table_full.long %>% filter(bwp_p < 0.05)
bwp_wh_reg_table_full.long$bwp_p_adj <- p.adjust(bwp_wh_reg_table_full.long$bwp_p, method = "BH")
bwp_wh_reg_table_full.long_sig_MC <- bwp_wh_reg_table_full.long %>% filter(bwp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_wh_global_long.csv")
filename_regional <- paste0(output_folder, "bwp_wh_regional_long.csv")
write.csv(bwp_wh_reg_table_global.long, filename_global)
write.csv(bwp_wh_reg_table_full.long, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_wh_reg_table_full.long_sig_MC[!(bwp_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bwp_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),c("bwp_beta", "bwp_p_adj", "label")]

# Plot using ggseg
(long.bwp_wh_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, long"))

(long.bwp_wh_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                     limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "BWp with weight/height, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bwp_wh_reg_table_full.long_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bwp_wh_reg_table_full.long_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(long.bwp_wh_dkt_plot, "bwp_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwp_wh_aseg_plot, "bwp_wh_long_aseg", "pdf", figure_panels_folder)
}
```

###PRS-bw - wh as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bw_pgs) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))

#Global Phenotypes
bw_pgs_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + long.full_test_df$anthroweightcalc + long.full_test_df$anthroheightcalc + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_wh_reg_table_global.long)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_global.long_sig <- bw_pgs_wh_reg_table_global.long %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_global.long$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_global.long$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_global.long_sig_MC <- bw_pgs_wh_reg_table_global.long %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_wh_reg_table_global.long_sig_MC

#Regional Phenotypes
bw_pgs_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[,which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + long.full_test_df$combo.income_ordered + long.full_test_df$combo.prnt_edu_ordered + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_wh_reg_table_full.long)), name_mapping$abbreviation)]

bw_pgs_wh_reg_table_full.long_sig <- bw_pgs_wh_reg_table_full.long %>% filter(bw_pgs_p < 0.05)
bw_pgs_wh_reg_table_full.long$bw_pgs_p_adj <- p.adjust(bw_pgs_wh_reg_table_full.long$bw_pgs_p, method = "BH")
bw_pgs_wh_reg_table_full.long_sig_MC <- bw_pgs_wh_reg_table_full.long %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-betas_folder
  filename_global <- paste0(output_folder, "bw_pgs_wh_global_long.csv")
  filename_regional <- paste0(output_folder, "bw_pgs_wh_regional_long.csv")
  write.csv(bw_pgs_wh_reg_table_global.long, filename_global)
  write.csv(bw_pgs_wh_reg_table_full.long, filename_regional)
}
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_wh_reg_table_full.long_sig_MC[!(bw_pgs_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpgs_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh long"))

(long.bwpgs_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = bw_pgs_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "BW_pgs wh long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(bw_pgs_wh_reg_table_full.long_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(bw_pgs_wh_reg_table_full.long_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(long.bwpgs_wh_dkt_plot, "bw_pgs_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.bwpgs_wh_aseg_plot, "bw_pgs_wh_long_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal comp - weight & height as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$neonatal_comp_total) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))

df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(long.full_test_df$anthroweightcalc)
df$height_zscore <- scale(long.full_test_df$anthroheightcalc)
df$neocomp_zscore <- scale(long.full_test_df$neonatal_comp_total)

#Global phenotypes
neocomp_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(neocomp_wh_reg_table_global.long)), name_mapping$abbreviation)]

neocomp_wh_reg_table_global.long_sig <- neocomp_wh_reg_table_global.long %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_global.long$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_global.long$neocomp_p, method = "BH")
neocomp_wh_reg_table_global.long_sig_MC <- neocomp_wh_reg_table_global.long %>% filter(neocomp_p_adj < 0.05)

neocomp_wh_reg_table_global.long_sig_MC

#Regional phenotypes
neocomp_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

neocomp_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(neocomp_wh_reg_table_full.long)), name_mapping$abbreviation)]

neocomp_wh_reg_table_full.long_sig <- neocomp_wh_reg_table_full.long %>% filter(neocomp_p < 0.05)
neocomp_wh_reg_table_full.long$neocomp_p_adj <- p.adjust(neocomp_wh_reg_table_full.long$neocomp_p, method = "BH")
neocomp_wh_reg_table_full.long_sig_MC <- neocomp_wh_reg_table_full.long %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_wh_global_long.csv")
filename_regional <- paste0(output_folder, "neocomp_wh_regional_long.csv")
write.csv(neocomp_wh_reg_table_global.long, filename_global)
write.csv(neocomp_wh_reg_table_full.long, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(neocomp_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neocomp_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neocomp_wh_reg_table_full.long_sig_MC[!(neocomp_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(neocomp_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),c("neocomp_beta", "neocomp_p_adj", "label")]

# Plot using ggseg
(long.neocomp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, long"))

(long.neocomp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = neocomp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "neocomp with weight/height, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(neocomp_wh_reg_table_full.long_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(neocomp_wh_reg_table_full.long_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(long.neocomp_wh_dkt_plot, "neocomp_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.neocomp_wh_aseg_plot, "neocomp_wh_long_aseg", "pdf", figure_panels_folder)
}
```

###General p - weight & height as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p.long) & !is.na(long.full_test_df$anthroweightcalc) & !is.na(long.full_test_df$anthroheightcalc))

df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$weight_zscore <- scale(long.full_test_df$anthroweightcalc)
df$height_zscore <- scale(long.full_test_df$anthroheightcalc)
df$gp_zscore <- scale(long.full_test_df$General_p.long)

#Global phenotypes
gp_wh_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_wh_reg_table_global.long)), name_mapping$abbreviation)]

gp_wh_reg_table_global.long_sig <- gp_wh_reg_table_global.long %>% filter(gp_p < 0.05)
gp_wh_reg_table_global.long$gp_p_adj <- p.adjust(gp_wh_reg_table_global.long$gp_p, method = "BH")
gp_wh_reg_table_global.long_sig_MC <- gp_wh_reg_table_global.long %>% filter(gp_p_adj < 0.05)

gp_wh_reg_table_global.long_sig_MC

#Regional phenotypes
gp_wh_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + weight_zscore + height_zscore, data = df)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_wh_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_wh_reg_table_full.long)), name_mapping$abbreviation)]

gp_wh_reg_table_full.long_sig <- gp_wh_reg_table_full.long %>% filter(gp_p < 0.05)
gp_wh_reg_table_full.long$gp_p_adj <- p.adjust(gp_wh_reg_table_full.long$gp_p, method = "BH")
gp_wh_reg_table_full.long_sig_MC <- gp_wh_reg_table_full.long %>% filter(gp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gp_wh_global_long.csv")
filename_regional <- paste0(output_folder, "gp_wh_regional_long.csv")
write.csv(gp_wh_reg_table_global.long, filename_global)
write.csv(gp_wh_reg_table_full.long, filename_regional)
}
```
####surface plots
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_wh_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_wh_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_wh_reg_table_full.long_sig_MC[!(gp_wh_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(gp_wh_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),c("gp_beta", "gp_p_adj", "label")]

# Plot using ggseg
(long.gp_wh_dkt_plot <- ggplot(plot_data_dkt) +
    geom_brain(atlas = dk, 
               position = position_brain(hemi ~ side),
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, long"))

(long.gp_wh_aseg_plot <- ggplot(plot_data_aseg) +
    geom_brain(atlas = aseg,
               aes(fill = gp_beta)) +
    scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                         limits = c(-0.23, 0.23)) +
    theme_void() +
    labs(title = "gp with weight/height, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(gp_wh_reg_table_full.long_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(gp_wh_reg_table_full.long_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(long.gp_wh_dkt_plot, "gp_wh_long_dkt", "pdf", figure_panels_folder)
panel_save(long.gp_wh_aseg_plot, "gp_wh_long_aseg", "pdf", figure_panels_folder)
}
```

##LONG - controlling for intracranial volume
###Gestational Age
####linear regressions
```{r}
ga_zscore <- scale(long.full_test_df$gestAge)
total_volume_zcore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global phenotypes
icv_ga_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_ga_reg_table_global.long)), name_mapping$abbreviation)]

icv_ga_reg_table_global.long_sig <- icv_ga_reg_table_global.long %>% filter(ga_p < 0.05)
icv_ga_reg_table_global.long$ga_p_adj <- p.adjust(icv_ga_reg_table_global.long$ga_p, method = "BH")
icv_ga_reg_table_global.long_sig_MC <- icv_ga_reg_table_global.long %>% filter(ga_p_adj < 0.05)

icv_ga_reg_table_global.long_sig_MC

#Regional phenotypes
icv_ga_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

icv_ga_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_ga_reg_table_full.long)), name_mapping$abbreviation)]

icv_ga_reg_table_full.long_sig <- icv_ga_reg_table_full.long %>% filter(ga_p < 0.05)
icv_ga_reg_table_full.long$ga_p_adj <- p.adjust(icv_ga_reg_table_full.long$ga_p, method = "BH")
icv_ga_reg_table_full.long_sig_MC <- icv_ga_reg_table_full.long %>% filter(ga_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_ga_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gestAge_icv_all_long.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "ga_icv_global_long.csv")
filename_regional <- paste0(output_folder, "ga_icv_regional_long.csv")
write.csv(icv_ga_reg_table_global.long, filename_global)
write.csv(icv_ga_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
ga_reg_table_all.long <- rbind(ga_reg_table_global.long, ga_reg_table_full.long)
icv_ga_reg_table_all.long <- rbind(icv_ga_reg_table_global.long, icv_ga_reg_table_full.long)
#all phenotypes
#univariate x~ga regression
ga_reg_table_all.long$ga_lower <- (ga_reg_table_all.long$ga_beta - 1.96*ga_reg_table_all.long$ga_se)
ga_reg_table_all.long$ga_upper <- (ga_reg_table_all.long$ga_beta + 1.96*ga_reg_table_all.long$ga_se)
ga_reg_table_all.long <- ga_reg_table_all.long %>% mutate(lm = "ga_uni")

#multivariate x~ga*bw regression, significant for ga_beta
icv_ga_reg_table_all.long$ga_lower <- (icv_ga_reg_table_all.long$ga_beta - 1.96*icv_ga_reg_table_all.long$ga_se)
icv_ga_reg_table_all.long$ga_upper <- (icv_ga_reg_table_all.long$ga_beta + 1.96*icv_ga_reg_table_all.long$ga_se)
icv_ga_reg_table_all.long_plot <- icv_ga_reg_table_all.long %>% mutate(lm = "ga_icv") %>% select(all_of(names(ga_reg_table_all.long)))
#combine tables
combined_reg_table <- rbind(ga_reg_table_all.long, icv_ga_reg_table_all.long_plot)

#add a TRUE/FALSE column for ga_beta in the SAME direction, and for ga_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(ga_reg_table_all.long, icv_ga_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$ga_beta_uni) == sign(wide_combined_reg_table$ga_beta_icv)) & wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$ga_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = ga_beta, xmin = ga_lower, xmax = ga_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("ga_uni" = "grey", "ga_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "ga_beta_uni", "ga_p_adj_uni", "ga_beta_icv", "ga_p_adj_icv")]

(long.icv_ga_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, long"))

(long.icv_ga_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(ga_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$ga_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'ga_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_ga_survive_dkt_plot, "icv_ga_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_ga_survive_aseg_plot, "icv_ga_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_ga_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_ga_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_ga_reg_table_full.long_sig_MC[!(icv_ga_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_ga_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_ga_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, long"))

(long.icv_ga_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_ga_reg_table_full.long_sig_MC %>% filter(ga_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_ga_reg_table_full.long_sig_MC$ga_beta)))

if(save_figures == TRUE){
panel_save(long.icv_ga_full_dkt_plot, "icv_ga_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_ga_full_aseg_plot, "icv_ga_full_long_aseg", "pdf", figure_panels_folder)
}
```
###birth weight
####linear regressions
```{r}
df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$bw_zscore <- scale(long.full_test_df$birth_weight_oz_sum_adj)
df$total_volume_zcore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global phenotypes -- save betas and p-values
icv_bw_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bw_reg_table_global.long)), name_mapping$abbreviation)]

icv_bw_reg_table_global.long_sig <- icv_bw_reg_table_global.long %>% filter(bw_p < 0.05)
icv_bw_reg_table_global.long$bw_p_adj <- p.adjust(icv_bw_reg_table_global.long$bw_p, method = "BH")
icv_bw_reg_table_global.long_sig_MC <- icv_bw_reg_table_global.long %>% filter(bw_p_adj < 0.05)

icv_bw_reg_table_global.long_sig_MC

#Regional phenotypes -- save betas and p-values
icv_bw_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore + total_volume_zcore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

icv_bw_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bw_reg_table_full.long)), name_mapping$abbreviation)]

icv_bw_reg_table_full.long_sig <- icv_bw_reg_table_full.long %>% filter(bw_p < 0.05)
icv_bw_reg_table_full.long$bw_p_adj <- p.adjust(icv_bw_reg_table_full.long$bw_p, method = "BH")
icv_bw_reg_table_full.long_sig_MC <- icv_bw_reg_table_full.long %>% filter(bw_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_icv_all_long.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_icv_sig_long.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_icv_global_long.csv")
filename_regional <- paste0(output_folder, "bw_icv_regional_long.csv")
write.csv(icv_bw_reg_table_global.long, filename_global)
write.csv(icv_bw_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_reg_table_all.long <- rbind(bw_reg_table_global.long, bw_reg_table_full.long)
icv_bw_reg_table_all.long <- rbind(icv_bw_reg_table_global.long, icv_bw_reg_table_full.long)
#all phenotypes
#univariate x~ga regression
bw_reg_table_all.long$bw_lower <- (bw_reg_table_all.long$bw_beta - 1.96*bw_reg_table_all.long$bw_se)
bw_reg_table_all.long$bw_upper <- (bw_reg_table_all.long$bw_beta + 1.96*bw_reg_table_all.long$bw_se)
bw_reg_table_all.long <- bw_reg_table_all.long %>% mutate(lm = "bw_uni")

#multivariate x~ga*bw regression, significant for bw_beta
icv_bw_reg_table_all.long$bw_lower <- (icv_bw_reg_table_all.long$bw_beta - 1.96*icv_bw_reg_table_all.long$bw_se)
icv_bw_reg_table_all.long$bw_upper <- (icv_bw_reg_table_all.long$bw_beta + 1.96*icv_bw_reg_table_all.long$bw_se)
icv_bw_reg_table_all.long_plot <- icv_bw_reg_table_all.long %>% mutate(lm = "bw_icv") %>% select(all_of(names(bw_reg_table_all.long)))
#combine tables
combined_reg_table <- rbind(bw_reg_table_all.long, icv_bw_reg_table_all.long_plot)

#add a TRUE/FALSE column for bw_beta in the SAME direction, and for bw_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_reg_table_all.long, icv_bw_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_beta_uni) == sign(wide_combined_reg_table$bw_beta_icv)) & wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$bw_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = bw_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_uni" = "grey", "bw_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_beta_uni", "bw_p_adj_uni", "bw_beta_icv", "bw_p_adj_icv")]

(long.icv_bw_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, long"))

(long.icv_bw_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_bw_survive_dkt_plot, "icv_bw_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bw_survive_aseg_plot, "icv_bw_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_reg_table_full.long_sig_MC[!(icv_bw_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_bw_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, long"))

(long.icv_bw_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_reg_table_full.long_sig_MC %>% filter(bw_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_reg_table_full.long_sig_MC$bw_beta)))

if(save_figures == TRUE){
panel_save(long.icv_bw_full_dkt_plot, "icv_bw_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bw_full_aseg_plot, "icv_bw_full_long_aseg", "pdf", figure_panels_folder)
}
```
###birth weight percentile
####linear regressions
```{r}
bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)
total_volume_zcore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global Phenotypes
icv_bwp_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bwp_reg_table_global.long)), name_mapping$abbreviation)]

icv_bwp_reg_table_global.long_sig <- icv_bwp_reg_table_global.long %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_global.long$bwp_p_adj <- p.adjust(icv_bwp_reg_table_global.long$bwp_p, method = "BH")
icv_bwp_reg_table_global.long_sig_MC <- icv_bwp_reg_table_global.long %>% filter(bwp_p_adj < 0.05)

icv_bwp_reg_table_global.long_sig_MC

#Regional Phenotypes
icv_bwp_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore + total_volume_zcore)
  summary <- summary(lm)
  
  c(bwp_beta = summary$coefficients[2,1], bwp_p = summary$coefficients[2,4], bwp_se = summary$coefficients[2,2])
})))

icv_bwp_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bwp_reg_table_full.long)), name_mapping$abbreviation)]

icv_bwp_reg_table_full.long_sig <- icv_bwp_reg_table_full.long %>% filter(bwp_p < 0.05)
icv_bwp_reg_table_full.long$bwp_p_adj <- p.adjust(icv_bwp_reg_table_full.long$bwp_p, method = "BH")
icv_bwp_reg_table_full.long_sig_MC <- icv_bwp_reg_table_full.long %>% filter(bwp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bwp_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_icv_all_long.csv")
  write.csv(save_table_full, filename_all)
}

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bwp_icv_global_long.csv")
filename_regional <- paste0(output_folder, "bwp_icv_regional_long.csv")
write.csv(icv_bwp_reg_table_global.long, filename_global)
write.csv(icv_bwp_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bwp_reg_table_all.long <- rbind(bwp_reg_table_global.long, bwp_reg_table_full.long)
icv_bwp_reg_table_all.long <- rbind(icv_bwp_reg_table_global.long, icv_bwp_reg_table_full.long)
#all phenotypes
#univariate x~bwp regression
bwp_reg_table_all.long$bwp_lower <- (bwp_reg_table_all.long$bwp_beta - 1.96*bwp_reg_table_all.long$bwp_se)
bwp_reg_table_all.long$bwp_upper <- (bwp_reg_table_all.long$bwp_beta + 1.96*bwp_reg_table_all.long$bwp_se)
bwp_reg_table_all.long <- bwp_reg_table_all.long %>% mutate(lm = "bwp_uni")

#multivariate x~bwp*bw regression, significant for bwp_beta
icv_bwp_reg_table_all.long$bwp_lower <- (icv_bwp_reg_table_all.long$bwp_beta - 1.96*icv_bwp_reg_table_all.long$bwp_se)
icv_bwp_reg_table_all.long$bwp_upper <- (icv_bwp_reg_table_all.long$bwp_beta + 1.96*icv_bwp_reg_table_all.long$bwp_se)
icv_bwp_reg_table_all.long_plot <- icv_bwp_reg_table_all.long %>% mutate(lm = "bwp_icv") %>% select(all_of(names(bwp_reg_table_all.long)))
#combine tables
combined_bwp_reg_table <- rbind(bwp_reg_table_all.long, icv_bwp_reg_table_all.long_plot)

#add a TRUE/FALSE column for bwp_beta in the SAME direction, and for bwp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bwp_reg_table_all.long, icv_bwp_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bwp_beta_uni) == sign(wide_combined_reg_table$bwp_beta_icv)) & wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$bwp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bwp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bwp_reg_table)),], aes(y = label, x = bwp_beta, xmin = bwp_lower, xmax = bwp_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bwp_uni" = "grey", "bwp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bwp_beta_uni", "bwp_p_adj_uni", "bwp_beta_icv", "bwp_p_adj_icv")]

(long.icv_bwp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, long"))

(long.icv_bwp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bwp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bwp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bwp_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_bwp_survive_dkt_plot, "icv_bwp_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bwp_survive_aseg_plot, "icv_bwp_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bwp_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bwp_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bwp_reg_table_full.long_sig_MC[!(icv_bwp_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_bwp_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_bwp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, long"))

(long.icv_bwp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bwp, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bwp_reg_table_full.long_sig_MC %>% filter(bwp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bwp_reg_table_full.long_sig_MC$bwp_beta)))

if(save_figures == TRUE){
panel_save(long.icv_bwp_full_dkt_plot, "icv_bwp_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bwp_full_aseg_plot, "icv_bwp_full_long_aseg", "pdf", figure_panels_folder)
}
```
###PRS-bw
####linear regressions
```{r}
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {scale(x)}))
total_volume_zscore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global Phenotypes
icv_bw_pgs_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bw_pgs_reg_table_global.long)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_global.long_sig <- icv_bw_pgs_reg_table_global.long %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_global.long$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_global.long$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_global.long_sig_MC <- icv_bw_pgs_reg_table_global.long %>% filter(bw_pgs_p_adj < 0.05)

icv_bw_pgs_reg_table_global.long_sig_MC

#Regional Phenotypes
icv_bw_pgs_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[,which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + total_volume_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

icv_bw_pgs_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_bw_pgs_reg_table_full.long)), name_mapping$abbreviation)]

icv_bw_pgs_reg_table_full.long_sig <- icv_bw_pgs_reg_table_full.long %>% filter(bw_pgs_p < 0.05)
icv_bw_pgs_reg_table_full.long$bw_pgs_p_adj <- p.adjust(icv_bw_pgs_reg_table_full.long$bw_pgs_p, method = "BH")
icv_bw_pgs_reg_table_full.long_sig_MC <- icv_bw_pgs_reg_table_full.long %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_bw_pgs_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_icv_all_long.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "bw_pgs_icv_global_long.csv")
filename_regional <- paste0(output_folder, "bw_pgs_icv_regional_long.csv")
write.csv(icv_bw_pgs_reg_table_global.long, filename_global)
write.csv(icv_bw_pgs_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
bw_pgs_reg_table_all.long <- rbind(bw_pgs_reg_table_global.long, bw_pgs_reg_table_full.long)
icv_bw_pgs_reg_table_all.long <- rbind(icv_bw_pgs_reg_table_global.long, icv_bw_pgs_reg_table_full.long)
#all phenotypes
#univariate x~bw_pgs regression
bw_pgs_reg_table_all.long$bw_lower <- (bw_pgs_reg_table_all.long$bw_pgs_beta - 1.96*bw_pgs_reg_table_all.long$bw_pgs_se)
bw_pgs_reg_table_all.long$bw_upper <- (bw_pgs_reg_table_all.long$bw_pgs_beta + 1.96*bw_pgs_reg_table_all.long$bw_pgs_se)
bw_pgs_reg_table_all.long <- bw_pgs_reg_table_all.long %>% mutate(lm = "bw_pgs_uni")

#multivariate x~bw_pgs*bw regression, significant for bw_pgs_beta
icv_bw_pgs_reg_table_all.long$bw_lower <- (icv_bw_pgs_reg_table_all.long$bw_pgs_beta - 1.96*icv_bw_pgs_reg_table_all.long$bw_pgs_se)
icv_bw_pgs_reg_table_all.long$bw_upper <- (icv_bw_pgs_reg_table_all.long$bw_pgs_beta + 1.96*icv_bw_pgs_reg_table_all.long$bw_pgs_se)
icv_bw_pgs_reg_table_all.long_plot <- icv_bw_pgs_reg_table_all.long %>% mutate(lm = "bw_pgs_icv") %>% select(all_of(names(bw_pgs_reg_table_all.long)))
#combine tables
combined_bw_pgs_reg_table <- rbind(bw_pgs_reg_table_all.long, icv_bw_pgs_reg_table_all.long_plot)

#add a TRUE/FALSE column for bw_pgs_beta in the SAME direction, and for bw_pgs_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(bw_pgs_reg_table_all.long, icv_bw_pgs_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$bw_pgs_beta_uni) == sign(wide_combined_reg_table$bw_pgs_beta_icv)) & wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$bw_pgs_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_bw_pgs_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_bw_pgs_reg_table)),], aes(y = label, x = bw_pgs_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("bw_pgs_uni" = "grey", "bw_pgs_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")
```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "bw_pgs_beta_uni", "bw_pgs_p_adj_uni", "bw_pgs_beta_icv", "bw_pgs_p_adj_icv")]

(long.icv_bw_pgs_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, long"))

(long.icv_bw_pgs_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(bw_pgs_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$bw_pgs_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'bw_pgs_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_bw_pgs_survive_dkt_plot, "icv_bw_pgs_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bw_pgs_survive_aseg_plot, "icv_bw_pgs_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_bw_pgs_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_bw_pgs_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_bw_pgs_reg_table_full.long_sig_MC[!(icv_bw_pgs_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_bw_pgs_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_bw_pgs_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, long"))

(long.icv_bw_pgs_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "bw_pgs, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_bw_pgs_reg_table_full.long_sig_MC %>% filter(bw_pgs_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_bw_pgs_reg_table_full.long_sig_MC$bw_pgs_beta)))

if(save_figures == TRUE){
panel_save(long.icv_bw_pgs_full_dkt_plot, "icv_bw_pgs_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_bw_pgs_full_aseg_plot, "icv_bw_pgs_full_long_aseg", "pdf", figure_panels_folder)
}
```
###Neonatal Comp
####linear regressions
```{r}
neocomp_zscore <- scale(long.full_test_df$neonatal_comp_total)
total_volume_zscore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global Phenotypes
icv_neocomp_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_neocomp_reg_table_global.long)), name_mapping$abbreviation)]

icv_neocomp_reg_table_global.long_sig <- icv_neocomp_reg_table_global.long %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_global.long$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_global.long$neocomp_p, method = "BH")
icv_neocomp_reg_table_global.long_sig_MC <- icv_neocomp_reg_table_global.long %>% filter(neocomp_p_adj < 0.05)

icv_neocomp_reg_table_global.long_sig_MC

#Regional Phenotypes
icv_neocomp_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ neocomp_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(neocomp_beta = summary$coefficients[2,1], neocomp_p = summary$coefficients[2,4], neocomp_se = summary$coefficients[2,2])
})))

icv_neocomp_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_neocomp_reg_table_full.long)), name_mapping$abbreviation)]

icv_neocomp_reg_table_full.long_sig <- icv_neocomp_reg_table_full.long %>% filter(neocomp_p < 0.05)
icv_neocomp_reg_table_full.long$neocomp_p_adj <- p.adjust(icv_neocomp_reg_table_full.long$neocomp_p, method = "BH")
icv_neocomp_reg_table_full.long_sig_MC <- icv_neocomp_reg_table_full.long %>% filter(neocomp_p_adj < 0.05)

if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "neocomp_icv_global_long.csv")
filename_regional <- paste0(output_folder, "neocomp_icv_regional_long.csv")
write.csv(icv_neocomp_reg_table_global.long, filename_global)
write.csv(icv_neocomp_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
neocomp_reg_table_all.long <- rbind(neocomp_reg_table_global.long, neocomp_reg_table_full.long)
icv_neocomp_reg_table_all.long <- rbind(icv_neocomp_reg_table_global.long, icv_neocomp_reg_table_full.long)
#all phenotypes
#univariate x~neocomp regression
neocomp_reg_table_all.long$bw_lower <- (neocomp_reg_table_all.long$neocomp_beta - 1.96*neocomp_reg_table_all.long$neocomp_se)
neocomp_reg_table_all.long$bw_upper <- (neocomp_reg_table_all.long$neocomp_beta + 1.96*neocomp_reg_table_all.long$neocomp_se)
neocomp_reg_table_all.long <- neocomp_reg_table_all.long %>% mutate(lm = "neocomp_uni")

#multivariate x~neocomp*bw regression, significant for neocomp_beta
icv_neocomp_reg_table_all.long$bw_lower <- (icv_neocomp_reg_table_all.long$neocomp_beta - 1.96*icv_neocomp_reg_table_all.long$neocomp_se)
icv_neocomp_reg_table_all.long$bw_upper <- (icv_neocomp_reg_table_all.long$neocomp_beta + 1.96*icv_neocomp_reg_table_all.long$neocomp_se)
icv_neocomp_reg_table_all.long_plot <- icv_neocomp_reg_table_all.long %>% mutate(lm = "neocomp_icv") %>% select(all_of(names(neocomp_reg_table_all.long)))
#combine tables
combined_neocomp_reg_table <- rbind(neocomp_reg_table_all.long, icv_neocomp_reg_table_all.long_plot)

#add a TRUE/FALSE column for neocomp_beta in the SAME direction, and for neocomp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(neocomp_reg_table_all.long, icv_neocomp_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$neocomp_beta_uni) == sign(wide_combined_reg_table$neocomp_beta_icv)) & wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$neocomp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_neocomp_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_neocomp_reg_table)),], aes(y = label, x = neocomp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
  geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
  ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("neocomp_uni" = "grey", "neocomp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "neocomp_beta_uni", "neocomp_p_adj_uni", "neocomp_beta_icv", "neocomp_p_adj_icv")]

(long.icv_neocomp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, long"))

(long.icv_neocomp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(neocomp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$neocomp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'neocomp_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_neocomp_survive_dkt_plot, "icv_neocomp_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_neocomp_survive_aseg_plot, "icv_neocomp_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_neocomp_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_neocomp_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_neocomp_reg_table_full.long_sig_MC[!(icv_neocomp_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_neocomp_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_neocomp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, long"))

(long.icv_neocomp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neocomp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "neocomp, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_neocomp_reg_table_full.long_sig_MC %>% filter(neocomp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_neocomp_reg_table_full.long_sig_MC$neocomp_beta)))

if(save_figures == TRUE){
panel_save(long.icv_neocomp_full_dkt_plot, "icv_neocomp_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_neocomp_full_aseg_plot, "icv_neocomp_full_long_aseg", "pdf", figure_panels_folder)
}
```
###general P-factor change
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p_change))
gp_zscore <- scale(long.full_test_df$General_p_change)
gp_baseline_zscore <- scale(long.full_test_df$General_p.long)
total_volume_zscore <- qnorm(long.full_test_df$smri_vol_scs_intracranialv.long_centiles)

#Global Phenotypes
icv_gpch_reg_table_global.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

icv_gpch_reg_table_global.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_gpch_reg_table_global.long)), name_mapping$abbreviation)]

icv_gpch_reg_table_global.long_sig <- icv_gpch_reg_table_global.long %>% filter(gp_p < 0.05)
icv_gpch_reg_table_global.long$gp_p_adj <- p.adjust(icv_gpch_reg_table_global.long$gp_p, method = "BH")
icv_gpch_reg_table_global.long$gp_base_p_adj <- p.adjust(icv_gpch_reg_table_global.long$gp_base_p, method = "BH")
icv_gpch_reg_table_global.long_sig_MC <- icv_gpch_reg_table_global.long %>% filter(gp_p_adj < 0.05)

icv_gpch_reg_table_global.long_sig_MC

#Regional Phenotypes
icv_gpch_reg_table_full.long <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore + total_volume_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

icv_gpch_reg_table_full.long$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(icv_gpch_reg_table_full.long)), name_mapping$abbreviation)]

icv_gpch_reg_table_full.long_sig <- icv_gpch_reg_table_full.long %>% filter(gp_p < 0.05)
icv_gpch_reg_table_full.long$gp_p_adj <- p.adjust(icv_gpch_reg_table_full.long$gp_p, method = "BH")
icv_gpch_reg_table_full.long$gp_base_p_adj <- p.adjust(icv_gpch_reg_table_full.long$gp_base_p, method = "BH")
icv_gpch_reg_table_full.long_sig_MC <- icv_gpch_reg_table_full.long %>% filter(gp_p_adj < 0.05)

#save tables of betas
if(save_tables == TRUE){
  output_folder <-dkt_folder
  save_table_full <- icv_gpch_reg_table_full.long
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                                          ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  filename_all <- paste0(output_folder, "dsk_gpchange_icv_all_long.csv")
  write.csv(save_table_full, filename_all)
}
if(save_tables == TRUE){
output_folder <-betas_folder
filename_global <- paste0(output_folder, "gpchange_icv_global_long.csv")
filename_regional <- paste0(output_folder, "gpchange_icv_regional_long.csv")
write.csv(icv_gpch_reg_table_global.long, filename_global)
write.csv(icv_gpch_reg_table_full.long, filename_regional)
}
```
####check which regions are still significantly in the same direction when icv is included as a covariate
```{r}
#Combine the global and regional tables into one
gpch_reg_table_all.long <- rbind(gpch_reg_table_global.long, gpch_reg_table_full.long)
icv_gpch_reg_table_all.long <- rbind(icv_gpch_reg_table_global.long, icv_gpch_reg_table_full.long)
#all phenotypes
#univariate x~gp regression
gpch_reg_table_all.long$bw_lower <- (gpch_reg_table_all.long$gp_beta - 1.96*gpch_reg_table_all.long$gp_se)
gpch_reg_table_all.long$bw_upper <- (gpch_reg_table_all.long$gp_beta + 1.96*gpch_reg_table_all.long$gp_se)
gpch_reg_table_all.long <- gpch_reg_table_all.long %>% mutate(lm = "gp_uni")

#multivariate x~gp*bw regression, significant for gp_beta
icv_gpch_reg_table_all.long$bw_lower <- (icv_gpch_reg_table_all.long$gp_beta - 1.96*icv_gpch_reg_table_all.long$gp_se)
icv_gpch_reg_table_all.long$bw_upper <- (icv_gpch_reg_table_all.long$gp_beta + 1.96*icv_gpch_reg_table_all.long$gp_se)
icv_gpch_reg_table_all.long_plot <- icv_gpch_reg_table_all.long %>% mutate(lm = "gp_icv") %>% select(all_of(names(gpch_reg_table_all.long)))
#combine tables
combined_reg_table <- rbind(gpch_reg_table_all.long, icv_gpch_reg_table_all.long_plot)

#add a TRUE/FALSE column for gp_beta in the SAME direction, and for gp_beta significant (adjusted) in both models
#wide format the combined table for the two models for easy comparison of betas and p_adj across both models
wide_combined_reg_table <- merge(gpch_reg_table_all.long, icv_gpch_reg_table_all.long, by = c("row.names", "label"), suffixes = c("_uni", "_icv"))
wide_combined_reg_table$survive_icv <- (sign(wide_combined_reg_table$gp_beta_uni) == sign(wide_combined_reg_table$gp_beta_icv)) & wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$gp_p_adj_icv < 0.05

# Plot Beta Ranges for Global Variables
ggplot(combined_reg_table[grep(paste(global_phenotypes, collapse = "|"), rownames(combined_reg_table)),], aes(y = label, x = gp_beta, xmin = bw_lower, xmax = bw_upper, color = lm)) +
 geom_linerange(size = 1.2) +  # controls thickness of the line
  geom_point(size = 4) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 15, margin = margin(r = 10)),  # space labels
        axis.title.y = element_text(margin = margin(r = 15))             # space title
        ) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  scale_color_manual(values = c("gp_uni" = "grey", "gp_icv" = "magenta")) +
  labs(x = "Beta Estimate", y = "Phenotype", color = "Regression Type") + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "black")

```
####visualize on brain maps those that survive correction for icv
```{r}
#merge with atlas data
plot_data_dkt <- merge(wide_combined_reg_table, ggseg::dk, by = "label")
plot_data_aseg <- merge(wide_combined_reg_table, ggseg::aseg, by = "label")

#Regions not matched in atlases
wide_combined_reg_table[!(wide_combined_reg_table$label %in% plot_data_dkt$label) & !(wide_combined_reg_table$label %in% plot_data_aseg$label),c("label", "gp_beta_uni", "gp_p_adj_uni", "gp_beta_icv", "gp_p_adj_icv")]

(long.icv_gp_survive_dkt_plot <- ggplot(plot_data_dkt %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp change, survive after controlling for icv, long"))

(long.icv_gp_survive_aseg_plot <- ggplot(plot_data_aseg%>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE)) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta_icv)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp change, survive after controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(wide_combined_reg_table %>% filter(gp_p_adj_uni < 0.05 & survive_icv == TRUE & sub(".long_centiles","", Row.names) %in% phenotypes_for_MC))[1]))
print(paste0("Beta range of significant IDPs: ", range(wide_combined_reg_table[wide_combined_reg_table$gp_p_adj_uni < 0.05 & wide_combined_reg_table$survive_icv == TRUE & sub(".long_centiles","", wide_combined_reg_table$Row.names) %in% phenotypes_for_MC, 'gp_beta_icv'])))

if(save_figures == TRUE){
panel_save(long.icv_gp_survive_dkt_plot, "icv_gpchange_survive_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_gp_survive_aseg_plot, "icv_gpchange_survive_long_aseg", "pdf", figure_panels_folder)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(icv_gp_reg_table_full.long_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(icv_gp_reg_table_full.long_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
icv_gp_reg_table_full.long_sig_MC[!(icv_gp_reg_table_full.long_sig_MC$label %in% plot_data_dkt$label) & !(icv_gp_reg_table_full.long_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.icv_gp_full_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp change, full controlling for icv, long"))

(long.icv_gp_full_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F", limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "gp change, full controlling for icv, long"))

print(paste0("Number of significant IDPs after FDR correction: ", dim(icv_gp_reg_table_full.long_sig_MC %>% filter(gp_p_adj < 0.05))[1]))
print(paste0("Beta range of significant IDPs: ", range(icv_gp_reg_table_full.long_sig_MC$gp_beta)))

if(save_figures == TRUE){
panel_save(long.icv_gp_full_dkt_plot, "icv_gpchange_full_long_dkt", "pdf", figure_panels_folder)
panel_save(long.icv_gp_full_aseg_plot, "icv_gpchange_full_long_aseg", "pdf", figure_panels_folder)
}
```
#Save scale images
### -0.23 to 0.23
```{r}
# Create dummy data just to generate the colorbar
df <- data.frame(x = 1, y = 1, beta = 0)

scale <- ggplot(df, aes(x, y, fill = beta)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "#4878CF",
    mid = "white",
    high = "#D65F5F",
    midpoint = 0,
    limits = c(-0.23, 0.23),
    guide = guide_colorbar(
      barwidth = 1,   # length of colorbar
      barheight = 20    # thickness
    )
  ) +
  theme_void() +  # remove axes, grid, etc.
  theme(
    legend.position = "right",
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 16)
  )
scale
```
### -1 to 1
```{r}
# Create dummy data just to generate the colorbar
df <- data.frame(x = 1, y = 1, corr = 0)

scale_2 <- ggplot(df, aes(x, y, fill = corr)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "#4878CF",
    mid = "white",
    high = "#D65F5F",
    midpoint = 0,
    limits = c(-1, 1),
    guide = guide_colorbar(
      barwidth = 20,   # length of colorbar
      barheight = 1    # thickness
    )
  ) +
  theme_void() +  # remove axes, grid, etc.
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )
scale_2
```
#Save legend for Fig 1
```{r}
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
df <- data.frame(colors = colors, label = c("A", "B", "C", "D"))

# Create an empty plotting area
plot.new()
par(mar = c(0, 0, 0, 0))  # remove margins

# Add only the legend
legend(
  "center",
  legend = df$label,
  fill = df$color,
  border = "black",
  cex = 5,
  title = "",
  box.lwd = 0  
)
```
#Compile all lm() stats into supplementary table
all global volumes
regional volumes if they aren't plotted on gg
```{r}
full_folder <- betas_folder
ncol = length(list.files(full_folder))
supp_betas_global <- data.frame(matrix(NA, nrow = length(global_phenotypes), ncol = 1))
names(supp_betas_global) <- "label"
rownames(supp_betas_global) <- global_phenotypes
supp_betas_global$label <- name_mapping$region_name[match(rownames(supp_betas_global), name_mapping$abbreviation)]
supp_betas_regional <- data.frame(matrix(NA, nrow = length(phenotypes_for_MC), ncol = 1))
rownames(supp_betas_regional) <- phenotypes_for_MC
names(supp_betas_regional) <- "label"
supp_betas_regional$label <- name_mapping$region_name[match(rownames(supp_betas_regional), name_mapping$abbreviation)]

for (i in 1:length(list.files(full_folder))) {
  name <- list.files(full_folder)[i]
  print(name)
  
  table <- read.csv(paste0(full_folder, name)) %>% 
    rename(var_name = X)
  
  p_columns <- names(table)[grep("p_adj", names(table))]
  
  for (k in 1:length(p_columns)) {
    table_sig <- table %>% filter(.data[[p_columns[k]]] < 0.05)
    
    if (dim(table_sig)[1] > 0) {
      p_col_name <- paste(sub(".csv", "", name), p_columns[k], sep = "_")
      beta_col_name <- paste(sub(".csv", "", name), sub("p_adj", "beta", p_columns[k]), sep = "_")
      var_p <- p_columns[k]
      var_beta <- sub("p_adj", "beta", p_columns[k])
      
      if (grepl("regional", name)) {
        
        supp_betas_regional <- merge(
          table_sig %>% select(all_of(c(var_p, "label"))) %>% rename(!!p_col_name := var_p), 
          supp_betas_regional, 
          by = "label", 
          all.y = TRUE
        )
        
        supp_betas_regional <- merge(
          table_sig %>% select(all_of(c(var_beta, "label"))) %>% rename(!!beta_col_name := var_beta), 
          supp_betas_regional, 
          by = "label",
          all.y = TRUE
        )
        
      } else if (grepl("global", name)) {
        supp_betas_global <- merge(
          table_sig %>% select(all_of(c(var_p, "label"))) %>% rename(!!p_col_name := var_p), 
          supp_betas_global, 
          by = "label",
          all.y = TRUE
        )
        
        supp_betas_global <- merge(
          table_sig %>% select(all_of(c(var_beta, "label"))) %>% rename(!!beta_col_name := var_beta), 
          supp_betas_global, 
          by = "label",
          all.y = TRUE
        )
      }
    }
  }
}
#combine tables and add column for global/region
##remove "global" and "regional" from column names
names(supp_betas_global) <- sub("global", "", names(supp_betas_global))
names(supp_betas_regional) <- sub("regional", "", names(supp_betas_regional))
##add column for global/regional label
supp_betas_global$region <- rep("global", dim(supp_betas_global)[1])
supp_betas_regional$region <- rep("region", dim(supp_betas_regional)[1])
##add label for regions not plotted in figures
supp_betas_regional$noplot <- ifelse(supp_betas_regional$label %in% regions_notplotted$region_name, "*", NA)
supp_betas_all <- bind_rows(supp_betas_regional, supp_betas_global)
#reorder the columns
supp_betas_all <- supp_betas_all %>%
  select(
    any_of(c("label", "region", "noplot")),
    matches("t1"),
    matches("t2"),
    matches("long"),
    everything()
  )
#save as csv
filename <- paste0("supplementary_sigbetas_all", Sys.Date(), ".csv")
write.csv(supp_betas_all, paste0(save_path, filename))
```
#Neonatal complications supp table
```{r}
neonatal_vars <- c("devhx_14a3_p", "devhx_14b3_p", "devhx_14c3_p", "devhx_14d3_p", "devhx_14e3_p", "devhx_14f3_p", "devhx_14g3_p", "devhx_14h3_p")
abcd_neonatal <- read_csv("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/update/abcd_long_afterQC_neonatal_baseline.csv")
#table for NAs and "don't know"s for each question (before splits)
lapply(abcd_neonatal[, neonatal_vars], table, useNA = "ifany")
#merge with t1 for post-split data Ns
t1.full_test_df <- merge(t1.full_test_df, abcd_neonatal %>% select(all_of(c("src_subject_id","devhx_14a3_p", "devhx_14b3_p", "devhx_14c3_p", "devhx_14d3_p", "devhx_14e3_p", "devhx_14f3_p", "devhx_14g3_p", "devhx_14h3_p"))), by = "src_subject_id", all.x = TRUE)
#table for NAs and "don't know"s for each question (after splits -- removing more subjects)
lapply(t1.full_test_df[, neonatal_vars], table, useNA = "ifany")
ggplot(t1.full_test_df, aes(x = neonatal_comp_total)) + 
  geom_bar() +
  theme_minimal()
```
